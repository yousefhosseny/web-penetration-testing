فهم **Session Management** هو جزء أساسي في اختبار الإختراق (Pentesting)، خاصة لما تدور على ثغرات مثل **Session Hijacking، Session Fixation، أو CSRF**.

### 📌 فهم ببساطة: إيه هي Session Management؟

الـ **Session Management** هي الطريقة اللي بيُحافظ بيها الموقع على حالة المستخدم بعد تسجيل الدخول.  
لأن الـ HTTP بروتوكول ** Stateless **(ميشتغلش بالحالة)، فالموقع لازم يقدر يعرفك من غير ما تسجل دخول كل مرة.

---

## 🔁 كيف بيشتغل عمليًا؟

### 1️⃣ **عندما تسجل دخول:**

- ترسل اسم المستخدم والباسورد.
- الخادم يحقق الهوية (Authentication).
- إذا كانت صحيحة، يولد **Session ID** (توكن) عشوائي وفريد.
- يُخزن هذا التوكن على الخادم مع بياناتك (مثل: user_id, role).
- يُرسل التوكن إلى المتصفح عادةً كـ **Cookie** مثل:
```http
Set-Cookie: sessionid=abc123xyz; Path=/; Secure; HttpOnly
```

---

### 2️⃣ **في كل طلب لاحق:**
- المتصفح يرسل نفس التوكن في رؤوس الطلب (Headers):
```http
GET /dashboard HTTP/1.1
Host: example.com
Cookie: sessionid=abc123xyz
```
- الخادم يقارن التوكن باللي عنده، وإذا كان مطابق → يسمح لك بالوصول.

---

### 3️⃣ **عند تسجيل الخروج أو انتهاء الصلاحية:**
- الخادم يمسح التوكن من قاعدة البيانات الخاصة به.
- المتصفح قد يمسح الكوكيز من جهته.

---

## 🧠 شويفات الأنظمة الشائعة:

| نوع النظام            | كيف يُدار التوكن                                      |
| --------------------- | ----------------------------------------------------- |
| PHP                   | `PHPSESSID` في كوكيز                                  |
| ASP.NET               | `ASP.NET_SessionId`                                   |
| Java (JSP)            | `JSESSIONID`                                          |
| JWT-based             | توكن مشفر في Header (`Authorization: Bearer <token>`) |
| Tokenless (Stateless) | يتم استخدام توكن مشفر (JWT) لا يُخزن على الخادم       |

---

## 🔒 خصائص الأمان الأساسية للتوكنات الآمنة:

| الخاصية    | الوظيفة |
|------------|---------|
| **Secure** | يضمن أن الكوكيز يُرسل فقط عبر HTTPS |
| **HttpOnly** | يمنع الوصول إليه من JavaScript (مافيتش سرقة من XSS مباشرة) |
| **SameSite** | يحدّ من الطلبات من مواقع أخرى (يحمي من CSRF بشكل جزئي) |
| **Domain & Path** | يحدد أين يتم إرسال الكوكيز (للتحكم في النطاق) |
| **Expires/Max-Age** | متى ينتهي التوكن |

---

## 🛠️ أدوات pentesting المشهورة لاختبار Session Management:

| الأداة | الاستخدام |
|-------|----------|
| **Burp Suite** | التقاط الطلبات، تعديل الكوكيز، تحليل التوكنات |
| **ZAP Proxy** | فحص تلقائي للتوكنات والكوكيز |
| **tokenalyzer.py** | تحليل مدى عشوائية التوكن |
| **Wireshark** | Sniffing التوكنات عبر HTTP |
| **BetterCAP / SSLStrip** | MITM لسرقة الجلسات غير الآمنة |
| **XSS payloads** | سرقة الكوكيز من خلال JavaScript |

---
