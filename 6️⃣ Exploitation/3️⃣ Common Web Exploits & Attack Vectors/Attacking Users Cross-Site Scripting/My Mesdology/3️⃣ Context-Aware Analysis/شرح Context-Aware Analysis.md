
---

### **3️⃣ Context-Aware Analysis**
في هذه الخطوة، نقوم بتحليل السياق الذي يظهر فيه الـ payload لتحديد نوع الثغرة (Reflected، Stored، أو DOM-based XSS) وكيفية استغلالها. كل سياق يتطلب نوعًا معينًا من الـ payload ليكون فعالًا. السياقات الأربعة المذكورة هي: **HTML Context**، **Attribute Context**، **JS Context**، و**DOM Sink Example**. سأشرح كل واحد بالتفصيل.

---

#### **1. HTML Context (سياق HTML)**
- **ما المقصود؟**  
  الـ payload يظهر كجزء من محتوى النص داخل عنصر HTML، مثل داخل `<div>`، `<p>`، أو أي عنصر آخر غير سمة أو كود JavaScript. هذا السياق شائع في ثغرات **Reflected** أو **Stored XSS** حيث يتم عرض البيانات مباشرة في صفحة الـ HTML.

- **مثال:**  
  إذا أدخلت `XSS123456` في حقل إدخال (مثل حقل تعليق) وظهر في الصفحة كـ:  
  ```html
  <div>XSS123456</div>
  ```
  فهذا يعني أن الـ payload في سياق HTML.

- **كيفية التحليل؟**  
  1. افتح DevTools (F12) في المتصفح وانتقل إلى علامة التبويب **Elements**.
  2. ابحث عن الـ payload (مثل `XSS123456`) باستخدام Ctrl+F داخل شيفرة HTML.
  3. تحقق إذا كان الـ payload موجودًا كنص خام داخل عنصر HTML (مثل `<div>` أو `<p>`).
  4. تحقق مما إذا كان الـ payload مشفرًا (مثل `&lt;script&gt;`) أو غير مشفر، مما يشير إلى وجود أو عدم وجود فلاتر أمان.

---

#### **2. Attribute Context (سياق السمات)**
- **ما المقصود؟**  
  الـ payload يظهر داخل قيمة سمة (attribute) في عنصر HTML، مثل `value`، `href`، `src`، أو سمات الأحداث مثل `onclick`. هذا السياق شائع في ثغرات **Reflected** أو **Stored XSS** عندما يتم إدخال البيانات في سمة عنصر.

- **مثال:**  
  إذا أدخلت `XSS123456` في حقل إدخال وظهر كـ:  
  ```html
  <input type="text" value="XSS123456">
  ```
  أو  
  ```html
  <a href="XSS123456">Link</a>
  ```
  فهذا يعني أن الـ payload في سياق سمة.

- **كيفية التحليل؟**  
  1. افتح DevTools وعلامة التبويب **Elements**.
  2. ابحث عن الـ payload داخل قيم السمات (مثل `value`، `href`، `src`).
  3. تحقق مما إذا كان الـ payload مشفرًا (مثل تحويل `"` إلى `&quot;`) أو غير مشفر.
  4. تحقق من نوع السمة:
     - إذا كانت سمة حدث (مثل `onclick`)، فقد تكون أكثر خطورة.
     - إذا كانت سمة مثل `href` أو `src`، تحقق إذا كان يمكن إدخال بروتوكول `javascript:`.

---

#### **3. JS Context (سياق JavaScript)**
- **ما المقصود؟**  
  الـ payload يظهر داخل كود JavaScript، سواء في كتلة `<script>` أو داخل سمة حدث مثل `onclick`، أو ضمن كائن JSON يتم معالجته بواسطة JavaScript. هذا السياق شائع في ثغرات **DOM-based XSS** أو عندما يتم إدخال البيانات مباشرة في كود JavaScript.

- **مثال:**  
  - داخل كتلة `<script>`:  
    ```html
    <script>
      var userInput = "XSS123456";
    </script>
    ```
  - داخل سمة حدث:  
    ```html
    <div onclick="handleClick('XSS123456')">Click me</div>
    ```
  - داخل JSON:  
    ```json
    {"username": "XSS123456"}
    ```

- **كيفية التحليل؟**  
  1. افتح DevTools وعلامة التبويب **Elements** للتحقق من الـ payload داخل `<script>` أو سمات الأحداث.
  2. في علامة التبويب **Network**، تحقق من استجابات JSON التي تحتوي على الـ payload.
  3. في علامة التبويب **Sources**، تتبع كيفية معالجة الـ payload في JavaScript (مثل استخدامه في `eval()` أو `innerHTML`).
  4. تحقق مما إذا كان الـ payload مشفرًا أو يتم إدخاله كنص خام.

---

#### **4. DOM Sink Example (مثال على DOM Sink)**
- **ما المقصود؟**  
  DOM Sink هو دالة أو خاصية في JavaScript تتيح تعديل DOM بشكل ديناميكي، مما قد يؤدي إلى ثغرة **DOM-based XSS** إذا تم إدخال بيانات غير آمنة فيها. الأمثلة الشائعة على DOM Sinks تشمل:  
  - `document.write()`  
  - `element.innerHTML`  
  - `element.outerHTML`  
  - `eval()`  
  - `setTimeout()` أو `setInterval()` (إذا تم تمرير سلسلة نصية)  
  - `location.href` أو `window.location`  

- **مثال:**  
  إذا أدخلت `XSS123456` في معلمة URL (مثل `?name=XSS123456`) وتم استخدامه في JavaScript كـ:  
  ```javascript
  document.write('Hello, ' + decodeURIComponent(getQueryParam('name')));
  ```
  سيظهر الـ payload مباشرة في DOM. إذا أدخلت:  
  ```html
  <script>alert('XSS')</script>
  ```
  سيتم تنفيذ السكربت.

- **كيفية التحليل؟**  
  1. افتح DevTools وعلامة التبويب **Sources** لتتبع الكود JavaScript الذي يتعامل مع الـ payload.
  2. ابحث عن DOM Sinks مثل `innerHTML` أو `document.write` في الكود.
  3. تحقق من مصدر البيانات (مثل معلمات URL، حقول إدخال، أو JSON).
  4. أدخل payload بسيط مثل `XSS123456` وتحقق مما إذا كان يظهر في DOM دون طلب خادم (مؤشر على DOM-based XSS).
  5. جرب payload مثل:  
     ```html
     <img src=x onerror=alert('XSS')>
     ```
     أو  
     ```javascript
     javascript:alert('XSS')
     ```

- **الـ Payload المناسب:**  
  يعتمد على نوع الـ DOM Sink:  
  - لـ `innerHTML` أو `document.write`:  
    ```html
    <script>alert('XSS')</script>
    ```  
  - لـ `eval` أو `setTimeout`:  
    ```javascript
    alert('XSS')
    ```  
  - لـ `location.href`:  
    ```javascript
    javascript:alert('XSS')
    ```

- **اختبار الفلاتر:**  
  - تحقق مما إذا كان التطبيق يقوم بتصفية أو تشفير البيانات قبل تمريرها إلى DOM Sink.
  - جرب payloads مشفرة مثل:  
    ```html
    %3Cscript%3Ealert('XSS')%3C/script%3E
    ```

- **نصيحة:**  
  - DOM-based XSS يحدث بالكامل على جانب العميل (client-side)، لذا راقب التغييرات في DOM دون طلبات خادم.
  - استخدم DevTools (علامة التبويب **Console**) لتتبع الأخطاء أو التنبيهات الناتجة عن الـ payload.

---

### **ملخص الخطوات**
1. **HTML Context:**  
   - الـ payload يظهر كنص خام داخل عنصر HTML.  
   - استخدم payloads مثل `<script>alert('XSS')</script>` أو `<img src=x onerror=alert('XSS')>`.  
   - تحقق باستخدام DevTools (Elements).  

2. **Attribute Context:**  
   - الـ payload يظهر داخل سمة مثل `value` أو `href`.  
   - استخدم payloads مثل `" onfocus="alert('XSS')"` أو `javascript:alert('XSS')`.  
   - تحقق من الفلاتر التي تزيل علامات الاقتباس.  

3. **JS Context:**  
   - الـ payload يظهر داخل `<script>`، سمة حدث، أو JSON.  
   - استخدم payloads مثل `";alert('XSS');//` لكسر بنية JavaScript.  
   - تتبع الكود في DevTools (Sources) أو Burp Suite.  

4. **DOM Sink Example:**  
   - الـ payload يتم تمريره إلى دوال مثل `innerHTML` أو `document.write`.  
   - استخدم payloads مثل `<script>alert('XSS')</script>` أو `javascript:alert('XSS')`.  
   - تحقق من التغييرات في DOM باستخدام DevTools (Sources/Console).  

---

###  5. Script Context (داخل سكريبت)**

- **ما المقصود؟**  
    الـ payload يتم حقنه مباشرة داخل سكريبت `<script>` في الصفحة بدون ما يكون جوه سلسلة نصية. وده من أخطر السياقات لأنه ممكن تكتب JavaScript مباشرة.
    
- **مثال:**
    
    ```html
    <script>
      XSS123456
    </script>
    ```
    
- **كيفية التحليل؟**
    
    1. شوف إذا الـ payload مش محاط بعلامات اقتباس.
        
    2. ساعتها تقدر تكتب أوامر JS مباشرة.
        
- **Payload مثال:**
    
    ```javascript
    alert(1)//
    ```
    

---

###  6. JSON Context (سياق JSON)**

- **ما المقصود؟**  
    الـ payload بيتحقن داخل بيانات JSON بتتعرض في سكريبت مثل:
    
    ```html
    <script>
      var data = [{"name":"XSS123456"}];
    </script>
    ```
    
- **كيفية التحليل؟**
    
    1. شوف هل الـ payload جوه JSON؟ داخل `{}` أو `[]`؟ وجوه خصائص مثل `"key":"value"`؟
        
    2. لو كده، تقدر تكسر التركيب عن طريق إنهاء القوس `}` أو `]`، بعدها تكتب كود، وبعدين ترجع التركيب عشان تمنع errors.
        
- **Payload مثال:**
    
    ```javascript
    "}];alert(1);var x={"
    ```
    

---

### **نصائح عامة**
- **استخدام الأدوات:**  
  - **DevTools:** لفحص HTML، السمات، وJavaScript.  
  - **Burp Suite (Logger++):** لتسجيل الطلبات والاستجابات والبحث عن الـ payload.  
- **توثيق النتائج:** سجل السياق، الـ payload المستخدم، ونتيجة الاستجابة (مثل تنبيه أو عدم تنفيذ).  
- **اختبار الفلاتر:** جرب payloads مشفرة أو بدون علامات اقتباس لتجاوز أي فلاتر أمان.  
- **الأمان أولاً:** قم بإجراء الاختبارات في بيئة اختبارية لتجنب التأثير على المستخدمين الحقيقيين.

---


# تحليل سياق XSS (Context-Aware Analysis)

## 1. HTML Context (سياق HTML)
- **الوصف:** الـ payload يظهر كنص خام داخل عنصر HTML مثل `<div>` أو `<p>`.
- **مثال:** `<div>XSS123456</div>`
- **الـ Payload المناسب:** 
  - `<script>alert('XSS')</script>`
  - `<img src=x onerror=alert('XSS')>`
- **كيفية التحقق:** استخدم DevTools (علامة Elements) للبحث عن الـ payload.
- **اختبار الفلاتر:** جرب payloads مشفرة مثل `%3Cscript%3Ealert('XSS')%3C/script%3E`.

## 2. Attribute Context (سياق السمات)
- **الوصف:** الـ payload يظهر داخل سمة مثل `value` أو `href`.
- **مثال:** `<input type="text" value="XSS123456">`
- **الـ Payload المناسب:** 
  - `" onfocus="alert('XSS')"`
  - `javascript:alert('XSS')` (لـ `href` أو `src`)
- **كيفية التحقق:** تحقق من السمات في DevTools (Elements).
- **اختبار الفلاتر:** جرب payloads بدون علامات اقتباس مثل `onfocus=alert('XSS')`.

## 3. JS Context (سياق JavaScript)
- **الوصف:** الـ payload يظهر داخل `<script>`، سمة حدث، أو JSON.
- **مثال:** 
  - `<script>var userInput = "XSS123456";</script>`
  - `<div onclick="handleClick('XSS123456')">`
- **الـ Payload المناسب:** 
  - `";alert('XSS');//`
  - `', "x": alert('XSS')` (لـ JSON)
- **كيفية التحقق:** استخدم DevTools (Sources) أو Burp Suite.
- **اختبار الفلاتر:** جرب payloads بدون فواصل منقوطة مثل `alert('XSS')%0d%0a`.

## 4. DOM Sink Example (مثال على DOM Sink)
- **الوصف:** الـ payload يتم تمريره إلى دوال مثل `innerHTML` أو `document.write`.
- **مثال:** `document.write('Hello, ' + decodeURIComponent(getQueryParam('name')));`
- **الـ Payload المناسب:** 
  - `<script>alert('XSS')</script>`
  - `javascript:alert('XSS')`
- **كيفية التحقق:** تتبع الكود في DevTools (Sources/Console).
- **اختبار الفلاتر:** جرب payloads مشفرة أو معقدة.

## نصائح
- استخدم DevTools وBurp Suite لتتبع الـ payload.
- وثّق النتائج (السياق، الـ payload، الاستجابة).
- جرب payloads مشفرة لتجاوز الفلاتر.
- قم بالاختبار في بيئة آمنة.


---

