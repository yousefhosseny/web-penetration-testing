# 1.  تحليل ثغرة XSS في Shopify Wholesale

## الوصف

ثغرة **XSS (Cross-Site Scripting)** تم اكتشافها في موقع Shopify Wholesale في ديسمبر 2015، وتم الإبلاغ عنها عبر منصة HackerOne. كانت الثغرة موجودة في حقل بحث (search box) في صفحة الموقع، حيث كانت المدخلات تُعرض دون تعقيم (unsanitized) داخل علامات `<script>` في كود JavaScript. هذا سمح للمخترق بإدخال كود JavaScript يتم تنفيذه مباشرة في متصفح المستخدم. على الرغم من بساطة الثغرة، إلا أنها كانت خطيرة لأنها يمكن أن تُستخدم لسرقة بيانات المستخدمين أو تعديل محتوى الصفحة. الثغرة تم تصحيحها، وتم منح مكافأة قدرها 500 دولار للمبلغ عنها.

## الاستغلال

1. **خطوات الاستغلال**:
    
    - المخترق قام بفحص مصدر الصفحة (page source) باستخدام `view-source:URL` لتحديد مكان عرض مدخلات حقل البحث.
    - لاحظ أن المدخلات تُعرض داخل علامات `<script>` دون تعقيم، مما يعني أنها تُفسر كجزء من كود JavaScript.
    - أدخل الكود التالي في حقل البحث:
        
        ```
        test';alert('XSS');'
        ```
        
    - **تفسير الكود**:
        - `test';` أغلق جملة JavaScript السابقة.
        - `alert('XSS');` نفّذ نافذة تنبيه تحتوي على نص "XSS".
        - `'` أكمل بنية JavaScript لتجنب أخطاء التركيب.
    - النتيجة: ظهرت نافذة تنبيه في المتصفح، مما يثبت وجود الثغرة.
2. **تأثير الاستغلال**:
    
    - على الرغم من أن الحمولة المستخدمة (`alert('XSS')`) كانت غير ضارة، إلا أن الثغرة يمكن أن تُستخدم لأغراض أكثر خطورة، مثل:
        - سرقة ملفات تعريف الارتباط باستخدام `document.cookie`.
        - إعادة توجيه المستخدم إلى مواقع ضارة باستخدام `window.location`.
        - تعديل محتوى الصفحة لخداع المستخدمين.
3. **لماذا نجح الاستغلال؟**:
    
    - Shopify كانت ترمّز أحرف HTML مثل `<` و`>`، مما منع استغلال الثغرة في سياق HTML.
    - لكن عدم تعقيم المدخلات في سياق JavaScript سمح بتنفيذ الكود مباشرة.

## الحلول

1. **تعقيم المدخلات (Input Sanitization)**:
    
    - استخدام مكتبات مثل **DOMPurify** لتعقيم المدخلات قبل عرضها.
    - تحويل الأحرف الخاصة (مثل `'`, `"`, `;`) إلى كيانات آمنة عند عرضها في JavaScript.
2. **ترميز السياق (Contextual Encoding)**:
    
    - إذا كانت المدخلات ستُعرض في JavaScript، يجب ترميز الأحرف مثل `'` و`"` باستخدام `\` (مثل `\'`, `\"`).
    - مثال: إذا كان الكود هو `var search_term = '<INPUT>';`، يجب أن يتم ترميز `<INPUT>` لمنع إغلاق الجملة.
3. **تطبيق Content Security Policy (CSP)**:
    
    - استخدام سياسة أمان المحتوى لمنع تنفيذ JavaScript غير موثوق.
    - مثال: `Content-Security-Policy: script-src 'self';` يسمح فقط بتنفيذ JavaScript من نفس الموقع.
4. **استخدام أطر عمل آمنة**:
    
    - استخدام أطر عمل مثل **React** أو **Vue.js** التي ترمّز المدخلات تلقائيًا لمنع ثغرات XSS.
    - تجنب إدخال مدخلات المستخدم مباشرة في كود JavaScript باستخدام `innerHTML` أو `eval()`.
5. **اختبار دوري للأمان**:
    
    - إجراء اختبارات أمان دورية باستخدام أدوات مثل **Burp Suite** أو **OWASP ZAP** لاكتشاف ثغرات XSS.
    - تشجيع المشاركة في برامج Bug Bounty لتحديد الثغرات المحتملة.

## الأدوات

1. **فحص مصدر الصفحة**:
    
    - **المتصفح**: استخدام خاصية `view-source:URL` أو أداة "Inspect Element" لتحليل كود الصفحة.
    - **DevTools**: أدوات المطورين في المتصفحات (مثل Chrome DevTools) لتتبع عرض المدخلات.
2. **أدوات اختبار الأمان**:
    
    - **Burp Suite**: لتحليل طلبات HTTP/HTTPS واكتشاف أماكن عرض المدخلات.
    - **OWASP ZAP**: أداة مفتوحة المصدر لاختبار ثغرات XSS وغيرها من الثغرات الأمنية.
    - **XSStrike**: أداة متخصصة في اكتشاف ثغرات XSS واختبار الحمولات.
3. **أدوات تعقيم المدخلات**:
    
    - **DOMPurify**: مكتبة JavaScript لتعقيم المدخلات ومنع ثغرات XSS.
    - **ESAPI (OWASP Enterprise Security API)**: مكتبة لترميز وتعقيم المدخلات في سياقات مختلفة.
4. **أدوات مراقبة CSP**:
    
    - **CSP Evaluator**: أداة من Google لتقييم سياسات أمان المحتوى وتحسينها.
    - **Report URI**: خدمة لمراقبة تقارير CSP وتحديد المحاولات غير المصرح بها.



----
# تحليل ثغرة XSS في إعدادات تنسيق العملة في Shopify

## الوصف

ثغرة **XSS (Cross-Site Scripting)** تم اكتشافها في إعدادات تنسيق العملة في لوحة إدارة Shopify (`<YOURSITE>.myshopify.com/admin/settings/general/`) في ديسمبر 2015، وتم الإبلاغ عنها عبر منصة HackerOne. الثغرة سمحت للمستخدم الخبيث بإدخال حمولة XSS في حقل إعدادات تنسيق العملة، والتي لم تُعقم بشكل صحيح عند عرضها في قناة المبيعات على وسائل التواصل الاجتماعي. الحمولة لم تُنفذ فور إدخالها في صفحة الإعدادات، ولكنها كانت تُفعّل عندما يزور مدير متجر آخر علامة تبويب قناة المبيعات الضعيفة. تم منح مكافأة قدرها 1000 دولار للمبلغ عن الثغرة.

## الاستغلال

1. **خطوات الاستغلال**:
    
    - المخترق قام بإدخال حمولة XSS في حقل تنسيق العملة في صفحة الإعدادات. الحمولة كانت:
        
        ```
        ${{amount}}"><img src=x onerror=alert(document.domain)>
        ```
        
    - **تفسير الحمولة**:
        - `${{amount}}` هو قيمة شرعية تُستخدم في محرك القوالب Liquid الخاص بـ Shopify لعرض قيمة العملة.
        - `">` أغلق علامة HTML التي كانت الحمولة تُحقن فيها.
        - `<img src=x onerror=alert(document.domain)>` أضاف علامة صورة تحتوي على خاصية `onerror` التي تُنفذ JavaScript عند فشل تحميل الصورة.
        - `alert(document.domain)` عرض نافذة تنبيه تحتوي على اسم النطاق الحالي.
    - الحمولة لم تُنفذ في صفحة إعدادات العملة، ولكنها عُرضت دون تعقيم في قناة المبيعات على وسائل التواصل الاجتماعي.
    - عندما زار مدير متجر آخر علامة تبويب قناة المبيعات، تم تنفيذ الحمولة وعرضت نافذة التنبيه.
2. **تأثير الاستغلال**:
    
    - الحمولة المستخدمة (`alert(document.domain)`) كانت للتوضيح فقط، ولكن يمكن استبدالها بأكواد ضارة مثل:
        - سرقة ملفات تعريف الارتباط باستخدام `document.cookie`.
        - إعادة توجيه المستخدم إلى موقع ضار باستخدام `window.location`.
        - تعديل محتوى الصفحة لخداع المستخدمين أو سرقة بياناتهم.
    - الثغرة كانت خطيرة لأنها أثرت على مديري المتاجر الآخرين، مما يعني إمكانية استهداف مستخدمين ذوي صلاحيات عالية.
3. **لماذا نجح الاستغلال؟**:
    
    - Shopify لم تُعقم المدخلات في حقل تنسيق العملة عند عرضها في قناة المبيعات.
    - محرك القوالب Liquid سمح بعرض الحمولة كجزء من HTML دون ترميز الأحرف الخاصة (مثل `<`, `>`).

## الحلول

1. **تعقيم المدخلات (Input Sanitization)**:
    
    - استخدام مكتبات مثل **DOMPurify** لتعقيم المدخلات قبل عرضها في أي سياق (HTML، JavaScript، إلخ).
    - التأكد من إزالة أو ترميز الأحرف الخاصة مثل `<`, `>`, `"`, `'` عند عرض المدخلات.
2. **ترميز السياق (Contextual Encoding)**:
    
    - ترميز المدخلات بناءً على السياق الذي ستُعرض فيه (مثل HTML، JavaScript، أو سمات HTML).
    - مثال: تحويل `<` إلى `&lt;` و`"` إلى `&quot;` عند العرض في HTML.
3. **تطبيق Content Security Policy (CSP)**:
    
    - تطبيق سياسة أمان المحتوى لمنع تنفيذ JavaScript غير موثوق.
    - مثال: `Content-Security-Policy: script-src 'self';` يقيد تنفيذ JavaScript على المصادر من نفس النطاق.
4. **التحقق من جميع أماكن العرض**:
    
    - التحقق من أن المدخلات تُعقم في جميع الصفحات أو القنوات التي قد تُعرض فيها (مثل قنوات المبيعات أو صفحات المتجر).
    - إجراء اختبارات شاملة لتحديد جميع النقاط التي تُستخدم فيها المدخلات.
5. **استخدام أطر عمل آمنة**:
    
    - الاعتماد على أطر عمل مثل **React** أو **Vue.js** التي ترمّز المدخلات تلقائيًا.
    - تجنب استخدام طرق غير آمنة مثل `innerHTML` أو دمج المدخلات مباشرة في قوالب Liquid دون تعقيم.
6. **اختبارات الأمان الدورية**:
    
    - إجراء اختبارات أمان باستخدام أدوات مثل **Burp Suite** أو **OWASP ZAP** لاكتشاف ثغرات XSS.
    - تشجيع برامج Bug Bounty لتحديد الثغرات من قبل الباحثين الخارجيين.

## الأدوات

1. **فحص مصدر الصفحة**:
    
    - **Chrome DevTools**: لفحص كود HTML وتحديد أماكن عرض المدخلات.
    - **view-source:URL**: لعرض مصدر الصفحة وتحليل بنية القوالب.
2. **أدوات اختبار الأمان**:
    
    - **Burp Suite**: لتحليل طلبات HTTP/HTTPS واكتشاف ثغرات XSS في المدخلات.
    - **OWASP ZAP**: أداة مفتوحة المصدر لاختبار ثغرات XSS وغيرها من الثغرات.
    - **XSStrike**: أداة متخصصة في اختبار حمولات XSS واكتشاف نقاط الضعف.
3. **أدوات تعقيم المدخلات**:
    
    - **DOMPurify**: مكتبة JavaScript لتعقيم المدخلات ومنع ثغرات XSS.
    - **ESAPI (OWASP Enterprise Security API)**: مكتبة لترميز وتعقيم المدخلات في سياقات مختلفة.
4. **أدوات مراقبة CSP**:
    
    - **CSP Evaluator**: أداة لتقييم سياسات أمان المحتوى وتحديد نقاط الضعف.
    - **Report URI**: خدمة لتتبع تقارير CSP واكتشاف محاولات تنفيذ JavaScript غير مصرح بها.


---
# تحليل ثغرة XSS المخزنة في Yahoo! Mail

## الوصف

ثغرة **XSS المخزنة (Stored XSS)** تم اكتشافها في محرر البريد الإلكتروني لـ Yahoo! Mail في ديسمبر 2015، وتم الإبلاغ عنها بواسطة Jouko Pynnonen. الثغرة كانت ناتجة عن سوء تعقيم المدخلات في علامات HTML، تحديدًا علامة `<img>`، عند إرسال رسائل بريد إلكتروني تحتوي على تعليمات برمجية. على الرغم من أن Yahoo! Mail كانت تزيل السمات الخطرة مثل `onload` و`onerror`، إلا أنها فشلت في معالجة علامات `<img>` المشوهة التي تحتوي على سمات Boolean مع قيم غير متوقعة. هذا سمح بتنفيذ JavaScript ضار عند التفاعل مع البريد الإلكتروني (مثل تحريك الفأرة فوق صورة). تم منح مكافأة قدرها 10,000 دولار للمبلغ عن الثغرة.

## الاستغلال

1. **خطوات الاستغلال**:
    
    - المخترق (Jouko Pynnonen) اكتشف أن محرر Yahoo! Mail يتعامل بشكل غير صحيح مع سمات Boolean في علامات HTML عند تعقيم المدخلات.
    - عند إدخال علامة HTML تحتوي على سمة Boolean مع قيمة (مثل `CHECKED="hello"` في علامة `<input>`)، كان النظام يزيل القيمة ولكنه يترك علامة المساواة (`=`).
    - مثال على ذلك:
        
        ```html
        <INPUT TYPE="checkbox" CHECKED="hello" NAME="check box">
        ```
        
        كان يتحول إلى:
        
        ```html
        <INPUT TYPE="checkbox" CHECKED= NAME="check box">
        ```
        
    - المتصفح كان يفسر هذا على أن `CHECKED` لها قيمة `NAME="check`، ويعتبر `box` سمة منفصلة بدون قيمة.
    - استغل المخترق هذا السلوك في علامة `<img>` بإدخال الحمولة التالية:
        
        ```html
        <img ismap='xxx' itemtype='yyy style=width:100%;height:100%;position:fixed;left:0px;top:0px; onmouseover=alert(/XSS/)//'>
        ```
        
    - بعد معالجة Yahoo! Mail، أصبحت الحمولة:
        
        ```html
        <img ismap= itemtype='yyy' style=width:100%;height:100%;position:fixed;left:0px;top:0px; onmouseover=alert(/XSS/)//>
        ```
        
    - **تفسير الحمولة**:
        - `ismap` هي سمة Boolean تشير إلى أن الصورة تحتوي على مناطق قابلة للنقر.
        - النظام أزال `'xxx'`، لكنه ترك علامة المساواة، مما تسبب في إعادة ترتيب السمات بشكل غير متوقع.
        - سمة `style` جعلت الصورة تغطي نافذة المتصفح بالكامل.
        - سمة `onmouseover` نفّذت JavaScript (`alert(/XSS/)`) عندما يحرك المستخدم الفأرة فوق الصورة.
2. **تأثير الاستغلال**:
    
    - الحمولة أدت إلى عرض نافذة تنبيه للتوضيح، لكن يمكن استبدالها بأكواد ضارة مثل:
        - سرقة ملفات تعريف الارتباط باستخدام `document.cookie`.
        - إعادة توجيه المستخدم إلى موقع ضار باستخدام `window.location`.
        - سرقة محتوى البريد الإلكتروني أو تعديل واجهة المستخدم.
    - الثغرة كانت مخزنة، مما يعني أن أي مستخدم يفتح البريد الإلكتروني الضار (مثل المستلم) سيتأثر.
3. *_لماذا نج_:
    
    - سوء تعقيم المدخلات، حيث كان النظام يعدل المدخلات (مثل إزالة قيم السمات) بدلاً من ترميزها أو الهروب منها (escaping).
    - عدم التحقق من السلوك غير المتوقع لسمات Boolean عند إضافتها بقيم.
    - السماح بتنفيذ سمات JavaScript مثل `onmouseover` بعد إعادة ترتيب السمات بشكل غير صحيح.

## الحلول

1. **تعقيم المدخلات بشكل صحيح**:
    
    - استخدام مكتبات مثل **DOMPurify** لتعقيم المدخلات وإزالة أي سمات أو علامات غير آمنة.
    - تجنب تعديل المدخلات (مثل إزالة القيم فقط) والاعتماد على ترميز الأحرف الخاصة (مثل `<`, `>`, `"`, `'`) إلى كيانات HTML (مثل `<`, `>`, `"`, `'`).
2. **ترميز السياق (Contextual Encoding)**:
    
    - ترميز المدخلات بناءً على السياق (HTML، JavaScript، سمات HTML).
    - مثال: إذا كانت المدخلات ستُعرض في سمة HTML، يجب ترميز `"` إلى `"`.
3. **تطبيق Content Security Policy (CSP)**:
    
    - تطبيق سياسة أمان المحتوى لمنع تنفيذ JavaScript غير موثوق.
    - مثال: `Content-Security-Policy: script-src 'self';` يقيد تنفيذ JavaScript على المصادر من نفس النطاق.
4. **التحقق من جميع السمات**:
    
    - التحقق من أن جميع السمات (بما في ذلك السمات Boolean) تُعالج بشكل صحيح، حتى لو أُضيفت بقيم غير متوقعة.
    - اختبار سلوك النظام عند إدخال سمات غير قياسية أو مشوهة.
5. **استخدام أطر عمل آمنة**:
    
    - استخدام أطر عمل مثل **React** أو **Vue.js** التي ترمّز المدخلات تلقائيًا لمنع ثغرات XSS.
    - تجنب استخدام طرق غير آمنة مثل `innerHTML` أو دمج المدخلات مباشرة في HTML دون تعقيم.
6. **اختبارات الأمان الشاملة**:
    
    - إجراء اختبارات أمان باستخدام أدوات مثل **Burp Suite** أو **OWASP ZAP** لمحاكاة هجمات XSS.
    - تشجيع برامج Bug Bounty لتحديد الثغرات من قبل باحثي الأمان.

## الأدوات

1. **فحص مصدر الصفحة**:
    
    - **Chrome DevTools**: لتحليل كود HTML وتتبع سلوك المدخلات داخل البريد الإلكتروني.
    - **view-source:URL**: لعرض مصدر الصفحة وفحص التغييرات بعد معالجة المدخلات.
2. **أدوات اختبار الأمان**:
    
    - **Burp Suite**: لتحليل طلبات HTTP/HTTPS واكتشاف ثغرات XSS في المدخلات.
    - **OWASP ZAP**: أداة مفتوحة المصدر لاختبار ثغرات XSS وغيرها من نقاط الضعف.
    - **XSStrike**: أداة متخصصة في اختبار حمولات XSS واكتشاف الثغرات.
3. **أدوات تعقيم المدخلات**:
    
    - **DOMPurify**: مكتبة JavaScript لتعقيم المدخلات ومنع ثغرات XSS.
    - **ESAPI (OWASP Enterprise Security API)**: مكتبة لترميز وتعقيم المدخلات في سياقات مختلفة.
4. **أدوات مراقبة CSP**:
    
    - **CSP Evaluator**: أداة لتقييم سياسات أمان المحتوى وتحسين الحماية.
    - **Report URI**: خدمة لتتبع تقارير CSP واكتشاف محاولات تنفيذ JavaScript غير مصرح بها.




---
# تحليل ثغرة XSS المخزنة في Google Tag Manager

## الوصف

ثغرة **XSS المخزنة (Stored XSS)** تم اكتشافها في Google Tag Manager (`tagmanager.google.com`) في أكتوبر 2014 بواسطة Patrik Fehrenbach عبر منصة HackerOne. الثغرة نتجت عن فشل Google في تعقيم المدخلات من ملفات JSON المرفوعة، بينما كانت تعقم المدخلات من حقول النماذج عند الإرسال. Google Tag Manager هو أداة لتحسين محركات البحث تتيح للمسوقين إضافة وتحديث علامات الموقع بسهولة من خلال نماذج ويب أو رفع ملفات JSON. استغل Fehrenbach خاصية رفع الملفات لإدخال حمولة XSS، مما أدى إلى تنفيذ JavaScript ضار. تم منح مكافأة قدرها 5000 دولار للمبلغ عن الثغرة.

## الاستغلال

1. **خطوات الاستغلال**:
    
    - حاول Fehrenbach إدخال حمولة XSS في حقول نماذج الويب في Google Tag Manager، مثل:
        
        ```html
        #"><img src=/ onerror=alert(3)>
        ```
        
    - **تفسير الحمولة**:
        - `#">` أغلق علامة HTML الحالية.
        - `<img src=/ onerror=alert(3)>` أضاف علامة صورة تحتوي على خاصية `onerror` التي تُنفذ JavaScript (`alert(3)`) عند فشل تحميل الصورة.
    - هذه الحمولة لم تنجح لأن Google كانت تعقم مدخلات النماذج عند الإرسال.
    - لاحظ Fehrenbach وجود طريقة بديلة لإدخال البيانات عبر رفع ملف JSON.
    - قام برفع ملف JSON يحتوي على الحمولة التالية:
        
        ```json
        {
          "data": {
            "name": "#\"><img src=/ onerror=alert(3)>",
            "type": "AUTO_EVENT_VAR",
            "autoEventVarMacro": {
              "varType": "HISTORY_NEW_URL_FRAGMENT"
            }
          }
        }
        ```
        
    - Google لم تعقم المدخلات من ملف JSON عند العرض، مما سمح بتنفيذ الحمولة.
    - النتيجة: عند عرض البيانات المرفوعة، تم تنفيذ JavaScript وعرض نافذة تنبيه تحتوي على الرقم 3.
2. **تأثير الاستغلال**:
    
    - الحمولة المستخدمة (`alert(3)`) كانت للتوضيح، لكن يمكن استبدالها بأكواد ضارة مثل:
        - سرقة ملفات تعريف الارتباط باستخدام `document.cookie`.
        - تعديل محتوى الصفحة لخداع المستخدمين.
        - إعادة توجيه المستخدم إلى موقع ضار باستخدام `window.location`.
    - الثغرة كانت مخزنة، مما يعني أن أي مستخدم يتفاعل مع العلامات المُدخلة (مثل المسوقين أو المدراء) قد يتأثر.
3. **لماذا نجح الاستغلال؟**:
    
    - Google كانت تعقم مدخلات النماذج عند الإرسال بدلاً من عند العرض، وهو ما يخالف أفضل الممارسات.
    - خاصية رفع ملفات JSON لم تُخضع لنفس إجراءات التعقيم، مما سمح بحقن حمولة XSS.

## الحلول

1. **تعقيم المدخلات عند العرض**:
    
    - تعقيم جميع المدخلات عند عرضها بدلاً من الإرسال، باستخدام مكتبات مثل **DOMPurify** لإزالة السمات أو العلامات غير الآمنة.
    - ترميز الأحرف الخاصة (مثل `<`, `>`, `"`, `'`) إلى كيانات HTML (مثل `<`, `>`, `"`, `'`).
2. **تطبيق تعقيم موحد لجميع المدخلات**:
    
    - التأكد من أن جميع طرق إدخال البيانات (نماذج ويب، ملفات مرفوعة، واجهات برمجة التطبيقات) تُعقم بنفس الطريقة.
    - إجراء اختبارات شاملة لتحديد أي نقاط إدخال غير محمية.
3. **تطبيق Content Security Policy (CSP)**:
    
    - استخدام سياسة أمان المحتوى لمنع تنفيذ JavaScript غير موثوق.
    - مثال: `Content-Security-Policy: script-src 'self';` يقيد تنفيذ JavaScript على المصادر من نفس النطاق.
4. **التحقق من تنسيقات الملفات المرفوعة**:
    
    - التحقق من صحة ملفات JSON المرفوعة وتعقيم جميع القيم قبل معالجتها أو عرضها.
    - استخدام مكتبات مثل **jsonschema** للتحقق من بنية JSON ومنع إدخال بيانات غير متوقعة.
5. **استخدام أطر عمل آمنة**:
    
    - الاعتماد على أطر عمل مثل **React** أو **Vue.js** التي ترمّز المدخلات تلقائيًا لمنع ثغرات XSS.
    - تجنب استخدام طرق غير آمنة مثل `innerHTML` لعرض البيانات المرفوعة.
6. **اختبارات الأمان الدورية**:
    
    - إجراء اختبارات أمان باستخدام أدوات مثل **Burp Suite** أو **OWASP ZAP** لمحاكاة هجمات XSS.
    - تشجيع برامج Bug Bounty لتحديد الثغرات من قبل باحثي الأمان.

## الأدوات

1. **فحص مصدر الصفحة**:
    
    - **Chrome DevTools**: لتحليل كود HTML وتتبع عرض المدخلات من ملفات JSON.
    - **view-source:URL**: لفحص مصدر الصفحة وتحديد كيفية معالجة البيانات.
2. **أدوات اختبار الأمان**:
    
    - **Burp Suite**: لتحليل طلبات HTTP/HTTPS واكتشاف ثغرات XSS في النماذج أو الملفات المرفوعة.
    - **OWASP ZAP**: أداة مفتوحة المصدر لاختبار ثغرات XSS وغيرها من نقاط الضعف.
    - **XSStrike**: أداة متخصصة في اختبار حمولات XSS واكتشاف الثغرات.
3. **أدوات تعقيم المدخلات**:
    
    - **DOMPurify**: مكتبة JavaScript لتعقيم المدخلات ومنع ثغرات XSS.
    - **ESAPI (OWASP Enterprise Security API)**: مكتبة لترميز وتعقيم المدخلات في سياقات مختلفة.
4. **أدوات التحقق من JSON**:
    
    - **jsonschema**: مكتبة Python أو JavaScript للتحقق من صحة بنية ملفات JSON المرفوعة.
    - **JSONLint**: أداة عبر الإنترنت للتحقق من صحة تنسيق JSON.
5. **أدوات مراقبة CSP**:
    
    - **CSP Evaluator**: أداة لتقييم سياسات أمان المحتوى وتحسين الحماية.
    - **Report URI**: خدمة لتتبع تقارير CSP واكتشاف محاولات تنفيذ JavaScript غير مصرح بها.



# تحليل ثغرة XSS في United Airlines

## الوصف

ثغرة **XSS (Cross-Site Scripting)** تم اكتشافها في موقع تسجيل الدخول الخاص بشركة United Airlines (`checkin.united.com`) في يوليو 2016 بواسطة Mustafa Hasan بالتعاون مع Rodolfo Assis. الثغرة كانت في معلمة `SID` في عنوان URL، حيث كانت القيمة المدخلة تُعرض في صفحة HTML دون تعقيم. على الرغم من وجود مرشح XSS يعطل وظائف JavaScript مثل `alert` و`confirm`، إلا أن المخترقين تمكنا من تجاوزه باستخدام وظيفة `writeln` غير المحظورة وإطار `<iframe>` لتنفيذ JavaScript في سياق الموقع. الثغرة كانت معقدة بسبب الحاجة إلى فهم عميق للكود JavaScript وتجاوز المرشحات. تم الإبلاغ عن الثغرة، لكن قيمة المكافأة لم تُفصح.

## الاستغلال

1. **خطوات الاستغلال**:
    
    - لاحظ Hasan أن زيارة `checkin.united.com` تُعيد توجيهًا إلى عنوان URL يحتوي على معلمة `SID`، وأن القيمة المدخلة في هذه المعلمة تُعرض في صفحة HTML دون تعقيم.
    - اختبر حمولة XSS أولية:
        
        ```html
        "><svg onload=confirm(1)>
        ```
        
        - الهدف: إغلاق علامة HTML الحالية وإضافة علامة `<svg>` لتنفيذ JavaScript عبر حدث `onload`.
        - لكن الحمولة لم تُنفذ بسبب مرشح XSS في JavaScript يعطل وظائف مثل `confirm`.
    - قام Hasan بفحص ملفات JavaScript باستخدام أدوات المطورين في المتصفح، واكتشف كودًا يعطل وظائف مثل `alert`, `confirm`, `prompt`, و`write`، لكنه لم يتضمن `writeln`.
    - حاول استعادة وظيفة `document.write` باستخدام:
        
        ```javascript
        javascript:document.write=HTMLDocument.prototype.write;document.write('STRUKT');
        ```
        
        - الهدف: إعادة تعيين وظيفة `write` إلى تنفيذها الأصلي وكتابة نص "STRUKT" إلى الصفحة.
        - لكن هذا لم ينجح بشكل كامل بسبب استمرار تأثير المرشح.
    - بالتعاون مع Assis، استخدما وظيفة `writeln` (غير محظورة) مع حمولة جديدة:
        
        ```javascript
        ";}{document.writeln(decodeURI(location.hash))-"#<img src=1 onerror=alert(1)>
        ```
        
        - **تفسير الحمولة**:
            - `";}` أغلق كود JavaScript الحالي.
            - `{` بدأ كود JavaScript جديد.
            - `document.writeln(decodeURI(location.hash))` كتب محتوى معلمات URL بعد `#` (fragment) إلى DOM بعد فك تشفيره.
            - `-"` أزال علامة الاقتباس لضمان صحة بنية JavaScript.
            - `#<img src=1 onerror=alert(1)>` أضاف جزءًا (fragment) يحتوي على علامة `<img>` مع حدث `onerror` لتنفيذ `alert(1)`.
        - هذه الحمولة فشلت أيضًا لأن وظيفة `alert` كانت معطلة بواسطة المرشح.
    - الحل النهائي كان استخدام `<iframe>` لتحميل صفحة جديدة بدون المرشح:
        
        ```javascript
        ";}{document.writeln(decodeURI(location.hash))-"#<iframe src=javascript:alert(document.domain)><iframe>
        ```
        
        - **تفسير الحمولة النهائية**:
            - كتبت علامة `<iframe>` إلى DOM مع مصدر `src=javascript:alert(document.domain)`، مما نفّذ JavaScript في سياق جديد.
            - عرض نافذة تنبيه تحتوي على `www.united.com`، مما يثبت الوصول إلى DOM الخاص بـ United.
            - `<iframe>` سمح بتجاوز مرشح XSS لأن JavaScript يُنفذ في سياق منفصل مع وراثة صلاحيات الموقع الأصلي.
2. **تأثير الاستغلال**:
    
    - الحمولة أثبتت إمكانية تنفيذ JavaScript في سياق موقع United، مما يسمح ب:
        - سرقة ملفات تعريف الارتباط باستخدام `document.cookie`.
        - تعديل محتوى الصفحة لخداع المستخدمين.
        - إعادة توجيه المستخدم إلى مواقع ضارة.
    - الثغرة كانت خطيرة لأنها تؤثر على مستخدمين آخرين يزورون الصفحة المحقونة.
3. **لماذا نجح الاستغلال؟**:
    
    - عدم تعقيم قيمة معلمة `SID` عند عرضها في HTML.
    - مرشح XSS لم يحظر وظيفة `writeln`، مما سمح بكتابة محتوى إلى DOM.
    - استخدام `<iframe>` مع بروتوكول `javascript:` سمح بتجاوز المرشح مع الاحتفاظ بصلاحيات الموقع الأصلي.

## الحلول

1. **تعقيم المدخلات عند العرض**:
    
    - تعقيم جميع معلمات URL (مثل `SID`) باستخدام مكتبات مثل **DOMPurify** لإزالة السمات أو العلامات غير الآمنة.
    - ترميز الأحرف الخاصة (مثل `<`, `>`, `"`, `'`) إلى كيانات HTML (مثل `<`, `>`, `"`, `'`).
2. **توسيع مرشحات XSS**:
    
    - حظر جميع وظائف JavaScript التي يمكن أن تُستخدم لكتابة محتوى إلى DOM، مثل `writeln` و`write`.
    - استخدام قوائم بيضاء (whitelists) بدلاً من قوائم سوداء (blacklists) للسماح فقط بالوظائف الآمنة.
3. **تطبيق Content Security Policy (CSP)**:
    
    - تطبيق سياسة أمان المحتوى لمنع تنفيذ JavaScript غير موثوق.
    - مثال: `Content-Security-Policy: script-src 'self';` يقيد تنفيذ JavaScript على المصادر من نفس النطاق.
4. **منع استخدام بروتوكول `javascript:`**:
    
    - حظر استخدام بروتوكول `javascript:` في سمات مثل `src` لعلامات `<iframe>` أو `<a>`.
    - التحقق من قيم السمات للتأكد من أنها تشير إلى مصادر شرعية (مثل HTTP/HTTPS).
5. **اختبارات الأمان الشاملة**:
    
    - إجراء اختبارات أمان باستخدام أدوات مثل **Burp Suite** أو **OWASP ZAP** لمحاكاة هجمات XSS.
    - فحص جميع معلمات URL وجزء الـ fragment (`#`) للتأكد من تعقيمها.
    - تشجيع برامج Bug Bounty لتحديد الثغرات.
6. **استخدام أطر عمل آمنة**:
    
    - الاعتماد على أطر عمل مثل **React** أو **Vue.js** التي ترمّز المدخلات تلقائيًا.
    - تجنب عرض المدخلات مباشرة في HTML باستخدام طرق غير آمنة مثل `innerHTML`.

## الأدوات

1. **فحص مصدر الصفحة**:
    
    - **Chrome DevTools**: لتحليل كود HTML وJavaScript وتتبع سلوك معلمات URL.
    - **view-source:URL**: لفحص مصدر الصفحة وتحديد كيفية عرض المدخلات.
2. **أدوات اختبار الأمان**:
    
    - **Burp Suite**: لتحليل طلبات HTTP/HTTPS واختبار معلمات URL مثل `SID`.
    - **OWASP ZAP**: أداة مفتوحة المصدر لاختبار ثغرات XSS وغيرها.
    - **XSStrike**: أداة متخصصة في اختبار حمولات XSS واكتشاف نقاط الضعف.
3. **أدوات تعقيم المدخلات**:
    
    - **DOMPurify**: مكتبة JavaScript لتعقيم المدخلات ومنع ثغرات XSS.
    - **ESAPI (OWASP Enterprise Security API)**: مكتبة لترميز وتعقيم المدخلات في سياقات مختلفة.
4. **أدوات مراقبة CSP**:
    
    - **CSP Evaluator**: أداة لتقييم سياسات أمان المحتوى وتحسين الحماية.
    - **Report URI**: خدمة لتتبع تقارير CSP واكتشاف محاولات تنفيذ JavaScript غير مصرح بها.

---
# تحليل ثغرة XSS في United Airlines

## الوصف

ثغرة **XSS (Cross-Site Scripting)** تم اكتشافها في موقع تسجيل الدخول الخاص بشركة United Airlines (`checkin.united.com`) في يوليو 2016 بواسطة Mustafa Hasan بالتعاون مع Rodolfo Assis. الثغرة كانت في معلمة `SID` في عنوان URL، حيث كانت القيمة المدخلة تُعرض في صفحة HTML دون تعقيم. على الرغم من وجود مرشح XSS يعطل وظائف JavaScript مثل `alert` و`confirm`، إلا أن المخترقين تمكنا من تجاوزه باستخدام وظيفة `writeln` غير المحظورة وإطار `<iframe>` لتنفيذ JavaScript في سياق الموقع. الثغرة كانت معقدة بسبب الحاجة إلى فهم عميق للكود JavaScript وتجاوز المرشحات. تم الإبلاغ عن الثغرة، لكن قيمة المكافأة لم تُفصح.

## الاستغلال

1. **خطوات الاستغلال**:
    
    - لاحظ Hasan أن زيارة `checkin.united.com` تُعيد توجيهًا إلى عنوان URL يحتوي على معلمة `SID`، وأن القيمة المدخلة في هذه المعلمة تُعرض في صفحة HTML دون تعقيم.
    - اختبر حمولة XSS أولية:
        
        ```html
        "><svg onload=confirm(1)>
        ```
        
        - الهدف: إغلاق علامة HTML الحالية وإضافة علامة `<svg>` لتنفيذ JavaScript عبر حدث `onload`.
        - لكن الحمولة لم تُنفذ بسبب مرشح XSS في JavaScript يعطل وظائف مثل `confirm`.
    - قام Hasan بفحص ملفات JavaScript باستخدام أدوات المطورين في المتصفح، واكتشف كودًا يعطل وظائف مثل `alert`, `confirm`, `prompt`, و`write`، لكنه لم يتضمن `writeln`.
    - حاول استعادة وظيفة `document.write` باستخدام:
        
        ```javascript
        javascript:document.write=HTMLDocument.prototype.write;document.write('STRUKT');
        ```
        
        - الهدف: إعادة تعيين وظيفة `write` إلى تنفيذها الأصلي وكتابة نص "STRUKT" إلى الصفحة.
        - لكن هذا لم ينجح بشكل كامل بسبب استمرار تأثير المرشح.
    - بالتعاون مع Assis، استخدما وظيفة `writeln` (غير محظورة) مع حمولة جديدة:
        
        ```javascript
        ";}{document.writeln(decodeURI(location.hash))-"#<img src=1 onerror=alert(1)>
        ```
        
        - **تفسير الحمولة**:
            - `";}` أغلق كود JavaScript الحالي.
            - `{` بدأ كود JavaScript جديد.
            - `document.writeln(decodeURI(location.hash))` كتب محتوى معلمات URL بعد `#` (fragment) إلى DOM بعد فك تشفيره.
            - `-"` أزال علامة الاقتباس لضمان صحة بنية JavaScript.
            - `#<img src=1 onerror=alert(1)>` أضاف جزءًا (fragment) يحتوي على علامة `<img>` مع حدث `onerror` لتنفيذ `alert(1)`.
        - هذه الحمولة فشلت أيضًا لأن وظيفة `alert` كانت معطلة بواسطة المرشح.
    - الحل النهائي كان استخدام `<iframe>` لتحميل صفحة جديدة بدون المرشح:
        
        ```javascript
        ";}{document.writeln(decodeURI(location.hash))-"#<iframe src=javascript:alert(document.domain)><iframe>
        ```
        
        - **تفسير الحمولة النهائية**:
            - كتبت علامة `<iframe>` إلى DOM مع مصدر `src=javascript:alert(document.domain)`، مما نفّذ JavaScript في سياق جديد.
            - عرض نافذة تنبيه تحتوي على `www.united.com`، مما يثبت الوصول إلى DOM الخاص بـ United.
            - `<iframe>` سمح بتجاوز مرشح XSS لأن JavaScript يُنفذ في سياق منفصل مع وراثة صلاحيات الموقع الأصلي.
2. **تأثير الاستغلال**:
    
    - الحمولة أثبتت إمكانية تنفيذ JavaScript في سياق موقع United، مما يسمح ب:
        - سرقة ملفات تعريف الارتباط باستخدام `document.cookie`.
        - تعديل محتوى الصفحة لخداع المستخدمين.
        - إعادة توجيه المستخدم إلى مواقع ضارة.
    - الثغرة كانت خطيرة لأنها تؤثر على مستخدمين آخرين يزورون الصفحة المحقونة.
3. **لماذا نجح الاستغلال؟**:
    
    - عدم تعقيم قيمة معلمة `SID` عند عرضها في HTML.
    - مرشح XSS لم يحظر وظيفة `writeln`، مما سمح بكتابة محتوى إلى DOM.
    - استخدام `<iframe>` مع بروتوكول `javascript:` سمح بتجاوز المرشح مع الاحتفاظ بصلاحيات الموقع الأصلي.

## الحلول

1. **تعقيم المدخلات عند العرض**:
    
    - تعقيم جميع معلمات URL (مثل `SID`) باستخدام مكتبات مثل **DOMPurify** لإزالة السمات أو العلامات غير الآمنة.
    - ترميز الأحرف الخاصة (مثل `<`, `>`, `"`, `'`) إلى كيانات HTML (مثل `<`, `>`, `"`, `'`).
2. **توسيع مرشحات XSS**:
    
    - حظر جميع وظائف JavaScript التي يمكن أن تُستخدم لكتابة محتوى إلى DOM، مثل `writeln` و`write`.
    - استخدام قوائم بيضاء (whitelists) بدلاً من قوائم سوداء (blacklists) للسماح فقط بالوظائف الآمنة.
3. **تطبيق Content Security Policy (CSP)**:
    
    - تطبيق سياسة أمان المحتوى لمنع تنفيذ JavaScript غير موثوق.
    - مثال: `Content-Security-Policy: script-src 'self';` يقيد تنفيذ JavaScript على المصادر من نفس النطاق.
4. **منع استخدام بروتوكول `javascript:`**:
    
    - حظر استخدام بروتوكول `javascript:` في سمات مثل `src` لعلامات `<iframe>` أو `<a>`.
    - التحقق من قيم السمات للتأكد من أنها تشير إلى مصادر شرعية (مثل HTTP/HTTPS).
5. **اختبارات الأمان الشاملة**:
    
    - إجراء اختبارات أمان باستخدام أدوات مثل **Burp Suite** أو **OWASP ZAP** لمحاكاة هجمات XSS.
    - فحص جميع معلمات URL وجزء الـ fragment (`#`) للتأكد من تعقيمها.
    - تشجيع برامج Bug Bounty لتحديد الثغرات.
6. **استخدام أطر عمل آمنة**:
    
    - الاعتماد على أطر عمل مثل **React** أو **Vue.js** التي ترمّز المدخلات تلقائيًا.
    - تجنب عرض المدخلات مباشرة في HTML باستخدام طرق غير آمنة مثل `innerHTML`.

## الأدوات

1. **فحص مصدر الصفحة**:
    
    - **Chrome DevTools**: لتحليل كود HTML وJavaScript وتتبع سلوك معلمات URL.
    - **view-source:URL**: لفحص مصدر الصفحة وتحديد كيفية عرض المدخلات.
2. **أدوات اختبار الأمان**:
    
    - **Burp Suite**: لتحليل طلبات HTTP/HTTPS واختبار معلمات URL مثل `SID`.
    - **OWASP ZAP**: أداة مفتوحة المصدر لاختبار ثغرات XSS وغيرها.
    - **XSStrike**: أداة متخصصة في اختبار حمولات XSS واكتشاف نقاط الضعف.
3. **أدوات تعقيم المدخلات**:
    
    - **DOMPurify**: مكتبة JavaScript لتعقيم المدخلات ومنع ثغرات XSS.
    - **ESAPI (OWASP Enterprise Security API)**: مكتبة لترميز وتعقيم المدخلات في سياقات مختلفة.
4. **أدوات مراقبة CSP**:
    
    - **CSP Evaluator**: أداة لتقييم سياسات أمان المحتوى وتحسين الحماية.
    - **Report URI**: خدمة لتتبع تقارير CSP واكتشاف محاولات تنفيذ JavaScript غير مصرح بها.