Insecure Direct Object Reference (IDOR) هي ثغرة أمنية تحدث لما تطبيق ويب يعرض مرجع مباشر لكائن داخلي (زي ID أو اسم ملف) من غير ما يتحقق بشكل صحيح إذا كان المستخدم ليه صلاحية الوصول للكائن ده. المهاجم ممكن يستغل الثغرة دي عن طريق التلاعب بالمعاملات (parameters) في الطلبات للوصول لموارد مش من حقه يشوفها أو يعدلها.

### فهم السياق
الـ IDOR بتحصل عادةً في التطبيقات اللي بتعتمد على معرفات (IDs) أو قيم أخرى (زي أرقام الحسابات، أسماء الملفات، إلخ) في طلبات الـ HTTP (زي GET أو POST) من غير التحقق من صلاحيات المستخدم. مثلاً، لو موقع بيستخدم رابط زي `https://example.com/user?id=123` وما عندوش تحقق صلاحيات كافي، المهاجم ممكن يغير الـ `id=123` لـ `id=124` ويشوف بيانات مستخدم تاني.

### أنواع المحاولات اللي ممكن تستخدمها لاستغلال IDOR
#### 1. **تعديل المعرفات (ID Manipulation):**
   - غيّر قيمة المعرف (ID) في الرابط (URL) أو في جسم الطلب (request body). مثلاً:
     - لو الرابط: `https://example.com/account?id=100`, جرب غيّره لـ `id=101` أو `id=99`.
     - لو الـ ID في طلب POST، عدّل الـ JSON أو form data، زي: `{"user_id": 100}` إلى `{"user_id": 101}`.
   - جرب قيم متسلسلة (sequential IDs) زي `1, 2, 3, ...` أو قيم عشوائية إذا كانت الـ IDs مش متسلسلة.

##### الشرح العملي  (ID) في الرابط (URL)  :

![2025-06-30 03-48-37.mkv](attachments/2025-06-30 03-48-37.mkv)


##### الشرح العملي  (ID) في الرابط (request body) (JSON) :
![Video/Broken access/2025-06-30 03-10-35.mkv](attachments/Video/Broken access/2025-06-30 03-10-35.mkv)


#### 3. **تجربة أنواع مختلفة من المعرفات:**
   - لو الـ ID عبارة عن أرقام، جرب قيم سلبية (`-1`)، صفر (`0`)، أو أرقام كبيرة جدًا (`999999`).
   - لو الـ ID هو UUID (معرف فريد عالميًا)، جرب UUIDs مختلفة أو استخدم أدوات زي Burp Suite عشان تجمع UUIDs من استجابات سابقة.
   - لو المعرف هو اسم ملف أو مسار (path)، جرب تغييره لملفات أخرى، زي: `file=profile.jpg` إلى `file=admin.pdf`.


##### الشرح العملي  لو المعرف هو اسم ملف  : 


![2025-06-30 04-43-30.mkv](attachments/2025-06-30 04-43-30.mkv)

#### 3. **الوصول لموارد غير متوقعة:**
   - جرب الوصول لكائنات أو موارد مختلفة عن طريق تغيير نوع المورد. مثلاً:
     - لو الرابط بيوصل لملفات المستخدم (`/download?file=user1.doc`), جرب الوصول لملفات النظام (`/download?file=/etc/passwd`).
     - لو التطبيق بيسمح بتعديل بيانات زي `user_id=123`, جرب الوصول لجداول أخرى زي `order_id=456` أو `invoice_id=789`.

#### 4. **التلاعب بالطلبات (Request Tampering):**
   - استخدم أدوات زي Burp Suite أو Postman عشان تعترض وتعدّل طلبات الـ HTTP.
   - لو التطبيق بيستخدم طلبات POST، عدّل البيانات في جسم الطلب (body) لتشمل معرفات مختلفة.
   - جرب إضافة معاملات إضافية (parameters) في الرابط أو الطلب، زي: `?id=123&admin=true`.

#### 5. **اختبار الصلاحيات عبر الحسابات:**
   - لو عندك أكتر من حساب (مثلاً، حساب عادي وحساب أدمن)، جرب نفذ نفس الطلب من الحساب العادي بعد ما تشوف إزاي الأدمن بيوصل للموارد.
   - جرب استخدام حساب بصلاحيات منخفضة للوصول لموارد خاصة بحسابات بصلاحيات أعلى.

#### 6. **استغلال الـ API Endpoints:**
   - لو التطبيق بيستخدم APIs (زي REST أو GraphQL)، جرب تعديل المعرفات في الـ endpoints. مثلاً:
     - REST: غيّر `/api/users/123` إلى `/api/users/124`.
     - GraphQL: عدّل الـ queries أو mutations لتشمل معرفات مختلفة.
   - استخدم أدوات زي GraphQL Voyager أو Insomnia لاستكشاف الـ API schema وابحث عن معرفات يمكن استغلالها.

#### 7. **التلاعب بالمسارات (Path Traversal):**
   - لو الـ IDOR بيحصل في سياق ملفات أو مسارات، جرب تقنيات Path Traversal زي `../../etc/passwd` للوصول لملفات خارج النطاق المسموح.
   - مثلاً: لو الرابط هو `/download?file=user1.txt`, جرب `/download?file=../../config.ini`.

#### 8. **اختبار التسلسل (Sequential Enumeration):**
   - لو المعرفات متسلسلة، استخدم سكربتات (زي Python مع مكتبة `requests`) عشان تجرب أرقام ID بشكل تلقائي وتشوف إيه الموارد اللي بتقدر توصلها.
   - مثلاً، كود بسيط:
     ```python
     import requests
     for i in range(1, 100):
         url = f"https://example.com/api/user?id={i}"
         response = requests.get(url)
         if response.status_code == 200:
             print(f"Access granted for ID {i}: {response.text}")
     ```

#### 9. **اختبار الاستجابات (Response Analysis):**
   - حلّل استجابات الخادم (server responses) لمعرفة إذا كان فيه بيانات حساسة زي أسماء المستخدمين، عناوين البريد، أو بيانات مالية.
   - حتى لو الطلب مرجعش بيانات مباشرة، ممكن الاستجابة تكشف عن معلومات (metadata) زي حجم الملف أو نوعه.

10. **تجربة إجراءات حساسة (Sensitive Actions):**
    - جرب تعديل المعرفات في عمليات حساسة زي:
      - حذف حساب: `/delete?user_id=123` → `/delete?user_id=124`.
      - تعديل بيانات: `/update?profile_id=123` → `/update?profile_id=124`.
      - عرض فواتير: `/invoice?id=1000` → `/invoice?id=1001`.

11. **اختبار السياقات المختلفة:**
    - جرب الثغرة في سياقات مختلفة زي:
      - الوصول لبيانات المستخدم (profiles, settings).
      - الوصول لمعاملات مالية (invoices, payments).
      - الوصول لمحتوى إداري (admin panels, reports).
    - لو التطبيق بيستخدم cookies أو session tokens، جرب الجمع بين IDOR وثغرات تانية زي Session Hijacking.

### أدوات مفيدة
- **Burp Suite**: لاعتراض وتعديل الطلبات.
- **Postman**: لاختبار APIs يدويًا.
- **Python/Requests**: لتطوير سكربتات تلقائية لتجربة معرفات متعددة.
- **OWASP ZAP**: لفحص الثغرات تلقائيًا.
- **Browser DevTools**: لتحليل الطلبات والاستجابات مباشرة.

### نصايح للاختبار بأمان
- **اختبار قانوني**: اختبر بس على أنظمة عندك إذن باختبارها (مثل برامج Bug Bounty أو بيئات اختبار).
- **تجنب الضرر**: ما تحاولش تعدل أو تحذف بيانات حقيقية من غير إذن.
- **توثيق النتايج**: سجّل كل محاولاتك والنتايج عشان تقدر تشرح الثغرة بوضوح لو كنت بتقدم تقرير.

### مثال عملي
لو موقع بيستخدم رابط زي `https://example.com/view?doc=12345`، جرب:
1. غيّر الـ `doc=12345` إلى `doc=12346` وشوف لو بيظهر مستند مش من حقك.
2. لو الموقع بيستخدم POST مع JSON زي `{"doc_id": 12345}`، عدّل الـ `doc_id` في الطلب.
3. لو الموقع بيسمح بتحميل ملفات، جرب مسارات زي `doc=../../secret.txt`.

### ملاحظات
- الـ IDOR بتكون خطيرة جدًا لو التطبيق ما عندوش تحقق صلاحيات (authorization checks) على مستوى الخادم.
- دايمًا ركز على الـ server-side validation لأن التحقق على مستوى العميل (client-side) ممكن يتجاوزه المهاجم بسهولة.

لو عايز تفاصيل أكتر عن أي نقطة أو مثال معين، قولي!